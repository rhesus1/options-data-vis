<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Options Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 20px;
            width: 80%;
            margin: 20px auto;
        }
        .chart-container { width: 100%; margin: 0; }
        select, input { margin: 10px; }
        .stats-table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        .stats-table th, .stats-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .stats-table th { background-color: #f2f2f2; }
        .line-swatch { display: inline-block; vertical-align: middle; margin-right: 5px; }
    </style>
</head>
<body>
    <h1>Options Data Visualisation</h1>
    <div>
        <label for="date-select">Select Date/Time: </label>
        <select id="date-select"></select>
    </div>
    <div>
        <label for="ticker-select">Select Ticker: </label>
        <select id="ticker-select"></select>
    </div>
    <div class="grid-container">
        <div class="chart-container">
            <h2>Moneyness vs. Volatility</h2>
            <select id="expiry-select"></select>
            <canvas id="moneyness-vs-iv-chart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Expiry vs. Volatility</h2>
            <select id="moneyness-select"></select>
            <canvas id="expiry-vs-iv-chart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Historic Stock Price with 90-day Realised Volatility</h2>
            <canvas id="historic-price-chart"></canvas>
        </div>
    </div>
    <script>
        let data = [];
        let historicData = [];
        let expiryChart, moneynessChart, historicChart;
   
        document.addEventListener('DOMContentLoaded', () => {
            fetch('data/dates.json?v=' + Date.now())
                .then(response => response.json())
                .then(dates => {
                    const dateSelect = document.getElementById('date-select');
                    dates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$1-$2-$3 $4:$5');
                        dateSelect.appendChild(option);
                    });
                    loadData(dates[0]); // Load latest by default
                })
                .catch(error => console.error('Error loading dates:', error));
            const dateSelect = document.getElementById('date-select');
            dateSelect.addEventListener('change', (e) => {
                loadData(e.target.value);
            });
        });
        function loadData(timestamp) {
            Promise.all([
                fetch(`data/processed_${timestamp}.json?v=` + Date.now()).then(response => response.json()),
                fetch(`data/historic_${timestamp}.json?v=` + Date.now()).then(response => response.json())
            ]).then(([jsonData, historicJson]) => {
                data = jsonData;
                historicData = historicJson;
                populateDropdowns();
                updateCharts();
            }).catch(error => console.error('Error loading data:', error));
        }
        function populateDropdowns() {
            const uniqueTickers = [...new Set(data.map(item => item.Ticker))]
                .filter(val => val).sort();
            const tickerSelect = document.getElementById('ticker-select');
            tickerSelect.innerHTML = ''; // Clear previous
            uniqueTickers.forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.text = val;
                tickerSelect.add(option);
            });
            tickerSelect.addEventListener('change', () => {
                updateDropdowns();
                updateCharts();
            });
            updateDropdowns();
            document.getElementById('moneyness-select').addEventListener('change', updateCharts);
            document.getElementById('expiry-select').addEventListener('change', updateCharts);
        }
        function updateDropdowns() {
            const selectedTicker = document.getElementById('ticker-select').value;
            const tickerData = data.filter(item => item.Ticker === selectedTicker);
            const uniqueMoneyness = [...new Set(tickerData.map(item => item.Moneyness))]
                .filter(val => !isNaN(val)).sort((a, b) => a - b);
            const moneynessSelect = document.getElementById('moneyness-select');
            moneynessSelect.innerHTML = ''; // Clear previous options
            uniqueMoneyness.forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.text = `${val.toFixed(2)}%`;
                moneynessSelect.add(option);
            });
            const uniqueExpiries = [...new Set(tickerData.map(item => item.Expiry))]
                .filter(val => val).sort((a, b) => new Date(a) - new Date(b));
            const expirySelect = document.getElementById('expiry-select');
            expirySelect.innerHTML = ''; // Clear previous options
            uniqueExpiries.forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.text = new Date(val).toLocaleDateString('en-GB');
                expirySelect.add(option);
            });
        }
        function updateCharts() {
            updateExpiryVsIV();
            updateMoneynessVsIV();
            updateHistoricChart();
        }
        function getRawDataPoints(data, xKey, yKey) {
            return data.map(item => {
                const xValue = xKey === 'Expiry' ? new Date(item[xKey]) : parseFloat(item[xKey]);
                const yValue = item[yKey];
                if (!isNaN(xValue) && !isNaN(yValue) && yValue !== null) {
                    return { x: xValue, y: yValue };
                }
            }).filter(point => point !== undefined).sort((a, b) => a.x - b.x);
        }
        function createStatsTable(chart, canvasId) {
            const container = document.getElementById(canvasId).parentNode;
            let existingTable = container.querySelector('.stats-table');
            if (existingTable) existingTable.remove();
            const table = document.createElement('table');
            table.className = 'stats-table';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['Label', 'Min', 'Max', 'Mean'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            chart.data.datasets.forEach(dataset => {
                if (dataset.data.length === 0) return;
                const ys = dataset.data.map(point => point.y).filter(y => !isNaN(y));
                if (ys.length === 0) return;
                const min = Math.min(...ys);
                const max = Math.max(...ys);
                const sum = ys.reduce((a, b) => a + b, 0);
                const mean = sum / ys.length;
                const row = document.createElement('tr');
                const labelTd = document.createElement('td');
                const swatch = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                swatch.setAttribute('width', '20');
                swatch.setAttribute('height', '10');
                swatch.setAttribute('class', 'line-swatch');
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', '0');
                line.setAttribute('y1', '5');
                line.setAttribute('x2', '20');
                line.setAttribute('y2', '5');
                line.setAttribute('stroke', dataset.borderColor);
                line.setAttribute('stroke-width', '2');
                if (dataset.borderDash && dataset.borderDash.length > 0) {
                    line.setAttribute('stroke-dasharray', dataset.borderDash.join(' '));
                }
                swatch.appendChild(line);
                labelTd.appendChild(swatch);
                const labelText = document.createTextNode(` ${dataset.label}`);
                labelTd.appendChild(labelText);
                row.appendChild(labelTd);
                const minTd = document.createElement('td');
                minTd.textContent = min.toFixed(2);
                row.appendChild(minTd);
                const maxTd = document.createElement('td');
                maxTd.textContent = max.toFixed(2);
                row.appendChild(maxTd);
                const meanTd = document.createElement('td');
                meanTd.textContent = mean.toFixed(2);
                row.appendChild(meanTd);
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            container.appendChild(table);
        }
        function updateExpiryVsIV() {
            const selectedTicker = document.getElementById('ticker-select').value;
            const selectedMoneyness = parseFloat(document.getElementById('moneyness-select').value);
            const filteredData = data.filter(item => item.Ticker === selectedTicker && item.Moneyness === selectedMoneyness);
            const datasets = [
                {
                    label: 'Calls Implied Volatility',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Call'),
                        'Expiry',
                        'Implied Volatility'
                    ),
                    borderColor: 'teal',
                    backgroundColor: 'teal',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y'
                },
                {
                    label: 'Puts Implied Volatility',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Put'),
                        'Expiry',
                        'Implied Volatility'
                    ),
                    borderColor: 'teal',
                    backgroundColor: 'teal',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [5, 5],
                    yAxisID: 'y'
                },
                {
                    label: 'Calls IV_bid-ask',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Call'),
                        'Expiry',
                        'IV_bid-ask'
                    ),
                    borderColor: 'lightcoral',
                    backgroundColor: 'lightcoral',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y'
                },
                {
                    label: 'Puts IV_bid-ask',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Put'),
                        'Expiry',
                        'IV_bid-ask'
                    ),
                    borderColor: 'lightcoral',
                    backgroundColor: 'lightcoral',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [5, 5],
                    yAxisID: 'y'
                },
                {
                    label: 'Calls Heston IV',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Call' && item['Heston IV'] > 0),
                        'Expiry',
                        'Heston IV'
                    ),
                    borderColor: 'plum',
                    backgroundColor: 'plum',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y'
                },
                {
                    label: 'Puts Heston IV',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Put' && item['Heston IV'] > 0),
                        'Expiry',
                        'Heston IV'
                    ),
                    borderColor: 'plum',
                    backgroundColor: 'plum',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [5, 5],
                    yAxisID: 'y'
                },
                {
                    label: 'Local Vol',
                    data: getRawDataPoints(
                        filteredData,
                        'Expiry',
                        'Local Vol'
                    ),
                    borderColor: 'lightgreen',
                    backgroundColor: 'lightgreen',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y'
                },
                {
                    label: 'Realised Vol 90d',
                    data: getRawDataPoints(
                        filteredData,
                        'Expiry',
                        'Realised Vol 90d'
                    ),
                    borderColor: 'lightsalmon',
                    backgroundColor: 'lightsalmon',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y'
                },
                {
                    label: 'Calls Last Option Price',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Call'),
                        'Expiry',
                        'Last Option Price'
                    ),
                    borderColor: 'lavender',
                    backgroundColor: 'lavender',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y1'
                },
                {
                    label: 'Puts Last Option Price',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Put'),
                        'Expiry',
                        'Last Option Price'
                    ),
                    borderColor: 'lavender',
                    backgroundColor: 'lavender',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [5, 5],
                    yAxisID: 'y1'
                }
            ];
            if (expiryChart) expiryChart.destroy();
            expiryChart = new Chart(document.getElementById('expiry-vs-iv-chart').getContext('2d'), {
                type: 'line',
                data: { datasets },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            title: { display: true, text: 'Expiry Date' }
                        },
                        y: {
                            title: { display: true, text: 'Volatility (%)' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Last Option Price ($)' },
                            beginAtZero: true
                        }
                    }
                }
            });
            createStatsTable(expiryChart, 'expiry-vs-iv-chart');
        }
        function updateMoneynessVsIV() {
            const selectedTicker = document.getElementById('ticker-select').value;
            const selectedExpiry = document.getElementById('expiry-select').value;
            const filteredData = data.filter(item => item.Ticker === selectedTicker && item.Expiry === selectedExpiry);
            const datasets = [
                {
                    label: 'Calls Implied Volatility',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Call'),
                        'Moneyness',
                        'Implied Volatility'
                    ),
                    borderColor: 'teal',
                    backgroundColor: 'teal',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y'
                },
                {
                    label: 'Puts Implied Volatility',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Put'),
                        'Moneyness',
                        'Implied Volatility'
                    ),
                    borderColor: 'teal',
                    backgroundColor: 'teal',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [5, 5],
                    yAxisID: 'y'
                },
                {
                    label: 'Calls IV_bid-ask',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Call'),
                        'Moneyness',
                        'IV_bid-ask'
                    ),
                    borderColor: 'lightcoral',
                    backgroundColor: 'lightcoral',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y'
                },
                {
                    label: 'Puts IV_bid-ask',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Put'),
                        'Moneyness',
                        'IV_bid-ask'
                    ),
                    borderColor: 'lightcoral',
                    backgroundColor: 'lightcoral',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [5, 5],
                    yAxisID: 'y'
                },
                {
                    label: 'Calls Heston IV',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Call' && item['Heston IV'] > 0),
                        'Moneyness',
                        'Heston IV'
                    ),
                    borderColor: 'plum',
                    backgroundColor: 'plum',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y'
                },
                {
                    label: 'Puts Heston IV',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Put' && item['Heston IV'] > 0),
                        'Moneyness',
                        'Heston IV'
                    ),
                    borderColor: 'plum',
                    backgroundColor: 'plum',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [5, 5],
                    yAxisID: 'y'
                },
                {
                    label: 'Local Vol',
                    data: getRawDataPoints(
                        filteredData,
                        'Moneyness',
                        'Local Vol'
                    ),
                    borderColor: 'lightgreen',
                    backgroundColor: 'lightgreen',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y'
                },
                {
                    label: 'Realised Vol 90d',
                    data: getRawDataPoints(
                        filteredData,
                        'Moneyness',
                        'Realised Vol 90d'
                    ),
                    borderColor: 'lightsalmon',
                    backgroundColor: 'lightsalmon',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y'
                },
                {
                    label: 'Calls Last Option Price',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Call'),
                        'Moneyness',
                        'Last Option Price'
                    ),
                    borderColor: 'lavender',
                    backgroundColor: 'lavender',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [],
                    yAxisID: 'y1'
                },
                {
                    label: 'Puts Last Option Price',
                    data: getRawDataPoints(
                        filteredData.filter(item => item.Type === 'Put'),
                        'Moneyness',
                        'Last Option Price'
                    ),
                    borderColor: 'lavender',
                    backgroundColor: 'lavender',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    borderDash: [5, 5],
                    yAxisID: 'y1'
                }
            ];
            if (moneynessChart) moneynessChart.destroy();
            moneynessChart = new Chart(document.getElementById('moneyness-vs-iv-chart').getContext('2d'), {
                type: 'line',
                data: { datasets },
                options: {
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Moneyness (%)' }
                        },
                        y: {
                            title: { display: true, text: 'Volatility (%)' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Last Option Price ($)' },
                            beginAtZero: true
                        }
                    }
                }
            });
            createStatsTable(moneynessChart, 'moneyness-vs-iv-chart');
        }
        function updateHistoricChart() {
            const selectedTicker = document.getElementById('ticker-select').value;
            let filteredHistoric = historicData.filter(item => item.Ticker === selectedTicker);
            filteredHistoric.sort((a, b) => new Date(a.Date) - new Date(b.Date));
            const dates = filteredHistoric.map(item => new Date(item.Date));
            const prices = filteredHistoric.map(item => item.Close);
            const vols = filteredHistoric.map(item => item.Realized_Vol);
            const datasets = [
                {
                    label: 'Stock Price',
                    data: prices.map((p, i) => ({ x: dates[i], y: p })),
                    borderColor: 'lightblue',
                    backgroundColor: 'lightblue',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    yAxisID: 'y'
                },
                {
                    label: '90-day Realized Vol (%)',
                    data: vols.map((v, i) => ({ x: dates[i], y: v })),
                    borderColor: 'lightcoral',
                    backgroundColor: 'lightcoral',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    yAxisID: 'y1'
                }
            ];
            if (historicChart) historicChart.destroy();
            historicChart = new Chart(document.getElementById('historic-price-chart').getContext('2d'), {
                type: 'line',
                data: { datasets },
                options: {
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month' },
                            title: { display: true, text: 'Date' }
                        },
                        y: {
                            title: { display: true, text: 'Stock Price ($)' },
                            beginAtZero: false
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Realized Volatility (%)' },
                            beginAtZero: false
                        }
                    }
                }
            });
            createStatsTable(historicChart, 'historic-price-chart');
        }
    </script>
</body>
</html>
