name: Scrape Trading Economics Data
on:
  workflow_dispatch: # Manual trigger with timestamp input
    inputs:
      timestamp:
        description: 'Timestamp for the data scrape (format: YYYYMMDD_HHMM)'
        required: true
        default: '20250912_2126'

jobs:
  scrape-trading-economics:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium beautifulsoup4 webdriver-manager
      continue-on-error: false
    - name: Create data directory
      run: mkdir -p data/${{ github.event.inputs.timestamp }}/Trading_Economics
    - name: Run Trading Economics scrape script
      run: |
        python -c "
        import os
        import glob
        import shutil
        timestamp = '${{ github.event.inputs.timestamp }}'
        print(f'Running scrape_trading_economics.py with timestamp: {timestamp}')
        os.makedirs(f'data/{timestamp}/Trading_Economics', exist_ok=True)
        rc = os.system('python scrape_trading_economics.py')
        if rc != 0:
            print('Warning: scrape_trading_economics.py may have encountered issues')
        # Move CSVs to timestamped Trading_Economics directory
        csv_files = glob.glob('*.csv')
        if csv_files:
            for csv_file in csv_files:
                shutil.move(csv_file, f'data/{timestamp}/Trading_Economics/{csv_file}')
            print(f'Moved {len(csv_files)} CSVs to data/{timestamp}/Trading_Economics/')
        else:
            print('No CSVs to move')
        # Move page source files for debugging
        html_files = glob.glob('*.html')
        if html_files:
            for html_file in html_files:
                shutil.move(html_file, f'data/{timestamp}/Trading_Economics/{html_file}')
            print(f'Moved {len(html_files)} HTML page source files to data/{timestamp}/Trading_Economics/')
        else:
            print('No HTML page source files to move')
        "
      continue-on-error: true
    - name: Commit and push Trading Economics data
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add data
        git commit -m "Auto-update Trading Economics data for ${{ github.event.inputs.timestamp }}" || echo "No changes to commit"
        git push
    - name: Send email with Trading Economics data
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Trading Economics Data for ${{ github.event.inputs.timestamp }}"
        to: reesjmorgan@gmail.com
        from: Morgan Rees <reesjmorgan@gmail.com>
        body: |
          Attached is the latest Trading Economics data.
          Timestamp: ${{ github.event.inputs.timestamp }}
          Note: Some data may be missing due to scraping issues.
        attachments: |
          data/${{ github.event.inputs.timestamp }}/Trading_Economics/bonds.csv
          data/${{ github.event.inputs.timestamp }}/Trading_Economics/commodities.csv
          data/${{ github.event.inputs.timestamp }}/Trading_Economics/stocks.csv
          data/${{ github.event.inputs.timestamp }}/Trading_Economics/shares_gainers.csv
          data/${{ github.event.inputs.timestamp }}/Trading_Economics/shares_losers.csv
          data/${{ github.event.inputs.timestamp }}/Trading_Economics/currencies.csv
          data/${{ github.event.inputs.timestamp }}/Trading_Economics/crypto.csv
        secure: true
      continue-on-error: true
