<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Volatility Surfaces</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1C2526;
            color: #FFFFFF;
            margin: 0;
            padding: 0;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        select, input {
            padding: 5px;
            background-color: #2E3537;
            color: #FFFFFF;
            border: 1px solid #FFFFFF;
            border-radius: 4px;
        }
        #ticker-search {
            width: 200px;
        }
        #ticker-datalist {
            background-color: #2E3537;
            color: #FFFFFF;
        }
        .nav-link {
            color: #00BFFF;
            text-decoration: none;
            padding: 5px;
            display: inline-block;
        }
        .nav-link:hover {
            text-decoration: underline;
        }
        .plot-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 1200px;
        }
        .plot-container {
            width: 100%;
            height: 400px;
        }
        #error-message {
            color: #FF6666;
            padding: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div>
            <a href="index.html" class="nav-link">Back to Charts</a>
            <a href="data-table.html" class="nav-link">View Data Table</a>
        </div>
        <div class="controls">
            <label for="source-select">Select Data Source: </label>
            <select id="source-select">
                <option value="nasdaq" selected>Nasdaq</option>
                <option value="yfinance">yfinance</option>
            </select>
            <label for="date-select">Select Date: </label>
            <select id="date-select"></select>
            <label for="time-select">Select Time: </label>
            <select id="time-select"></select>
            <label for="ticker-search">Search Ticker: </label>
            <input type="text" id="ticker-search" list="ticker-datalist" placeholder="Type to search ticker...">
            <datalist id="ticker-datalist"></datalist>
        </div>
        <div id="error-message">No data available for selected ticker</div>
        <div class="plot-grid">
            <div class="plot-container" id="iv-mid-calls"><h2>IV Mid (Calls)</h2></div>
            <div class="plot-container" id="iv-mid-puts"><h2>IV Mid (Puts)</h2></div>
            <div class="plot-container" id="smoothed-iv-calls"><h2>Smoothed IV (Calls)</h2></div>
            <div class="plot-container" id="smoothed-iv-puts"><h2>Smoothed IV (Puts)</h2></div>
            <div class="plot-container" id="local-vol-calls"><h2>Local Volatility (Calls)</h2></div>
            <div class="plot-container" id="local-vol-puts"><h2>Local Volatility (Puts)</h2></div>
        </div>
    </div>
    <script>
        let data = [];

        function parseCSV(csvText) {
            try {
                const result = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });
                return result.data;
            } catch (error) {
                console.error('Error parsing CSV:', error);
                return [];
            }
        }

        function normalizeDate(dateStr) {
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) throw new Error('Invalid date');
                return date.toISOString().split('T')[0];
            } catch (error) {
                console.error('Error normalizing date:', dateStr, error);
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const dateSelect = document.getElementById('date-select');
                const timeSelect = document.getElementById('time-select');
                const tickerSearch = document.getElementById('ticker-search');
                const sourceSelect = document.getElementById('source-select');

                fetch('data/dates.json?v=' + Date.now())
                    .then(response => response.json())
                    .then(dates => {
                        const uniqueDates = [...new Set(dates.map(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$1-$2-$3')))];
                        uniqueDates.forEach(datePart => {
                            const option = document.createElement('option');
                            option.value = datePart.replace(/-/g, '');
                            option.textContent = datePart;
                            dateSelect.appendChild(option);
                        });
                        if (dateSelect.options.length > 0) {
                            dateSelect.value = dateSelect.options[0].value;
                            updateTimeOptions(dateSelect.value, dates);
                            loadData(dateSelect.value + '_' + timeSelect.value);
                        }
                        dateSelect.addEventListener('change', (e) => {
                            updateTimeOptions(e.target.value, dates);
                            loadData(e.target.value + '_' + timeSelect.value);
                        });
                        timeSelect.addEventListener('change', (e) => {
                            loadData(dateSelect.value + '_' + e.target.value);
                        });
                        tickerSearch.addEventListener('change', () => {
                            console.log('Ticker changed to:', tickerSearch.value);
                            updatePlots();
                        });
                        sourceSelect.addEventListener('change', () => {
                            console.log('Data source changed to:', sourceSelect.value);
                            loadData(dateSelect.value + '_' + timeSelect.value);
                        });
                    })
                    .catch(error => console.error('Error loading dates:', error));
            } catch (error) {
                console.error('Error in DOMContentLoaded:', error);
            }
        });

        function updateTimeOptions(selectedDate, dates) {
            try {
                const timeSelect = document.getElementById('time-select');
                timeSelect.innerHTML = '';
                const formattedSelectedDate = selectedDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
                const availableTimes = dates
                    .filter(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$1-$2-$3') === formattedSelectedDate)
                    .map(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$4:$5'));
                const uniqueTimes = [...new Set(availableTimes)];
                uniqueTimes.forEach(timePart => {
                    const option = document.createElement('option');
                    option.value = timePart.replace(':', '');
                    option.textContent = timePart;
                    timeSelect.appendChild(option);
                });
                if (timeSelect.options.length > 0) timeSelect.value = timeSelect.options[0].value;
                console.log('Time options updated:', uniqueTimes);
            } catch (error) {
                console.error('Error updating time options:', error);
            }
        }

        function loadData(timestamp) {
            try {
                const source = document.getElementById('source-select').value;
                const prefix = source === 'yfinance' ? 'yfinance_' : '';
                console.log(`Loading data for timestamp: ${timestamp}, source: ${source}`);

                fetch(`data/processed_${prefix}${timestamp}.csv?v=` + Date.now())
                    .then(response => response.text())
                    .then(csvText => {
                        data = parseCSV(csvText);
                        console.log(`Processed ${source} data loaded:`, data);
                        populateTickerSearch();
                        updatePlots();
                    })
                    .catch(error => {
                        console.error(`Error loading processed ${source} data:`, error);
                        document.getElementById('error-message').style.display = 'block';
                    });
            } catch (error) {
                console.error('Error in loadData:', error);
            }
        }

        function populateTickerSearch() {
            try {
                const tickerSearch = document.getElementById('ticker-search');
                const tickerDatalist = document.getElementById('ticker-datalist');
                tickerDatalist.innerHTML = '';
                const uniqueTickers = [...new Set(data.map(item => item.Ticker))]
                    .filter(val => val).sort();
                uniqueTickers.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    tickerDatalist.appendChild(option);
                });
                if (uniqueTickers.includes('COIN')) {
                    tickerSearch.value = 'COIN';
                } else if (uniqueTickers.length > 0) {
                    tickerSearch.value = uniqueTickers[0];
                }
                console.log('Ticker search populated, default:', tickerSearch.value);
            } catch (error) {
                console.error('Error populating ticker search:', error);
            }
        }

        function prepareSurfaceData(filteredData, zKey) {
            try {
                const moneynessValues = [...new Set(filteredData.map(item => Math.round(item.Moneyness * 100 / 10) * 0.1))]
                    .filter(val => !isNaN(val)).sort((a, b) => a - b);
                const expiryValues = [...new Set(filteredData.map(item => normalizeDate(item.Expiry)))]
                    .filter(val => val).sort();
                const zData = [];
                moneynessValues.forEach(() => zData.push(new Array(expiryValues.length).fill(null)));

                filteredData.forEach(item => {
                    const moneynessIndex = moneynessValues.indexOf(Math.round(item.Moneyness * 100 / 10) * 0.1);
                    const expiryIndex = expiryValues.indexOf(normalizeDate(item.Expiry));
                    if (moneynessIndex >= 0 && expiryIndex >= 0 && Number.isFinite(item[zKey])) {
                        zData[moneynessIndex][expiryIndex] = item[zKey] * 100;
                    }
                });

                return {
                    x: expiryValues,
                    y: moneynessValues.map(val => val * 100),
                    z: zData
                };
            } catch (error) {
                console.error('Error preparing surface data:', error);
                return { x: [], y: [], z: [] };
            }
        }

        function updatePlots() {
            try {
                const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
                const filteredData = data.filter(item => item.Ticker === selectedTicker);
                console.log('Updating plots for ticker:', selectedTicker, 'Data size:', filteredData.length);

                document.getElementById('error-message').style.display = filteredData.length === 0 ? 'block' : 'none';

                const plotConfigs = [
                    {
                        id: 'iv-mid-calls',
                        title: 'IV Mid (Calls)',
                        data: filteredData.filter(item => item.Type === 'Call'),
                        zKey: 'IV_mid',
                        colorscale: 'Viridis'
                    },
                    {
                        id: 'iv-mid-puts',
                        title: 'IV Mid (Puts)',
                        data: filteredData.filter(item => item.Type === 'Put'),
                        zKey: 'IV_mid',
                        colorscale: 'Viridis'
                    },
                    {
                        id: 'smoothed-iv-calls',
                        title: 'Smoothed IV (Calls)',
                        data: filteredData.filter(item => item.Type === 'Call'),
                        zKey: 'Smoothed_IV',
                        colorscale: 'Plasma'
                    },
                    {
                        id: 'smoothed-iv-puts',
                        title: 'Smoothed IV (Puts)',
                        data: filteredData.filter(item => item.Type === 'Put'),
                        zKey: 'Smoothed_IV',
                        colorscale: 'Plasma'
                    },
                    {
                        id: 'local-vol-calls',
                        title: 'Local Volatility (Calls)',
                        data: filteredData.filter(item => item.Type === 'Call' && item['Call Local Vol'] > 0),
                        zKey: 'Call Local Vol',
                        colorscale: 'Magma'
                    },
                    {
                        id: 'local-vol-puts',
                        title: 'Local Volatility (Puts)',
                        data: filteredData.filter(item => item.Type === 'Put' && item['Put Local Vol'] > 0),
                        zKey: 'Put Local Vol',
                        colorscale: 'Magma'
                    }
                ];

                plotConfigs.forEach(config => {
                    const surfaceData = prepareSurfaceData(config.data, config.zKey);
                    const layout = {
                        title: {
                            text: config.title,
                            font: { color: '#FFFFFF' }
                        },
                        scene: {
                            xaxis: {
                                title: 'Expiry',
                                type: 'date',
                                tickformat: '%Y-%m-%d',
                                color: '#FFFFFF'
                            },
                            yaxis: {
                                title: 'Moneyness (%)',
                                range: [0, 200],
                                color: '#FFFFFF'
                            },
                            zaxis: {
                                title: 'Volatility (%)',
                                color: '#FFFFFF'
                            },
                            bgcolor: '#1C2526'
                        },
                        margin: { l: 40, r: 40, t: 60, b: 40 },
                        paper_bgcolor: '#1C2526',
                        plot_bgcolor: '#1C2526'
                    };

                    Plotly.newPlot(config.id, [{
                        type: 'surface',
                        x: surfaceData.x,
                        y: surfaceData.y,
                        z: surfaceData.z,
                        colorscale: config.colorscale,
                        showscale: true
                    }], layout);
                });
            } catch (error) {
                console.error('Error updating plots:', error);
                document.getElementById('error-message').style.display = 'block';
            }
        }
    </script>
</body>
</html>
