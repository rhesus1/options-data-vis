<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Fourier Toolbox</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.0/dist/chartjs-chart-financial.min.js"></script>
    <style>
:root {
    --bg-color: #1A1A2E;
    --text-color: #FFFFFF;
    --container-bg: #25253d;
    --header-bg: #373758;
    --sidebar-bg: #208191;
    --border-color: #26A69A;
    --button-bg: #208191;
    --button-hover-bg: #4DB6AC;
    --error-color: #FF6B6B;
    --error-bg: rgba(255, 107, 107, 0.1);
    --slider-bg: linear-gradient(to right, #26A69A, #4DB6AC);
    --slider-connect: #26A69A;
    --highlight-positive: #10B981;
    --highlight-negative: #F87171;
}
body[data-theme="light"] {
    --bg-color: #F5F7FA;
    --text-color: #1A1A2E;
    --container-bg: #E8ECEF;
    --header-bg: #D1D9E0;
    --sidebar-bg: #208191;
    --border-color: #26A69A;
    --button-bg: #208191;
    --button-hover-bg: #4DB6AC;
    --error-color: #D32F2F;
    --error-bg: rgba(211, 47, 47, 0.1);
    --slider-bg: linear-gradient(to right, #26A69A, #4DB6AC);
    --slider-connect: #26A69A;
    --highlight-positive: #2E7D32;
    --highlight-negative: #D32F2F;
}
body {
    font-family: Arial, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    margin: 0;
    padding: 0;
    display: flex;
    min-height: 100vh;
    font-size: clamp(14px, 2.5vw, 16px);
}
.sidebar {
    width: clamp(200px, 20vw, 250px);
    background: var(--sidebar-bg);
    padding: 15px;
    border-right: 1px solid var(--border-color);
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
    transition: transform 0.3s ease, width 0.3s ease, visibility 0.3s ease;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    z-index: 1000;
    transform: translateX(-100%);
    visibility: hidden;
    color: #FFFFFF;
}
.sidebar .toggle-button {
    color: #FFFFFF !important; /* Applies to "Show Stats Tables" and "Toggle Light/Dark Mode" buttons */
}
.ticker-display {
    color: #FFFFFF !important; /* Ensures ticker name in teal bar is always white */
}

.sidebar.visible {
    transform: translateX(0);
    visibility: visible;
}
.sidebar.hidden {
    transform: translateX(-100%);
    width: 0;
    padding: 0;
    overflow: hidden;
    visibility: hidden;
}
.sidebar-toggle {
    position: fixed;
    top: 10px;
    left: 10px;
    background-color: var(--button-bg);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 8px;
    cursor: pointer;
    z-index: 1001;
    font-size: clamp(12px, 2vw, 14px);
    display: block;
}
.sidebar.hidden .sidebar-logo,
.sidebar.hidden .header,
.sidebar.hidden select,
.sidebar.hidden input,
.sidebar.hidden .toggle-button,
.sidebar.hidden a {
    display: none;
}
.sidebar-logo {
    display: block;
    max-width: 100%;
    height: auto;
    margin: 0 auto 15px;
    border-radius: 4px;
}
.sidebar-logo[src=""] {
    display: none;
}
.sidebar a {
    color: #FFFFFF;
    text-decoration: none;
    display: block;
    padding: 10px;
    font-size: clamp(12px, 2vw, 14px);
    transition: background-color 0.3s ease;
    border-radius: 4px;
}
.sidebar a:hover {
    background-color: var(--button-hover-bg);
}
.sidebar select, .sidebar input {
    width: 100%;
    padding: 8px;
    background-color: var(--button-bg);
    color: #FFFFFF;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    margin-bottom: 10px;
    font-size: clamp(12px, 2vw, 14px);
    transition: border-color 0.3s ease;
    box-sizing: border-box;
}
.sidebar #ticker-search {
    max-width: clamp(150px, 15vw, 180px);
}
.sidebar select:focus, .sidebar input:focus {
    border-color: var(--button-hover-bg);
    outline: none;
}
.main-content {
    flex: 1;
    padding: 15px 15px 15px 25px;
    overflow-y: auto;
    background: var(--bg-color);
    margin-left: 0;
    width: calc(100% - 25px);
    box-sizing: border-box;
    transition: margin-left 0.3s ease, width 0.3s ease, padding-left 0.3s ease;
    overflow-x: auto;
}
.main-content.sidebar-visible {
    margin-left: clamp(225px, calc(20vw + 25px), 275px);
    width: calc(100% - clamp(225px, calc(20vw + 25px), 275px));
    padding-left: 25px;
}
.chart-container {
    background-color: var(--container-bg);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    overflow-x: auto;
    overflow-y: hidden;
}
.summary-container, .contracts-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}
.stats-table, .summary-table, .raw-data-table, .contracts-table, .ranking-table, .stock-table, .normalized-table, .trading-economics-table, #selected-ticker-table {
    border-collapse: collapse;
    width: 100%;
    max-width: 100%;
    margin-top: 10px;
    background-color: var(--container-bg);
    font-size: clamp(10px, 2vw, 12px);
    overflow-x: auto;
    display: block;
    table-layout: auto;
    min-width: 100%;
    line-height: 1.4;
}
.summary-table, .contracts-table {
    width: auto;
    max-width: 90%;
    margin: 0 auto;
    display: table;
}
.summary-table th, .summary-table td, .contracts-table th, .contracts-table td {
    text-align: center;
}
.ranking-table th, .stock-table th, .contracts-table th, .normalized-table th, .trading-economics-table th, #selected-ticker-table th {
    border: 1px solid var(--border-color);
    background-color: var(--header-bg);
    font-weight: bold;
    cursor: pointer;
    white-space: nowrap;
    padding: clamp(6px, 1.2vw, 8px) clamp(4px, 0.8vw, 6px);
    text-align: left;
    color: var(--text-color);
    line-height: 1.4;
    min-width: 50px;
    font-size: clamp(10px, 2vw, 12px);
}
.summary-table th, .contracts-table th {
    text-align: center;
}
.stats-table th, .stats-table td, .summary-table th, .summary-table td,
.ranking-table td, .raw-data-table th, .raw-data-table td,
.contracts-table th, .contracts-table td, .stock-table th, .stock-table td,
.normalized-table th, .normalized-table td, .trading-economics-table th, .trading-economics-table td,
#selected-ticker-table th, #selected-ticker-table td {
    border: 1px solid var(--border-color);
    padding: clamp(4px, 1vw, 6px);
    text-align: left;
    color: var(--text-color);
    font-size: clamp(10px, 2vw, 12px);
    white-space: normal;
    line-height: 1.4;
}
.stats-table th, .summary-table th, .raw-data-table th, .contracts-table th, .stock-table th,
.normalized-table th, .trading-economics-table th, #selected-ticker-table th {
    background-color: var(--header-bg);
    font-weight: bold;
    cursor: pointer;
}
.stats-table th:hover, .raw-data-table th:hover, .ranking-table th:hover, .contracts-table th:hover,
.stock-table th:hover, .normalized-table th:hover, .trading-economics-table th:hover, #selected-ticker-table th:hover {
    background-color: #4B4B6F;
}
canvas, #call-vol-surface, #put-vol-surface {
    width: 100% !important;
    max-height: clamp(250px, 40vh, 350px);
    min-height: clamp(200px, 30vh, 300px);
    border-radius: 4px;
    background-color: var(--container-bg) !important;
}
.volatility-grid canvas {
    width: 100% !important;
    max-height: clamp(500px, 80vh, 700px);
    min-height: clamp(400px, 60vh, 600px);
    border-radius: 4px;
    background-color: var(--container-bg) !important;
}
#call-vol-surface, #put-vol-surface {
    width: 100% !important;
    max-height: clamp(625px, 100vh, 875px);
    min-height: clamp(500px, 75vh, 750px);
    min-width: 100%;
    background-color: var(--container-bg) !important;
}
#call-vol-surface, #put-vol-surface {
    background-color: var(--container-bg) !important;
}
#call-vol-surface .plotly, #put-vol-surface .plotly,
#call-vol-surface .main-svg, #put-vol-surface .main-svg {
    background-color: transparent !important;
}
.sidebar .header {
    text-align: center;
    padding: 10px;
    background-color: var(--sidebar-bg);
    border-bottom: 1px solid var(--border-color);
    font-size: clamp(14px, 2.5vw, 16px);
    font-weight: bold;
    color: #FFFFFF;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}
.header {
    text-align: center;
    padding: 10px;
    background-color: var(--sidebar-bg);
    border-bottom: 1px solid var(--border-color);
    font-size: clamp(14px, 2.5vw, 16px);
    font-weight: bold;
    color: var(--text-color);
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}
.ticker-display {
    font-size: clamp(12px, 2vw, 14px);
    margin-bottom: 10px;
    color: var(--text-color);
    text-align: center;
    background-color: var(--sidebar-bg);
    padding: 8px;
    border-radius: 4px;
}
.select-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}
.arrow-button, .toggle-button {
    background-color: var(--button-bg);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    font-size: clamp(12px, 2vw, 14px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}
.arrow-button:hover, .toggle-button:hover {
    background-color: var(--button-hover-bg);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}
#historic-error, .error-message {
    color: var(--error-color);
    background-color: var(--error-bg);
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    text-align: center;
    font-size: clamp(12px, 2vw, 14px);
}
.line-swatch {
    display: inline-block;
    vertical-align: middle;
    margin-right: 5px;
}
.overview-grid {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    grid-template-rows: auto auto;
    gap: 20px;
    max-width: 100%;
}
.overview-grid .historic-container {
    grid-column: span 7;
}
.overview-grid .summary-container {
    grid-column: span 3;
}
.overview-grid .contracts-container:nth-child(3) {
    grid-column: span 5;
}
.overview-grid .contracts-container:nth-child(4) {
    grid-column: span 5;
}
.volatility-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(clamp(700px, 70vw, 800px), 1fr));
    gap: 20px;
}
.volatility-surface-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
}
.ranking-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(clamp(300px, 30vw, 350px), 1fr));
    gap: 20px;
}
.slider-container {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    justify-content: center;
    align-items: center;
}
.slider-group {
    display: flex;
    flex-direction: row;
    gap: 40px;
    align-items: center;
    width: 100%;
    justify-content: center;
}
.slider-group label {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    font-size: clamp(12px, 2vw, 14px);
}
.noUi-target {
    background: var(--slider-bg);
    border: none;
    border-radius: 5px;
    height: 10px;
    width: 80%;
    margin: 0 auto;
}
.noUi-connect {
    background: var(--slider-connect);
}
.noUi-handle {
    width: 20px;
    height: 20px;
    background: var(--text-color);
    border: 2px solid var(--border-color);
    border-radius: 50%;
    box-shadow: 0 0 5px rgba(38, 166, 154, 0.5);
    cursor: pointer;
    margin-top: -5px;
}
.slider-value {
    margin-top: 0;
    color: var(--button-hover-bg);
    font-weight: bold;
    font-size: clamp(14px, 2.5vw, 16px);
    padding: 5px 10px;
    background: transparent;
    border-radius: 4px;
    white-space: nowrap;
    display: block;
    text-align: center;
}
.chart-container h2, .chart-container h3 {
    margin-bottom: 10px;
    text-align: center;
    font-size: clamp(12px, 2vw, 14px);
    line-height: 1.3;
    color: var(--text-color);
}
@media (max-width: 1024px) {
    .volatility-grid {
        grid-template-columns: 1fr;
    }
    .volatility-surface-grid {
        grid-template-columns: 1fr;
    }
    .overview-grid, .ranking-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
    }
    .overview-grid .historic-container { grid-column: span 1; }
    .overview-grid .summary-container { grid-column: span 1; }
    .overview-grid .contracts-container:nth-child(3) { grid-column: span 1; }
    .overview-grid .contracts-container:nth-child(4) { grid-column: span 1; }
}
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        width: clamp(180px, 80vw, 200px);
    }
    .sidebar.visible {
        transform: translateX(0);
    }
    .sidebar-toggle {
        display: block;
    }
    .main-content {
        margin-left: 0;
        width: 100%;
    }
    .main-content.full-width {
        margin-left: 0;
        width: 100%;
    }
    .overview-grid, .volatility-grid, .volatility-surface-grid, .ranking-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
    }
    .overview-grid .historic-container { grid-column: span 1; }
    .overview-grid .summary-container { grid-column: span 1; }
    .overview-grid .contracts-container:nth-child(3) { grid-column: span 1; }
    .overview-grid .contracts-container:nth-child(4) { grid-column: span 1; }
    .chart-container {
        padding: 10px;
        margin-bottom: 10px;
    }
    canvas, #call-vol-surface {
        max-height: clamp(400px, 70vh, 600px);
        min-height: clamp(360px, 60vh, 500px);
    }
    .stats-table, .summary-table, .raw-data-table, .contracts-table, .ranking-table, .stock-table,
    .normalized-table, .trading-economics-table, #selected-ticker-table {
        font-size: clamp(8px, 1.6vw, 10px);
        line-height: 1.2;
    }
    .ranking-table th, .stock-table th, .contracts-table th, .normalized-table th,
    .trading-economics-table th, #selected-ticker-table th {
        padding: clamp(3px, 0.8vw, 4px) clamp(2px, 0.4vw, 3px);
        min-width: 40px;
        font-size: clamp(8px, 1.6vw, 10px);
        white-space: normal;
    }
    .stats-table th, .stats-table td, .summary-table th, .summary-table td,
    .ranking-table td, .raw-data-table th, .raw-data-table td,
    .contracts-table th, .contracts-table td, .stock-table th, .stock-table td,
    .normalized-table th, .normalized-table td, .trading-economics-table th, .trading-economics-table td,
    #selected-ticker-table th, #selected-ticker-table td {
        padding: clamp(4px, 1vw, 6px);
        text-align: left;
        color: var(--text-color);
        font-size: clamp(10px, 2vw, 12px);
        white-space: normal;
        line-height: 1.4;
    }
    .chart-container h2, .chart-container h3 {
        font-size: clamp(11px, 1.8vw, 13px);
    }
    .shares-container {
        grid-template-columns: 1fr;
    }
}
@media (max-width: 480px) {
    .sidebar {
        width: 100%;
    }
    .chart-container {
        padding: 8px;
    }
    canvas, #call-vol-surface {
        max-height: clamp(360px, 60vh, 500px);
        min-height: clamp(320px, 50vh, 440px);
    }
    .stats-table, .summary-table, .raw-data-table, .contracts-table, .ranking-table, .stock-table,
    .normalized-table, .trading-economics-table, #selected-ticker-table {
        font-size: clamp(7px, 1.5vw, 9px);
        line-height: 1.2;
    }
    .ranking-table th, .stock-table th, .contracts-table th, .normalized-table th,
    .trading-economics-table th, #selected-ticker-table th {
        padding: clamp(2px, 0.6vw, 3px) clamp(1px, 0.3vw, 2px);
        min-width: 30px;
        font-size: clamp(7px, 1.5vw, 9px);
        white-space: normal;
    }
    .stats-table th, .stats-table td, .summary-table th, .summary-table td,
    .ranking-table td, .raw-data-table th, .raw-data-table td,
    .contracts-table th, .contracts-table td, .stock-table th, .stock-table td,
    .normalized-table th, .normalized-table td, .trading-economics-table th, .trading-economics-table td,
    #selected-ticker-table th, #selected-ticker-table td {
        padding: clamp(2px, 0.6vw, 3px);
        white-space: normal;
    }
    .chart-container h2, .chart-container h3 {
        font-size: clamp(10px, 1.6vw, 12px);
    }
}
/* Adjust selected ticker row shading for light and dark modes */
.selected-ticker-row,
.selected-ticker-row td,
#selected-ticker-table .selected-ticker-row,
#selected-ticker-table .selected-ticker-row td {
    background-color: #4B4B6F !important; /* Dark mode: Keep existing color */
}

body[data-theme="light"] .selected-ticker-row,
body[data-theme="light"] .selected-ticker-row td,
body[data-theme="light"] #selected-ticker-table .selected-ticker-row,
body[data-theme="light"] #selected-ticker-table .selected-ticker-row td {
    background-color: #B0B0D0 !important; /* Light mode: Lighter shade for better contrast */
}
.sub-menu {
    display: none !important;
    margin-left: 15px;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.sub-menu.active {
    display: block !important;
    opacity: 1;
}
.sub-menu a.sub-tab {
    font-size: clamp(10px, 1.8vw, 12px);
    padding: 8px 10px;
    margin-left: 0;
    display: block;
    color: #FFFFFF;
}
.sub-menu a.sub-tab:hover, .sub-menu a.sub-tab.active {
    background-color: #3A8A7E;
    color: #FFFFFF;
}
.trading-economics-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
}
.shares-grid {
    display: grid;
    grid-template-columns: 1fr;
}
.shares-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}
</style>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">â˜°</button>
    <div class="sidebar hidden">
        <img src="logo.webp" alt="Fourier Asset Management" class="sidebar-logo">
        <div class="header">Fourier Toolbox</div>
        <select id="date-select"></select>
        <select id="time-select"></select>
        <input type="text" id="ticker-search" list="ticker-datalist" placeholder="Search Ticker...">
        <datalist id="ticker-datalist"></datalist>
        <button class="toggle-button" onclick="toggleStatsTables()">Show Stats Tables</button>
        <button class="toggle-button" onclick="toggleTheme()">Toggle Light/Dark Mode</button>
        <a href="#macro" id="macro-link">Macro</a>
        <div class="sub-menu hidden" id="macro-sub-menu">
            <a href="#macro-bonds" class="sub-tab">Bonds</a>
            <a href="#macro-commodities" class="sub-tab">Commodities</a>
            <a href="#macro-stocks" class="sub-tab">Stocks</a>
            <a href="#macro-currencies" class="sub-tab">Currencies</a>
            <a href="#macro-crypto" class="sub-tab">Crypto</a>
            <a href="#macro-shares" class="sub-tab">Shares</a>
        </div>
        <a href="#indices">Indices</a>
        <div class="sub-menu hidden" id="indices-sub-menu"> <!-- Added sub-menu -->
            <a href="#indices-overview" class="sub-tab">Wisesheets</a> <!-- Renamed from indices -->
            <a href="#indices-stock" class="sub-tab">Yahoo Finance</a> <!-- Moved from Volatility -->
            <a href="#indices-price-comparisons" class="sub-tab">Price Comparisons</a> <!-- Moved from Volatility -->
        </div>
        <a href="#volatility" id="volatility-link">Volatility</a>
        <div class="sub-menu hidden" id="volatility-sub-menu">
            <a href="#volatility-overview" class="sub-tab">Overview</a>
            <a href="#volatility-plots" class="sub-tab">Volatility Plots</a>
            <a href="#volatility-surface" class="sub-tab">Volatility Surface</a>
            <a href="#volatility-ranking" class="sub-tab">Ranking</a>
            <a href="#volatility-data-table" class="sub-tab">Data Table</a>
        </div>
    </div>
    <div class="main-content">
        <div class="ticker-display" id="ticker-display">N/A</div>
        <div id="selected-ticker-summary" class="chart-container" style="display: none;">
            <h3>Selected Ticker Ranking Summary</h3>
            <table id="selected-ticker-table" class="ranking-table"></table>
        </div>
        <div id="macro" class="trading-economics-grid" style="display: none;">
            <div id="trading-economics-error" class="error-message" style="display: none;">No Trading Economics data available</div>
            <div id="macro-error" class="error-message" style="display: none;">No macro data available</div>
            <div id="macro-bonds" class="chart-container" style="display: none;">
                <h2>Bonds</h2>
                <button class="toggle-button" onclick="toggleTradingEconomicsTable('bonds')">Hide Data</button>
                <table id="bonds-table" class="trading-economics-table" style="display: table;"></table>
            </div>
            <div id="macro-commodities" class="chart-container" style="display: none;">
                <h2>Commodities</h2>
                <button class="toggle-button" onclick="toggleTradingEconomicsTable('commodities')">Hide Data</button>
                <table id="commodities-table" class="trading-economics-table" style="display: table;"></table>
            </div>
            <div id="macro-stocks" class="chart-container" style="display: none;">
                <h2>Stocks</h2>
                <button class="toggle-button" onclick="toggleTradingEconomicsTable('stocks')">Hide Data</button>
                <table id="stocks-table" class="trading-economics-table" style="display: table;"></table>
            </div>
            <div id="macro-currencies" class="chart-container" style="display: none;">
                <h2>Currencies</h2>
                <button class="toggle-button" onclick="toggleTradingEconomicsTable('currencies')">Hide Data</button>
                <table id="currencies-table" class="trading-economics-table" style="display: table;"></table>
            </div>
            <div id="macro-crypto" class="chart-container" style="display: none;">
                <h2>Crypto</h2>
                <button class="toggle-button" onclick="toggleTradingEconomicsTable('crypto')">Hide Data</button>
                <table id="crypto-table" class="trading-economics-table" style="display: table;"></table>
            </div>
            <div id="macro-shares" class="chart-container shares-grid" style="display: none;">
                <h2>Shares</h2>
                <div class="shares-container">
                    <div class="chart-container">
                        <h3>Gainers</h3>
                        <button class="toggle-button" onclick="toggleTradingEconomicsTable('shares_gainers')">Hide Data</button>
                        <table id="shares-gainers-table" class="trading-economics-table" style="display: table;"></table>
                    </div>
                    <div class="chart-container">
                        <h3>Losers</h3>
                        <button class="toggle-button" onclick="toggleTradingEconomicsTable('shares_losers')">Hide Data</button>
                        <table id="shares-losers-table" class="trading-economics-table" style="display: table;"></table>
                    </div>
                </div>
            </div>
        </div>
        <div id="indices" class="trading-economics-grid" style="display: none;"> <!-- Changed to trading-economics-grid -->
            <div id="indices-overview" class="chart-container" style="display: none;">
                <h2>Indices Data from Wisesheets</h2>
                <div id="indices-error" class="error-message" style="display: none;">No indices data available</div>
                <button class="toggle-button" onclick="toggleIndicesData()">Toggle Normalized Data</button>
				<button class="toggle-button" onclick="toggleIndicesChart()">Show Plot</button>
				<div class="select-container">
                    <label for="wisesheets-start-date">Start Date: </label>
                    <input type="date" id="wisesheets-start-date">
                    <label for="wisesheets-end-date">End Date: </label>
                    <input type="date" id="wisesheets-end-date">
                    <button class="toggle-button" onclick="exportWisesheetsData()">Export to XLSX</button>
                </div>
                <div class="select-container">
                    <label for="wisesheets-ticker-search">Search Ticker: </label>
                    <input type="text" id="wisesheets-ticker-search" placeholder="Search for ticker..." oninput="filterWisesheetsTickers()">
                </div>
                <div class="select-container">
                    <label for="wisesheets-ticker-select">Select Tickers to Compare (Multi): </label>
                    <select id="wisesheets-ticker-select" multiple style="width: 200px;">
                    </select>
                </div>
                <canvas id="indices-chart" style="display: none;"></canvas>
                <table id="indices-table" class="trading-economics-table" style="display: table;"></table>
            </div>
            <div id="indices-stock" class="chart-container" style="display: none;">
                <h2>Stock Metrics</h2>
                <button class="toggle-button" onclick="toggleStockTable()">Show Data</button>
                <table id="stock-table" class="stock-table" style="display: none;"></table>
                <div class="chart-container">
                    <h3>Kurtosis</h3>
                    <div class="select-container">
                        <label for="kurtosis-start-date">Start Date: </label>
                        <input type="date" id="kurtosis-start-date">
                        <label for="kurtosis-end-date">End Date: </label>
                        <input type="date" id="kurtosis-end-date">
                    </div>
                    <div class="select-container">
                        <label for="kurtosis-type-select">Select Kurtosis Type: </label>
                        <select id="kurtosis-type-select">
                            <option value="Kurtosis_Close_100d" selected>Close Prices</option>
                            <option value="Kurtosis_Returns_100d">Log Returns</option>
                        </select>
                    </div>
                    <canvas id="kurtosis-chart"></canvas>
                    <div id="kurtosis-error" class="error-message" style="display: none;">No kurtosis data available</div>
                </div>
            </div>
            <div id="indices-price-comparisons" class="chart-container" style="display: none;">
                <h2>Price Comparisons</h2>
                <div class="select-container">
                    <label for="ticker-compare-select">Select Tickers to Compare (Multi): </label>
                    <select id="ticker-compare-select" multiple style="width: 200px;">
                    </select>
                </div>
                <button class="toggle-button" onclick="togglePriceComparisonsTable()">Show Data</button>
                <table id="normalized-table" class="normalized-table" style="display: none;"></table>
            </div>
        </div>
        <div id="volatility" class="volatility-grid" style="display: none;">
            <div id="volatility-overview" class="overview-grid" style="display: none;">
                <div class="chart-container historic-container">
                    <h2>Historic Stock Price</h2>
                    <div class="select-container">
                        <label for="historic-chart-type">Chart Type: </label>
                        <select id="historic-chart-type">
                            <option value="line" selected>Line</option>
                            <option value="candlestick">Candlestick</option>
                        </select>
                        <label for="historic-start-date">Start Date: </label>
                        <input type="date" id="historic-start-date">
                        <label for="historic-end-date">End Date: </label>
                        <input type="date" id="historic-end-date">
                    </div>
                    <canvas id="historic-price-chart"></canvas>
                    <div id="historic-error" class="error-message" style="display: none;">No historic data available</div>
                </div>
                <div class="chart-container summary-container">
                    <h2>Summary</h2>
                    <table id="summary-table" class="summary-table"></table>
                </div>
                <div class="chart-container contracts-container">
                    <h2>Top 10 Volume Contracts</h2>
                    <table id="top-volume-table" class="contracts-table"></table>
                </div>
                <div class="chart-container contracts-container">
                    <h2>Top 10 Open Interest Contracts</h2>
                    <table id="top-open-interest-table" class="contracts-table"></table>
                </div>
            </div>
            <div id="volatility-plots" class="chart-container" style="display: none;">
                <h3>Volatility Plots</h3>
                <div class="volatility-grid">
                    <div class="chart-container">
                        <h4>Implied Volatility Smile</h4>
                        <div class="select-container">
                            <label for="expiry-select">Select Expiry: </label>
                            <select id="expiry-select"></select>
                        </div>
                        <canvas id="moneyness-vs-iv-chart"></canvas>
                        <div id="moneyness-error" class="error-message" style="display: none;">No data available</div>
                    </div>
                    <div class="chart-container">
                        <h4>Implied Volatility Term Structure</h4>
                        <div class="select-container">
                            <label for="moneyness-select">Select Moneyness: </label>
                            <select id="moneyness-select"></select>
                        </div>
                        <div class="select-container">
                            <label for="term-min-expiry">Min Expiry: </label>
                            <input type="date" id="term-min-expiry">
                            <label for="term-max-expiry">Max Expiry: </label>
                            <input type="date" id="term-max-expiry">
                        </div>
                        <canvas id="expiry-vs-iv-chart"></canvas>
                        <div id="expiry-error" class="error-message" style="display: none;">No data available</div>
                    </div>
                    <div class="chart-container">
                        <h4>Volatility Skewness</h4>
                        <div class="select-container">
                            <label for="skew-min-expiry">Min Expiry: </label>
                            <input type="date" id="skew-min-expiry">
                            <label for="skew-max-expiry">Max Expiry: </label>
                            <input type="date" id="skew-max-expiry">
                        </div>
                        <div class="select-container">
                            <label for="skew-metric-select">Select Skew Metrics (Multi): </label>
                            <select id="skew-metric-select" multiple>
                                <option value="Skew_25_delta" selected>Skew 25 Delta</option>
                                <option value="Skew_75_delta" selected>Skew 75 Delta</option>
                                <option value="Skew_90_Moneyness" selected>Skew 90 Moneyness</option>
                                <option value="Skew_80_Moneyness" selected>Skew 80 Moneyness</option>
                                <option value="Skew_70_Moneyness" selected>Skew 70 Moneyness</option>
                                <option value="Skew_90_Moneyness_Vol" selected>Skew 90 Moneyness Vol</option>
                                <option value="Skew_80_Moneyness_Vol" selected>Skew 80 Moneyness Vol</option>
                                <option value="Skew_70_Moneyness_Vol" selected>Skew 70 Moneyness Vol</option>
                            </select>
                        </div>
                        <canvas id="skew-vs-expiry-chart"></canvas>
                        <div id="skew-error" class="error-message" style="display: none;">No data available</div>
                    </div>
                    <div class="chart-container">
                        <h4>Realised Volatility</h4>
                        <div class="select-container">
                            <label for="realised-start-date">Start Date: </label>
                            <input type="date" id="realised-start-date">
                            <label for="realised-end-date">End Date: </label>
                            <input type="date" id="realised-end-date">
                        </div>
                        <div class="select-container">
                            <label for="realised-vol-metric-select">Select Volatility Metrics (Multi): </label>
                            <select id="realised-vol-metric-select" multiple>
                                <option value="Realised_Vol_Close_30" selected>30-day Vol</option>
                                <option value="Realised_Vol_Close_60" selected>60-day Vol</option>
                                <option value="Realised_Vol_Close_100" selected>100-day Vol</option>
                                <option value="Realised_Vol_Close_180" selected>180-day Vol</option>
                                <option value="Realised_Vol_Close_252" selected>252-day Vol</option>
                            </select>
                        </div>
                        <canvas id="realised-vol-chart"></canvas>
                        <div id="realised-vol-error" class="error-message" style="display: none;">No data available</div>
                    </div>
                    <div class="chart-container">
                        <h4>Volatility of Vol (100-day)</h4>
                        <div class="select-container">
                            <label for="volofvol-start-date">Start Date: </label>
                            <input type="date" id="volofvol-start-date">
                            <label for="volofvol-end-date">End Date: </label>
                            <input type="date" id="volofvol-end-date">
                        </div>
                        <canvas id="vol-of-vol-chart"></canvas>
                        <div id="vol-of-vol-error" class="error-message" style="display: none;">No volatility of volatility data available</div>
                    </div>
                </div>
            </div>
            <div id="volatility-ranking" class="chart-container" style="display: none;">
                <h2>Ticker Ranking</h2>
                <button class="toggle-button" onclick="toggleRankingTable()">Show Data</button>
                <table id="ranking-table" class="ranking-table" style="display: none;"></table>
                <div class="ranking-grid">
                    <div class="chart-container">
                        <h3>Volume</h3>
                        <canvas id="volume-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Open Interest</h3>
                        <canvas id="open-interest-chart"></canvas>
                    </div>
                </div>
            </div>
            <div id="volatility-data-table" class="chart-container" style="display: none;">
                <h2>Data Table</h2>
                <table id="raw-data-table" class="raw-data-table"></table>
            </div>
            <div id="volatility-surface" class="volatility-surface-grid" style="display: none;">
                <h2>Volatility Surfaces</h2>
                <div class="slider-container">
                    <div class="slider-group">
                        <label>Moneyness Range: <div id="moneyness-slider" class="pretty-slider"></div>
                            <span id="moneyness-value" class="slider-value">0.6 - 2.5</span></label>
                        <label>Expiry (T) Range: <div id="expiry-t-slider" class="pretty-slider"></div>
                            <span id="expiry-t-value" class="slider-value">0.2 - 5.0</span></label>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Call Volatility Surface</h3>
                    <div id="call-vol-surface" style="height: 100%; width: 100%;"></div>
                </div>
                <div class="chart-container">
                    <h3>Put Volatility Surface</h3>
                    <div id="put-vol-surface" style="height: 100%; width: 100%;"></div>
                </div>
                <div id="vol-surface-error" class="error-message" style="display: none;">No volatility surface parameters available</div>
                <div id="surface-error" class="error-message" style="display: none;">No data available</div>
            </div>
        </div>
    </div>
    <script>
        function getThemeColor() {
            return document.body.getAttribute('data-theme') === 'light' ? '#1A1A2E' : '#FFFFFF';
        }    
        let wisesheetsSelectedTickers = []; // Array of selected tickers for chart
        let normalizedIndicesData = [];
        let showNormalized = false;
        let indicesChartVisible = false;
        let indicesChart = null;
        let indicesData = []; // Added for Wisesheets indices data
        let data = [];
        let volSurfData = [];
        let historicData = [];
        let cleanedData = [];
        let skewData = [];
        let slopeData = [];
        let eventsData = [];
        let rawData = [];
        let rankingData = [];
        let companyNames = [];
        let summaryData = [];
        let topVolumeData = [];
        let topOpenInterestData = [];
        let stockData = [];
        let uniqueExpiries = [];
        let normalizedData = [];
        let bondsData = [];
        let commoditiesData = [];
        let stocksData = [];
        let currenciesData = [];
        let cryptoData = [];
        let sharesGainersData = [];
        let sharesLosersData = [];
        let bondsTableVisible = true;
        let commoditiesTableVisible = true;
        let stocksTableVisible = true;
        let currenciesTableVisible = true;
        let cryptoTableVisible = true;
        let sharesGainersTableVisible = true;
        let sharesLosersTableVisible = true;
        let normalizedTableVisible = false;
        let moneynessChart, expiryChart, historicChart, volumeChart, openInterestChart, skewChart, realisedVolChart, kurtosisChart, volOfVolChart;
        let statsTablesVisible = false;
        let rankingTableVisible = false;
        let stockTableVisible = false;
        let lastLoadDataTimestamp = null;
        let loadDataTimeout = null;
        let lastTicker = null;
    
        function parseCSV(csvText) {
            try {
                const result = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });
                return result.data;
            } catch (error) {
                console.error('Error parsing CSV:', error);
                return [];
            }
        }
    
        async function fetchWithErrorHandling(url, array) {
            try {
                if (typeof parseCSV !== 'function') {
                    throw new Error('parseCSV function is not defined. Ensure PapaParse is loaded.');
                }
                const response = await fetch(`${url}?v=${Date.now()}`);
                console.log(`Fetch response for ${url}:`, { status: response.status, statusText: response.statusText });
                if (!response.ok) throw new Error(`Failed to fetch ${url}: ${response.statusText}`);
                const parsedData = parseCSV(await response.text());
                array.splice(0, array.length, ...parsedData);
                if (parsedData.length > 0) {
                    console.log(`Sample row from ${url}:`, parsedData[0]);
                } else {
                    console.warn(`No data parsed from ${url}`);
                }
                console.log(`Data loaded from ${url}, size:`, array.length, 'sample:', array.slice(0, 5));
            } catch (error) {
                console.warn(`Error loading ${url}:`, error);
                array.splice(0, array.length);
                const errorElement = document.getElementById(url.includes('Trading_Economics') ? 'trading-economics-error' : 'historic-error');
                if (errorElement) {
                    errorElement.textContent = `Failed to load ${url}: ${error.message}`;
                    errorElement.style.display = 'block';
                } else {
                    console.warn(`${url.includes('Trading_Economics') ? 'trading-economics-error' : 'historic-error'} element not found in DOM`);
                }
            }
        }

        async function loadWisesheetsData() {
    try {
        const filePath = 'data/wisesheets_cb_vs_hy.xlsx';
        const encodedPath = encodeURI(filePath);
        const response = await fetch(encodedPath + '?v=' + new Date().getTime());
        if (!response.ok) throw new Error(`Failed to fetch Wisesheets file: ${response.statusText}`);
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array', cellDates: true, dateNF: 'yyyy-mm-dd' });
        
        const priceSheet = workbook.Sheets['Price'];
        const normSheet = workbook.Sheets['Normalised'];
        if (!priceSheet || !normSheet) throw new Error('Price or Normalised sheet not found in Wisesheets file');
        
        const jsonPrice = XLSX.utils.sheet_to_json(priceSheet, { header: 1, raw: false, dateNF: 'yyyy-mm-dd' });
        const jsonNorm = XLSX.utils.sheet_to_json(normSheet, { header: 1, raw: false, dateNF: 'yyyy-mm-dd' });
        
        console.log('Raw Wisesheets price data (first 5 rows):', JSON.stringify(jsonPrice.slice(0, 5), null, 2));
        console.log('Raw Wisesheets normalized data (first 5 rows):', JSON.stringify(jsonNorm.slice(0, 5), null, 2));
 
        // Extract tickers from row 1 (index 0), columns B-G (indices 1-6)
        const tickers = jsonPrice[0]?.slice(1, 7).filter(t => t && typeof t === 'string') || ['ICVT', 'CWB', 'JNK', 'HYG', 'SJNK', 'IWM'];
        if (tickers.length === 0) throw new Error('No valid tickers found in row 1 (columns B-G)');
        console.log('Extracted tickers:', tickers);
 
        // Parse price data (consecutive rows starting from index 1)
        indicesData = [];
        for (let i = 1; i < jsonPrice.length; i++) {
            const row = jsonPrice[i];
            if (!row || row.length < 1) {
                console.warn(`Skipping invalid row at index ${i}:`, row);
                continue;
            }
            const date = row[0];
            if (!date || isNaN(new Date(date).getTime())) {
                console.warn(`Invalid or missing date at row ${i}:`, date);
                continue;
            }
            const priceRowData = { Date: date };
            let hasValidPrice = false;
            tickers.forEach((ticker, idx) => {
                const value = row[idx + 1];
                const parsedValue = parseFloat(value);
                priceRowData[ticker] = Number.isFinite(parsedValue) ? parsedValue : null;
                if (Number.isFinite(parsedValue)) hasValidPrice = true;
            });
            if (hasValidPrice) indicesData.push(priceRowData);
        }
        
        // Parse normalized data (consecutive rows starting from index 1)
        normalizedIndicesData = [];
        for (let i = 1; i < jsonNorm.length; i++) {
            const row = jsonNorm[i];
            if (!row || row.length < 1) {
                console.warn(`Skipping invalid row at index ${i} in normalized:`, row);
                continue;
            }
            const date = row[0];
            if (!date || isNaN(new Date(date).getTime())) {
                console.warn(`Invalid or missing date at row ${i} in normalized:`, date);
                continue;
            }
            const normRowData = { Date: date };
            let hasValidNorm = false;
            tickers.forEach((ticker, idx) => {
                const value = row[idx + 1];
                const parsedValue = parseFloat(value);
                normRowData[ticker] = Number.isFinite(parsedValue) ? parsedValue : null;
                if (Number.isFinite(parsedValue)) hasValidNorm = true;
            });
            if (hasValidNorm) normalizedIndicesData.push(normRowData);
        }
        
        // Sort by date ascending
        indicesData.sort((a, b) => new Date(a.Date) - new Date(b.Date));
        normalizedIndicesData.sort((a, b) => new Date(a.Date) - new Date(b.Date));
        
        console.log('Parsed price data (first 5 rows):', JSON.stringify(indicesData.slice(0, 5), null, 2));
        console.log('Parsed normalized data (first 5 rows):', JSON.stringify(normalizedIndicesData.slice(0, 5), null, 2));
 
        // Set date range inputs
        if (indicesData.length > 0) {
            const minDate = new Date(Math.min(...indicesData.map(item => new Date(item.Date))));
            const maxDate = new Date(Math.max(...indicesData.map(item => new Date(item.Date))));
            document.getElementById('wisesheets-start-date').value = minDate.toISOString().split('T')[0];
            document.getElementById('wisesheets-end-date').value = maxDate.toISOString().split('T')[0];
        } else {
            console.warn('No valid price data to set date range inputs');
            document.getElementById('wisesheets-start-date').value = '2020-01-01';
            document.getElementById('wisesheets-end-date').value = '2025-09-17';
        }
 
        if (indicesData.length === 0 && normalizedIndicesData.length === 0) {
            throw new Error('No valid price or normalized data extracted from Wisesheets file');
        }
        // Populate ticker dropdown and update table/chart
        populateWisesheetsTickers();
        updateIndicesTable();
        if (indicesChartVisible) updateIndicesChart();
    } catch (error) {
        console.error('Error loading Wisesheets data:', error);
        document.getElementById('indices-error').textContent = `Error loading Wisesheets file: ${error.message}`;
        document.getElementById('indices-error').style.display = 'block';
        indicesData = [];
        normalizedIndicesData = [];
        wisesheetsSelectedTickers = ['ICVT', 'CWB', 'JNK', 'HYG', 'SJNK', 'IWM'];
        populateWisesheetsTickers();
        updateIndicesTable();
    }
}

        function exportWisesheetsData() {
    try {
        const table = document.getElementById('indices-table');
        const startInput = document.getElementById('wisesheets-start-date').value;
        const endInput = document.getElementById('wisesheets-end-date').value;
        const dataToShow = showNormalized ? normalizedIndicesData : indicesData;
        const startDate = startInput ? new Date(startInput) : new Date(Math.min(...dataToShow.map(item => new Date(item.Date))));
        const endDate = endInput ? new Date(endInput) : new Date(Math.max(...dataToShow.map(item => new Date(item.Date))));
        const filteredData = dataToShow.filter(item => {
            const itemDate = new Date(item.Date);
            return itemDate >= startDate && itemDate <= endDate;
        });

        if (filteredData.length === 0) {
            console.warn('No data to export for Wisesheets table');
            document.getElementById('indices-error').textContent = 'No data available to export';
            document.getElementById('indices-error').style.display = 'block';
            return;
        }

        const columns = ['Date', ...(filteredData.length > 0 ? Object.keys(filteredData[0]).filter(key => key !== 'Date') : ['ICVT', 'CWB', 'JNK', 'HYG', 'SJNK', 'IWM'])];
        const wsData = [
            columns,
            ...filteredData.map(item => columns.map(col => {
                const value = item[col];
                return Number.isFinite(value) ? value : value || 'N/A';
            }))
        ];

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, showNormalized ? 'Normalized' : 'Price');
        XLSX.write(wb, `Wisesheets_${showNormalized ? 'Normalized' : 'Price'}_${new Date().toISOString().split('T')[0]}.xlsx`);
        console.log('Wisesheets data exported successfully, rows:', filteredData.length);
    } catch (error) {
        console.error('Error exporting Wisesheets data:', error);
        document.getElementById('indices-error').textContent = `Error exporting data: ${error.message}`;
        document.getElementById('indices-error').style.display = 'block';
    }
}

        function populateWisesheetsTickers() {
            try {
                const tickerSelect = document.getElementById('wisesheets-ticker-select');
                tickerSelect.innerHTML = '';
                const tickers = indicesData.length > 0 ? Object.keys(indicesData[0]).filter(key => key !== 'Date') : ['ICVT', 'CWB', 'JNK', 'HYG', 'SJNK', 'IWM'];
                if (tickers.length === 0) {
                    console.warn('No tickers available for Wisesheets dropdown');
                    tickerSelect.innerHTML = '<option value="">No tickers available</option>';
                    return;
                }
                tickers.forEach(ticker => {
                    const option = document.createElement('option');
                    option.value = ticker;
                    option.textContent = ticker;
                    option.selected = wisesheetsSelectedTickers.includes(ticker);
                    tickerSelect.appendChild(option);
                });
                // Default to all tickers if none selected
                if (wisesheetsSelectedTickers.length === 0 && tickers.length > 0) {
                    wisesheetsSelectedTickers = tickers;
                    Array.from(tickerSelect.options).forEach(opt => {
                        opt.selected = true;
                    });
                }
                console.log('Wisesheets tickers populated:', tickers, 'Selected:', wisesheetsSelectedTickers);
                if (indicesChartVisible) updateIndicesChart();
                updateIndicesTable();
            } catch (error) {
                console.error('Error populating Wisesheets tickers:', error);
                document.getElementById('indices-error').textContent = `Error populating tickers: ${error.message}`;
                document.getElementById('indices-error').style.display = 'block';
                // Fallback to default tickers
                wisesheetsSelectedTickers = ['ICVT', 'CWB', 'JNK', 'HYG', 'SJNK', 'IWM'];
                tickerSelect.innerHTML = '';
                wisesheetsSelectedTickers.forEach(ticker => {
                    const option = document.createElement('option');
                    option.value = ticker;
                    option.textContent = ticker;
                    option.selected = true;
                    tickerSelect.appendChild(option);
                });
            }
        }

        function toggleTheme() {
    const body = document.body;
    const currentTheme = body.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    console.log('Theme toggled to:', newTheme);
    updateAllPlots(); // Redraw all plots to update theme colors
}

	function updateAllPlots() {
    try {
        console.log('Updating all plots for theme change');
        updateIndicesChart();
        updateSkewVsExpiry();
        updateMoneynessVsIV();
        updateExpiryVsIV();
        updateRealisedVolChart();
        updateVolOfVolChart();
        updateHistoricChart();
        updateVolumeChart();
        updateOpenInterestChart();
        updateKurtosisChart();
        updateCallVolSurface();
    } catch (error) {
        console.error('Error updating all plots:', error);
        document.getElementById('historic-error').textContent = `Error updating plots: ${error.message}`;
        document.getElementById('historic-error').style.display = 'block';
    }
}
        
        function filterWisesheetsTickers() {
            try {
                const searchInput = document.getElementById('wisesheets-ticker-search').value.toUpperCase();
                const tickerSelect = document.getElementById('wisesheets-ticker-select');
                const tickers = indicesData.length > 0 ? Object.keys(indicesData[0]).filter(key => key !== 'Date') : ['ICVT', 'CWB', 'JNK', 'HYG', 'SJNK', 'IWM'];
                tickerSelect.innerHTML = '';
                tickers.forEach(ticker => {
                    if (ticker.toUpperCase().includes(searchInput)) {
                        const option = document.createElement('option');
                        option.value = ticker;
                        option.textContent = ticker;
                        option.selected = wisesheetsSelectedTickers.includes(ticker);
                        tickerSelect.appendChild(option);
                    }
                });
                console.log('Filtered Wisesheets tickers, search:', searchInput, 'Visible:', Array.from(tickerSelect.options).map(opt => opt.value));
            } catch (error) {
                console.error('Error filtering Wisesheets tickers:', error);
                document.getElementById('indices-error').textContent = `Error filtering tickers: ${error.message}`;
                document.getElementById('indices-error').style.display = 'block';
            }
        }
        
        function updateIndicesTable() {
    try {
        const table = document.getElementById('indices-table');
        table.innerHTML = '';
        const startInput = document.getElementById('wisesheets-start-date').value;
        const endInput = document.getElementById('wisesheets-end-date').value;
        const startDate = startInput ? new Date(startInput) : new Date(Math.min(...indicesData.map(item => new Date(item.Date))));
        const endDate = endInput ? new Date(endInput) : new Date(Math.max(...indicesData.map(item => new Date(item.Date))));
        const dataToShow = showNormalized ? normalizedIndicesData : indicesData;
        const filteredData = dataToShow.filter(item => {
            const itemDate = new Date(item.Date);
            return itemDate >= startDate && itemDate <= endDate;
        });
        if (filteredData.length === 0) {
            table.innerHTML = '<tr><td colspan="7">No indices data available</td></tr>';
            console.warn('No indices data available for table, normalized:', showNormalized, 'date range:', startDate, endDate);
            document.getElementById('indices-error').textContent = 'No indices data available for selected date range';
            document.getElementById('indices-error').style.display = 'block';
            return;
        }
        const thead = document.createElement('thead');
        const headerRow = thead.insertRow();
        const columns = ['Date', ...(filteredData.length > 0 ? Object.keys(filteredData[0]).filter(key => key !== 'Date') : ['ICVT', 'CWB', 'JNK', 'HYG', 'SJNK', 'IWM'])];
        columns.forEach((col, index) => {
            const th = document.createElement('th');
            th.textContent = col;
            th.dataset.column = col;
            th.dataset.order = 'desc';
            th.addEventListener('click', () => sortTable('indices-table', index));
            headerRow.appendChild(th);
        });
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        filteredData.forEach(item => {
            const row = tbody.insertRow();
            columns.forEach(key => {
                const cell = row.insertCell();
                const value = Number.isFinite(item[key]) ? item[key].toFixed(2) : item[key] || 'N/A';
                cell.textContent = value;
            });
        });
        table.appendChild(tbody);
        document.getElementById('indices-error').style.display = 'none';
        console.log('Indices table updated, normalized:', showNormalized, 'rows:', filteredData.length, 'columns:', columns);
    } catch (error) {
        console.error('Error updating indices table:', error);
        document.getElementById('indices-error').textContent = `Error updating table: ${error.message}`;
        document.getElementById('indices-error').style.display = 'block';
    }
}
        
        function toggleIndicesData() {
            try {
                showNormalized = !showNormalized;
                document.querySelector('#indices-overview .toggle-button[onclick="toggleIndicesData()"]').textContent = showNormalized ? 'Show Price Data' : 'Show Normalized Data';
                updateIndicesTable();
                populateWisesheetsTickers(); // Refresh ticker dropdown
                if (indicesChartVisible) updateIndicesChart();
                console.log('Toggled indices data, showNormalized:', showNormalized);
            } catch (error) {
                console.error('Error toggling indices data:', error);
                document.getElementById('indices-error').textContent = `Error toggling data: ${error.message}`;
                document.getElementById('indices-error').style.display = 'block';
            }
        }

        function toggleIndicesChart() {
		    try {
		        indicesChartVisible = !indicesChartVisible;
		        const chart = document.getElementById('indices-chart');
		        chart.style.display = indicesChartVisible ? 'block' : 'none';
		        document.querySelector('#indices-overview .toggle-button[onclick="toggleIndicesChart()"]').textContent = indicesChartVisible ? 'Hide Plot' : 'Show Plot';
		        if (indicesChartVisible) updateIndicesChart();
		        console.log('Indices chart visibility toggled:', indicesChartVisible);
		    } catch (error) {
		        console.error('Error toggling indices chart:', error);
		        document.getElementById('indices-error').textContent = `Error toggling chart: ${error.message}`;
		        document.getElementById('indices-error').style.display = 'block';
		    }
		}

        function updateIndicesChart() {
    try {
        const startInput = document.getElementById('wisesheets-start-date').value;
        const endInput = document.getElementById('wisesheets-end-date').value;
        const startDate = startInput ? new Date(startInput) : new Date(Math.min(...indicesData.map(item => new Date(item.Date))));
        const endDate = endInput ? new Date(endInput) : new Date(Math.max(...indicesData.map(item => new Date(item.Date))));
        const dataToShow = showNormalized ? normalizedIndicesData : indicesData;
        const filteredData = dataToShow.filter(item => {
            const itemDate = new Date(item.Date);
            return itemDate >= startDate && itemDate <= endDate;
        });
        if (!filteredData.length) {
            console.warn('No data for indices chart after filtering, normalized:', showNormalized, 'date range:', startDate, endDate);
            if (indicesChart) indicesChart.destroy();
            document.getElementById('indices-error').textContent = 'No data available for chart';
            document.getElementById('indices-error').style.display = 'block';
            return;
        }
        const tickers = wisesheetsSelectedTickers.length > 0 ? wisesheetsSelectedTickers : (filteredData.length > 0 ? Object.keys(filteredData[0]).filter(key => key !== 'Date') : ['ICVT', 'CWB', 'JNK', 'HYG', 'SJNK', 'IWM']);
        if (tickers.length === 0) {
            console.warn('No tickers available for indices chart');
            if (indicesChart) indicesChart.destroy();
            document.getElementById('indices-error').textContent = 'No tickers available for chart';
            document.getElementById('indices-error').style.display = 'block';
            return;
        }
        const colors = ['#FFA500', '#00FF00', '#FF0000', '#26A69A', '#800080', '#00FFFF'];
        const datasets = tickers.map((ticker, idx) => ({
            label: ticker,
            data: filteredData.map(item => ({ x: new Date(item.Date), y: parseFloat(item[ticker]) || null })),
            borderColor: colors[idx % colors.length],
            backgroundColor: colors[idx % colors.length].startsWith('var(') ? colors[idx % colors.length] : `rgba(${parseInt(colors[idx % colors.length].slice(1,3),16)}, ${parseInt(colors[idx % colors.length].slice(3,5),16)}, ${parseInt(colors[idx % colors.length].slice(5,7),16)}, 0.2)`,
            pointRadius: 0,
            fill: false,
            showLine: true
        }));
        if (indicesChart) indicesChart.destroy();
        const canvas = document.getElementById('indices-chart');
        if (!canvas.getContext('2d')) {
            throw new Error('Canvas context not available for indices-chart');
        }
        indicesChart = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { datasets },
            options: {
                plugins: { legend: { labels: { color: getThemeColor() } } },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month' },
                        title: { display: true, text: 'Date', color: getThemeColor() },
                        min: startDate,
                        max: endDate,
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y: {
                        title: { display: true, text: showNormalized ? 'Normalized Value' : 'Price ($)', color: getThemeColor() },
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    }
                },
                backgroundColor: document.body.getAttribute('data-theme') === 'light' ? '#F5F7FA' : '#1A1A2E'
            }
        });
        document.getElementById('indices-error').style.display = 'none';
        createStatsTable(indicesChart, 'indices-chart');
        console.log('Indices chart updated, normalized:', showNormalized, 'tickers:', tickers, 'date range:', startDate.toISOString(), endDate.toISOString());
    } catch (error) {
        console.error('Error updating indices chart:', error);
        document.getElementById('indices-error').textContent = `Error rendering chart: ${error.message}`;
        document.getElementById('indices-error').style.display = 'block';
    }
}
    
        function normalizeDate(dateStr) {
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) throw new Error('Invalid date');
                return date.toLocaleDateString('en-CA');
            } catch (error) {
                console.error('Error normalizing date:', dateStr, error);
                return null;
            }
        }
    
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleButton = document.querySelector('.sidebar-toggle');
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('visible');
            mainContent.classList.toggle('sidebar-visible');
            toggleButton.textContent = sidebar.classList.contains('hidden') ? 'â˜°' : 'âœ•';
        }
    
        function toggleStatsTables() {
            try {
                statsTablesVisible = !statsTablesVisible;
                document.querySelectorAll('.stats-table:not(#historic-price-chart + .stats-table)').forEach(table => {
                    table.style.display = statsTablesVisible ? 'table' : 'none';
                });
                document.querySelector('.toggle-button:not(#ranking .toggle-button)').textContent = statsTablesVisible ? 'Hide Stats Tables' : 'Show Stats Tables';
                console.log(`Stats tables visibility set to: ${statsTablesVisible}`);
            } catch (error) {
                console.error('Error in toggleStatsTables:', error);
            }
        }
    
        function toggleRankingTable() {
            try {
                rankingTableVisible = !rankingTableVisible;
                const table = document.getElementById('ranking-table');
                table.style.display = rankingTableVisible ? 'table' : 'none';
                document.querySelector('#ranking .toggle-button').textContent = rankingTableVisible ? 'Hide Data' : 'Show Data';
                if (rankingTableVisible) updateRankingTable();
                console.log(`Ranking table visibility set to: ${rankingTableVisible}`);
            } catch (error) {
                console.error('Error in toggleRankingTable:', error);
            }
        }
    
        function toggleStockTable() {
            try {
                stockTableVisible = !stockTableVisible;
                const table = document.getElementById('stock-table');
                table.style.display = stockTableVisible ? 'table' : 'none';
                document.querySelector('#stock .toggle-button').textContent = stockTableVisible ? 'Hide Data' : 'Show Data';
                if (stockTableVisible) updateStockTable();
                console.log(`Stock table visibility set to: ${stockTableVisible}`);
            } catch (error) {
                console.error('Error in toggleStockTable:', error);
            }
        }
    
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
    
        async function loadData(timestamp) {
            try {
                const selectedTicker = document.getElementById('ticker-search').value.toUpperCase() || 'COIN';
                if (lastLoadDataTimestamp === timestamp && lastTicker === selectedTicker) {
                    console.log(`Skipping redundant loadData for ticker: ${selectedTicker}, timestamp: ${timestamp}`);
                    return Promise.resolve();
                }
                lastLoadDataTimestamp = timestamp;
                lastTicker = selectedTicker;
                clearTimeout(loadDataTimeout);
                document.getElementById('historic-error').textContent = 'Loading data, please wait...';
                document.getElementById('historic-error').style.display = 'block';
                const prefix = '_yfinance';
                console.log(`Loading data for timestamp: ${timestamp}, source: yfinance, ticker: ${selectedTicker}`);
                data = [];
                rawData = [];
                skewData = [];
                slopeData = [];
                historicData = [];
                eventsData = [];
                rankingData = [];
                companyNames = [];
                cleanedData = [];
                summaryData = [];
                topVolumeData = [];
                topOpenInterestData = [];
                stockData = [];
                normalizedData = [];
                bondsData = [];
                commoditiesData = [];
                stocksData = [];
                currenciesData = [];
                cryptoData = [];
                sharesGainersData = [];
                sharesLosersData = [];
                volSurfData = []; // Added for vol_surf.csv
        
                const checkFileExists = async (url) => {
                    try {
                        const response = await fetch(url, { method: 'HEAD' });
                        return response.ok;
                    } catch {
                        return false;
                    }
                };
        
                const companyNamesExists = await checkFileExists(`./company_names.txt`);
                if (companyNamesExists) {
                    await fetchWithErrorHandling(`./company_names.txt`, companyNames);
                    console.log('Company names loaded, size:', companyNames.length, 'sample:', companyNames.slice(0, 5));
                } else {
                    console.warn('Company names file not found: ./company_names.txt');
                }
        
                const files = [
                    { url: `data/${timestamp}/tables/ranking/ranking_table${prefix}.csv`, array: rankingData },
                    { url: `data/${timestamp}/tables/stock/stock_table${prefix}.csv`, array: stockData },
                    { url: `data/${timestamp}/tables/summary/summary_table${prefix}.csv`, array: summaryData },
                    { url: `data/${timestamp}/tables/contracts/top_volume_table${prefix}.csv`, array: topVolumeData },
                    { url: `data/${timestamp}/tables/contracts/top_open_interest_table${prefix}.csv`, array: topOpenInterestData },
                    { url: `data/${timestamp}/tables/normalized/normalized_table${prefix}.csv`, array: normalizedData },
                    { url: `data/${timestamp}/processed${prefix}/processed${prefix}_${selectedTicker}.csv`, array: data },
                    { url: `data/${timestamp}/historic/historic_${selectedTicker}.csv`, array: historicData },
                    { url: `data/${timestamp}/skew_metrics${prefix}/skew_metrics${prefix}_${selectedTicker}.csv`, array: skewData },
                    { url: `data/${timestamp}/slope_metrics${prefix}/slope_metrics${prefix}_${selectedTicker}.csv`, array: slopeData },
                    { url: `data/${timestamp}/cleaned_yfinance/cleaned_yfinance_${selectedTicker}.csv`, array: cleanedData },
                    { url: `data/${timestamp}/raw${prefix}/raw${prefix}_${selectedTicker}.csv`, array: rawData },
                    { url: `data/Events.csv`, array: eventsData },
                    { url: `data/${timestamp}/Trading_Economics/bonds.csv`, array: bondsData },
                    { url: `data/${timestamp}/Trading_Economics/commodities.csv`, array: commoditiesData },
                    { url: `data/${timestamp}/Trading_Economics/stocks.csv`, array: stocksData },
                    { url: `data/${timestamp}/Trading_Economics/currencies.csv`, array: currenciesData },
                    { url: `data/${timestamp}/Trading_Economics/crypto.csv`, array: cryptoData },
                    { url: `data/${timestamp}/Trading_Economics/shares_gainers.csv`, array: sharesGainersData },
                    { url: `data/${timestamp}/Trading_Economics/shares_losers.csv`, array: sharesLosersData },
                    { url: `data/${timestamp}/vol_surf/vol_surf.csv`, array: volSurfData } // Added vol_surf.csv
                ];
        
                const batchSize = 5;
                for (let i = 0; i < files.length; i += batchSize) {
                    const batch = files.slice(i, i + batchSize);
                    const batchPromises = batch.map(file =>
                        checkFileExists(file.url).then(exists => {
                            if (exists) {
                                return fetchWithErrorHandling(file.url, file.array).then(() => {
                                    if (file.array === data) {
                                        console.log(`Processed data for ${selectedTicker}:`, {
                                            url: file.url,
                                            size: file.array.length,
                                            sample: file.array.slice(0, 5),
                                            columns: file.array.length > 0 ? Object.keys(file.array[0]) : [],
                                            hasCalls: file.array.some(item => item.Type && item.Type.toLowerCase() === 'call')
                                        });
                                    } else if (file.array === volSurfData) {
                                        console.log(`Volatility surface data loaded:`, {
                                            url: file.url,
                                            size: file.array.length,
                                            sample: file.array.slice(0, 5),
                                            columns: file.array.length > 0 ? Object.keys(file.array[0]) : []
                                        });
                                    }
                                });
                            } else {
                                console.warn(`File not found: ${file.url}`);
                                file.array.length = 0;
                                if (file.array === data || file.array === volSurfData) {
                                    document.getElementById('surface-error').textContent = `Data file not found for ${selectedTicker}`;
                                    document.getElementById('surface-error').style.display = 'block';
                                }
                                return Promise.resolve();
                            }
                        }).catch(error => {
                            console.error(`Error checking/fetching ${file.url}:`, error);
                            file.array.length = 0;
                            if (file.array === data || file.array === volSurfData) {
                                document.getElementById('surface-error').textContent = `Error loading data for ${selectedTicker}: ${error.message}`;
                                document.getElementById('surface-error').style.display = 'block';
                            }
                            return Promise.resolve();
                        })
                    );
                    await Promise.all(batchPromises);
                }
        
                const tickerDatalist = document.getElementById('ticker-datalist');
                tickerDatalist.innerHTML = '';
                const uniqueTickers = [...new Set([...rankingData.map(item => item.Ticker), ...volSurfData.map(item => item.Ticker)])].filter(val => val).sort();
                uniqueTickers.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    tickerDatalist.appendChild(option);
                });
        
                const tickerCompareSelect = document.getElementById('ticker-compare-select');
                tickerCompareSelect.innerHTML = '';
                uniqueTickers.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    option.textContent = val;
                    tickerCompareSelect.appendChild(option);
                });
                if (uniqueTickers.includes(selectedTicker)) {
                    tickerCompareSelect.value = selectedTicker;
                }
        
                if (!uniqueTickers.includes(selectedTicker)) {
                    console.warn(`Selected ticker ${selectedTicker} not in data, defaulting`);
                    const defaultTicker = uniqueTickers.includes('COIN') ? 'COIN' : uniqueTickers[0] || '';
                    document.getElementById('ticker-search').value = defaultTicker;
                    document.getElementById('ticker-display').textContent = `${defaultTicker || 'N/A'}`;
                    if (!defaultTicker) {
                        console.warn('No valid tickers available');
                        document.getElementById('historic-error').textContent = 'No valid tickers available';
                        document.getElementById('historic-error').style.display = 'block';
                        return Promise.resolve();
                    }
                    await loadData(timestamp); // Reload for default ticker
                } else {
                    document.getElementById('ticker-display').textContent = `${selectedTicker || 'N/A'}`;
                }
        
                console.log('Data load complete:', {
                    data: data.slice(0, 5),
                    historicData: historicData.slice(0, 5),
                    skewData: skewData.slice(0, 5),
                    slopeData: slopeData.slice(0, 5),
                    rawData: rawData.slice(0, 5),
                    eventsData: eventsData.slice(0, 5),
                    rankingData: rankingData.slice(0, 5),
                    companyNames: companyNames.slice(0, 5),
                    cleanedData: cleanedData.slice(0, 5),
                    summaryData: summaryData.slice(0, 5),
                    topVolumeData: topVolumeData.slice(0, 5),
                    topOpenInterestData: topOpenInterestData.slice(0, 5),
                    stockData: stockData.slice(0, 5),
                    normalizedData: normalizedData.slice(0, 5),
                    bondsData: bondsData.slice(0, 5),
                    commoditiesData: commoditiesData.slice(0, 5),
                    stocksData: stocksData.slice(0, 5),
                    currenciesData: currenciesData.slice(0, 5),
                    cryptoData: cryptoData.slice(0, 5),
                    sharesGainersData: sharesGainersData.slice(0, 5),
                    sharesLosersData: sharesLosersData.slice(0, 5),
                    volSurfData: volSurfData.slice(0, 5)
                });
        
                document.getElementById('historic-error').style.display = 'none';
                return Promise.resolve();
            } catch (error) {
                console.error('Error in loadData:', error);
                document.getElementById('ticker-search').value = '';
                document.getElementById('ticker-datalist').innerHTML = '';
                document.getElementById('ticker-compare-select').innerHTML = '';
                document.getElementById('ticker-display').textContent = 'N/A';
                data = [];
                rawData = [];
                skewData = [];
                slopeData = [];
                historicData = [];
                eventsData = [];
                rankingData = [];
                companyNames = [];
                cleanedData = [];
                summaryData = [];
                topVolumeData = [];
                topOpenInterestData = [];
                stockData = [];
                normalizedData = [];
                bondsData = [];
                commoditiesData = [];
                stocksData = [];
                currenciesData = [];
                cryptoData = [];
                sharesGainersData = [];
                sharesLosersData = [];
                volSurfData = [];
                document.getElementById('historic-error').textContent = `Error loading data: ${error.message}`;
                document.getElementById('historic-error').style.display = 'block';
                return Promise.resolve();
            }
        }
    
        function calculateMarketSpread(ticker) {
            try {
                const selectedTicker = ticker.toUpperCase();
                console.log(`Calculating market spread for ${selectedTicker}. CleanedData length: ${cleanedData.length}`);
                if (cleanedData.length === 0) {
                    console.warn(`CleanedData is empty for ${selectedTicker}`);
                    return 'N/A';
                }
                const stockRows = cleanedData.filter(item => item.Ticker === selectedTicker && item['Bid Stock'] !== undefined && item['Ask Stock'] !== undefined);
                console.log(`Found ${stockRows.length} rows with Bid Stock and Ask Stock for ${selectedTicker}`);
                if (stockRows.length === 0) {
                    console.warn(`No stock bid/ask data found for ${selectedTicker} in cleanedData. Sample cleanedData[0]:`, cleanedData[0]);
                    return 'N/A';
                }
                const bid = parseFloat(stockRows[0]['Bid Stock']);
                const ask = parseFloat(stockRows[0]['Ask Stock']);
                console.log(`Bid for ${selectedTicker}: ${bid}, Ask: ${ask}`);
                const spread = Number.isFinite(ask) && Number.isFinite(bid) ? (ask - bid).toFixed(2) : 'N/A';
                console.log(`Market spread for ${selectedTicker}: ${spread}`);
                return spread;
            } catch (error) {
                console.error('Error calculating market spread:', error);
                return 'N/A';
            }
        }
    
        function calculateHistoricalSpreads(ticker) {
            try {
                const selectedTicker = ticker.toUpperCase();
                const filteredHistoric = historicData.filter(item => item.Ticker === selectedTicker && item.High !== undefined && item.Low !== undefined);
                if (!filteredHistoric.length) {
                    console.warn(`No OHLC data for ${selectedTicker} in historicData`);
                    return { '1y Spread': 'N/A', '3y Spread': 'N/A', '5y Spread': 'N/A' };
                }
                filteredHistoric.sort((a, b) => new Date(a.Date) - new Date(b.Date));
                const spreads = filteredHistoric.map(item => Number.isFinite(item.High) && Number.isFinite(item.Low) ? item.High - item.Low : null).filter(s => s !== null);
                if (spreads.length === 0) {
                    console.warn(`No valid spread data for ${selectedTicker} after filtering`);
                    return { '1y Spread': 'N/A', '3y Spread': 'N/A', '5y Spread': 'N/A' };
                }
                const recentSpreads = spreads.slice(-Math.min(spreads.length, 1260));
                const oneYearSpreads = recentSpreads.slice(-252);
                const threeYearSpreads = recentSpreads.slice(-756);
                const fiveYearSpreads = recentSpreads;
                const avg = arr => arr.length > 0 ? (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(2) : 'N/A';
                const result = {
                    '1y Spread': avg(oneYearSpreads),
                    '3y Spread': avg(threeYearSpreads),
                    '5y Spread': avg(fiveYearSpreads)
                };
                console.log(`Historical spreads (OHLC proxy) for ${selectedTicker}:`, result, `(Available days: ${spreads.length})`);
                return result;
            } catch (error) {
                console.error('Error calculating historical spreads:', error);
                return { '1y Spread': 'N/A', '3y Spread': 'N/A', '5y Spread': 'N/A' };
            }
        }
    
        function populateTickerSearch() {
            try {
                const tickerSearch = document.getElementById('ticker-search');
                const tickerDatalist = document.getElementById('ticker-datalist');
                tickerDatalist.innerHTML = '';
                const uniqueTickers = [...new Set(rankingData.map(item => item.Ticker))].filter(val => val).sort();
                uniqueTickers.forEach(val => {
                    const option = document.createElement('option');
                    option.value = val;
                    tickerDatalist.appendChild(option);
                });
                if (uniqueTickers.length > 0 && !tickerSearch.value) {
                    const defaultTicker = uniqueTickers.includes('COIN') ? 'COIN' : uniqueTickers[0];
                    tickerSearch.value = defaultTicker;
                    document.getElementById('ticker-display').textContent = `${defaultTicker}`;
                } else if (!uniqueTickers.length) {
                    console.warn('No tickers available for selection');
                    tickerSearch.value = '';
                    document.getElementById('ticker-display').textContent = 'N/A';
                    document.getElementById('historic-error').textContent = 'No tickers available';
                    document.getElementById('historic-error').style.display = 'block';
                }
                console.log('Ticker search populated, selected:', tickerSearch.value);
            } catch (error) {
                console.error('Error populating ticker search:', error);
                document.getElementById('historic-error').textContent = `Error populating ticker search: ${error.message}`;
                document.getElementById('historic-error').style.display = 'block';
            }
        }
    
        function updateDropdowns() {
    try {
        const tickerSearch = document.getElementById('ticker-search');
        if (!tickerSearch) throw new Error('Ticker search input not found');
        const selectedTicker = tickerSearch.value.toUpperCase() || 'COIN';
        const tickerData = data.filter(item => item.Ticker && item.Ticker.toUpperCase() === selectedTicker && item.Moneyness && item.Expiry);
        console.log('Updating dropdowns for ticker:', selectedTicker, 'Data size:', tickerData.length);
        
        const moneynessSelect = document.getElementById('moneyness-select');
        const expirySelect = document.getElementById('expiry-select');
        if (!moneynessSelect || !expirySelect) {
            throw new Error('Moneyness or expiry select element not found');
        }
        
        if (!tickerData.length) {
            console.warn('No data for dropdowns, ticker:', selectedTicker);
            moneynessSelect.innerHTML = '<option value="">No moneyness available</option>';
            expirySelect.innerHTML = '<option value="">No expiries available</option>';
            document.getElementById('surface-error').textContent = `No data available for ticker: ${selectedTicker}`;
            document.getElementById('surface-error').style.display = 'block';
            return;
        }
        
        const prevMoneyness = moneynessSelect.value || '';
        const prevExpiry = expirySelect.value || '';
        
        const uniqueRoundedMoneyness = [...new Set(tickerData
            .filter(item => Number.isFinite(parseFloat(item.Moneyness)))
            .map(item => Math.round(parseFloat(item.Moneyness) * 100) / 100))]
            .sort((a, b) => a - b);
        moneynessSelect.innerHTML = '';
        if (uniqueRoundedMoneyness.length === 0) {
            moneynessSelect.innerHTML = '<option value="">No moneyness available</option>';
            console.warn('No valid moneyness values for ticker:', selectedTicker);
        } else {
            uniqueRoundedMoneyness.forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.text = `${(val * 100).toFixed(0)}%`;
                moneynessSelect.appendChild(option);
            });
            const targetMoneyness = 1.0;
            let closestMoneyness = uniqueRoundedMoneyness[0] || 1.0;
            if (uniqueRoundedMoneyness.length > 0) {
                closestMoneyness = uniqueRoundedMoneyness.reduce((prev, curr) =>
                    Math.abs(curr - targetMoneyness) < Math.abs(prev - targetMoneyness) ? curr : prev
                );
            }
            moneynessSelect.value = prevMoneyness && uniqueRoundedMoneyness.map(String).includes(prevMoneyness) ? prevMoneyness :
                                    uniqueRoundedMoneyness.includes(targetMoneyness) ? targetMoneyness.toString() : closestMoneyness.toString();
        }
        console.log('Moneyness dropdown updated, selected:', moneynessSelect.value);
        
        const datasetDate = new Date(document.getElementById('date-select').value.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
        uniqueExpiries = [...new Set(tickerData
            .filter(item => item.Expiry && !isNaN(new Date(item.Expiry).getTime()))
            .map(item => item.Expiry))]
            .sort((a, b) => new Date(a) - new Date(b));
        expirySelect.innerHTML = '';
        if (uniqueExpiries.length === 0) {
            expirySelect.innerHTML = '<option value="">No expiries available</option>';
            console.warn('No valid expiries found for ticker:', selectedTicker);
        } else {
            uniqueExpiries.forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.text = new Date(val).toLocaleDateString('en-GB');
                expirySelect.appendChild(option);
            });
            const targetExpiry = new Date(datasetDate);
            targetExpiry.setDate(targetExpiry.getDate() + 90);
            let closestExpiry = uniqueExpiries[0];
            let minDiff = Infinity;
            uniqueExpiries.forEach(expiry => {
                const expiryDate = new Date(expiry);
                const diffDays = Math.abs((expiryDate - targetExpiry) / (1000 * 60 * 60 * 24));
                if (diffDays < minDiff) {
                    minDiff = diffDays;
                    closestExpiry = expiry;
                }
            });
            expirySelect.value = prevExpiry && uniqueExpiries.includes(prevExpiry) ? prevExpiry : closestExpiry || '';
        }
        console.log('Expiry dropdown updated, selected:', expirySelect.value);
        
        // Update sliders based on data ranges with minimum defaults
        const moneynessSlider = document.getElementById('moneyness-slider');
        const expiryTSlider = document.getElementById('expiry-t-slider');
        if (uniqueRoundedMoneyness.length > 0) {
            let minMoneyness = Math.max(0.5, Math.min(...uniqueRoundedMoneyness));
            let maxMoneyness = Math.max(...uniqueRoundedMoneyness);
            moneynessSlider.noUiSlider.updateOptions({
                range: { min: minMoneyness, max: maxMoneyness + 0.1 },
                start: [minMoneyness, maxMoneyness]
            });
            document.getElementById('moneyness-value').textContent = `${minMoneyness.toFixed(1)} - ${maxMoneyness.toFixed(1)}`;
            console.log('Moneyness slider updated:', { min: minMoneyness, max: maxMoneyness });
        } else {
            moneynessSlider.noUiSlider.updateOptions({
                range: { min: 0.5, max: 3 },
                start: [0.5, 2.5]
            });
            document.getElementById('moneyness-value').textContent = '0.5 - 2.5';
            console.log('Moneyness slider set to default:', { min: 0.5, max: 2.5 });
        }
        if (uniqueExpiries.length > 0) {
            const expiryTimes = uniqueExpiries.map(exp => calculateTimeToExpiry(exp, datasetDate)).filter(t => Number.isFinite(t));
            if (expiryTimes.length > 0) {
                let minExpiryT = Math.max(0.25, Math.min(...expiryTimes));
                let maxExpiryT = Math.max(...expiryTimes);
                expiryTSlider.noUiSlider.updateOptions({
                    range: { min: minExpiryT, max: maxExpiryT + 0.1 },
                    start: [minExpiryT, maxExpiryT]
                });
                document.getElementById('expiry-t-value').textContent = `${minExpiryT.toFixed(1)} - ${maxExpiryT.toFixed(1)}`;
                console.log('Expiry slider updated:', { min: minExpiryT, max: maxExpiryT });
            } else {
                expiryTSlider.noUiSlider.updateOptions({
                    range: { min: 0.25, max: 5 },
                    start: [0.25, 5]
                });
                document.getElementById('expiry-t-value').textContent = '0.25 - 5.0';
                console.log('Expiry slider set to default:', { min: 0.25, max: 5 });
            }
        } else {
            expiryTSlider.noUiSlider.updateOptions({
                range: { min: 0.25, max: 5 },
                start: [0.25, 5]
            });
            document.getElementById('expiry-t-value').textContent = '0.25 - 5.0';
            console.log('Expiry slider set to default:', { min: 0.25, max: 5 });
        }
        
        if (uniqueExpiries.length > 0) {
            const minExpDate = new Date(Math.min(...uniqueExpiries.map(e => new Date(e))));
            const maxExpDate = new Date(Math.max(...uniqueExpiries.map(e => new Date(e))));
            const minExpStr = minExpDate.toISOString().split('T')[0];
            const maxExpStr = maxExpDate.toISOString().split('T')[0];
            document.getElementById('term-min-expiry').value = minExpStr;
            document.getElementById('term-max-expiry').value = maxExpStr;
            document.getElementById('skew-min-expiry').value = minExpStr;
            document.getElementById('skew-max-expiry').value = maxExpStr;
        }
        
        if (historicData.length > 0) {
            const minHistDate = new Date(Math.min(...historicData.map(item => new Date(item.Date))));
            const maxHistDate = new Date(Math.max(...historicData.map(item => new Date(item.Date))));
            const minHistStr = minHistDate.toISOString().split('T')[0];
            const maxHistStr = maxHistDate.toISOString().split('T')[0];
            document.getElementById('historic-start-date').value = minHistStr;
            document.getElementById('historic-end-date').value = maxHistStr;
            document.getElementById('realised-start-date').value = minHistStr;
            document.getElementById('realised-end-date').value = maxHistStr;
            document.getElementById('kurtosis-start-date').value = minHistStr;
            document.getElementById('kurtosis-end-date').value = maxHistStr;
            document.getElementById('volofvol-start-date').value = minHistStr;
            document.getElementById('volofvol-end-date').value = maxHistStr;
        }
    } catch (error) {
        console.error('Error updating dropdowns:', error);
        document.getElementById('surface-error').textContent = `Error updating dropdowns: ${error.message}`;
        document.getElementById('surface-error').style.display = 'block';
        // Set sliders to defaults on error
        const moneynessSlider = document.getElementById('moneyness-slider');
        const expiryTSlider = document.getElementById('expiry-t-slider');
        moneynessSlider.noUiSlider.updateOptions({
            range: { min: 0.5, max: 3 },
            start: [0.5, 2.5]
        });
        document.getElementById('moneyness-value').textContent = '0.5 - 2.5';
        expiryTSlider.noUiSlider.updateOptions({
            range: { min: 0.25, max: 5 },
            start: [0.25, 5]
        });
        document.getElementById('expiry-t-value').textContent = '0.25 - 5.0';
        console.log('Sliders reset to defaults on error:', { moneyness: '0.5 - 2.5', expiry: '0.25 - 5.0' });
    }
}
    
        function updateSkewVsExpiry() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
        const datasetDate = new Date(document.getElementById('date-select').value.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
        const skewMinInput = document.getElementById('skew-min-expiry').value;
        const skewMaxInput = document.getElementById('skew-max-expiry').value;
        const skewMin = skewMinInput ? calculateTimeToExpiry(skewMinInput, datasetDate) : 0.1;
        const skewMax = skewMaxInput ? calculateTimeToExpiry(skewMaxInput, datasetDate) : 5.0;
        let filteredSkewData = skewData.filter(item => item.Ticker === selectedTicker && Number.isFinite(item.T) && item.T >= skewMin && item.T <= skewMax);
        const errorDiv = document.getElementById('skew-error');
        errorDiv.style.display = 'none';
        if (!filteredSkewData.length) {
            console.warn('No data for Skew vs. Expiry chart:', { ticker: selectedTicker, skewMin, skewMax });
            if (skewChart) skewChart.destroy();
            errorDiv.textContent = 'No skew data available';
            errorDiv.style.display = 'block';
            return;
        }
        const skewSelect = document.getElementById('skew-metric-select');
        const selectedMetrics = Array.from(skewSelect.selectedOptions).map(opt => opt.value);
        if (selectedMetrics.length === 0) {
            selectedMetrics.push('Skew_90_Moneyness', 'Skew_80_Moneyness', 'Skew_70_Moneyness', 'Skew_90_Moneyness_Vol', 'Skew_80_Moneyness_Vol', 'Skew_70_Moneyness_Vol', 'ATM_12m_3m_Ratio');
        }
        const colors = ['#FFA500', '#00FF00', '#FF0000', '#26A69A', '#800080', '#00FFFF', '#FF69B4'];
        const datasets = selectedMetrics.map((metric, idx) => ({
            label: metric.replace(/_/g, ' ').replace('Moneyness', 'M').replace('Vol', 'Vol Ratio'),
            data: filteredSkewData
                .filter(item => Number.isFinite(item[metric]) && item[metric] !== null)
                .map(item => ({
                    x: item.T,
                    y: metric.includes('Vol') || metric.includes('Ratio') ? item[metric] * 100 : item[metric]
                }))
                .sort((a, b) => a.x - b.x),
            borderColor: colors[idx % colors.length],
            backgroundColor: colors[idx % colors.length].startsWith('var(') ? colors[idx % colors.length] : `rgba(${parseInt(colors[idx % colors.length].slice(1,3),16)}, ${parseInt(colors[idx % colors.length].slice(3,5),16)}, ${parseInt(colors[idx % colors.length].slice(5,7),16)}, 0.2)`,
            pointRadius: 3,
            pointStyle: 'circle',
            fill: true,
            showLine: true,
            borderDash: [],
            yAxisID: metric.includes('Vol') || metric.includes('Ratio') ? 'y1' : 'y'
        }));
        if (datasets.length === 0 || datasets.every(ds => ds.data.length === 0)) {
            console.warn('No valid data points for selected skew metrics:', selectedMetrics);
            if (skewChart) skewChart.destroy();
            errorDiv.textContent = 'No valid data for selected skew metrics';
            errorDiv.style.display = 'block';
            return;
        }
        if (skewChart) skewChart.destroy();
        const canvas = document.getElementById('skew-vs-expiry-chart');
        if (!canvas.getContext('2d')) {
            throw new Error('Canvas context not available for skew-vs-expiry-chart');
        }
        skewChart = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { datasets },
            options: {
                plugins: { legend: { labels: { color: getThemeColor() } } },
                scales: {
                    x: {
                        type: 'linear',
                        title: { display: true, text: 'Time to Expiry (Years)', color: getThemeColor() },
                        min: skewMin,
                        max: skewMax,
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y: {
                        title: { display: true, text: 'Skew Moneyness (K/S)', color: getThemeColor() },
                        beginAtZero: false,
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y1: {
                        title: { display: true, text: 'Skew Vol Ratio (%)', color: getThemeColor() },
                        position: 'right',
                        beginAtZero: false,
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    }
                },
                backgroundColor: document.body.getAttribute('data-theme') === 'light' ? '#F5F7FA' : '#1A1A2E'
            }
        });
        createStatsTable(skewChart, 'skew-vs-expiry-chart');
    } catch (error) {
        console.error('Error updating Skew vs Expiry chart:', error);
        document.getElementById('skew-error').textContent = `Error rendering chart: ${error.message}`;
        document.getElementById('skew-error').style.display = 'block';
    }
}
    
        function updateSummaryTable() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase() || 'COIN';
        const table = document.getElementById('summary-table');
        table.innerHTML = '';
        const filteredData = summaryData.filter(row => row.Ticker === selectedTicker);
        if (filteredData.length === 0) {
            table.innerHTML = '<tr><td colspan="2">No summary data available</td></tr>';
            console.warn('No summary data for ticker:', selectedTicker);
            return;
        }
        const row = filteredData[0];
        const thead = document.createElement('thead');
        const headerRow = thead.insertRow();
        ['Metric', 'Value'].forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            th.style.textAlign = col === 'Metric' ? 'left' : 'right';
            headerRow.appendChild(th);
        });
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        const metrics = [
            'Latest Close ($)', 'Open ($)', 'Low ($)', 'High ($)', 'Daily Volume',
            'Close 1d (%)', 'Close 1w (%)', 'Realised Volatility 100d (%)',
            'Weighted IV (%)', 'Weighted IV 1d (%)', 'Weighted IV 1w (%)',
            'Volume 1d (%)', 'Volume 1w (%)', 'Open Interest', 'OI 1d (%)',
            'OI 1w (%)', 'ATM 12m/3m Ratio', 'Volume Rank', 'Open Interest Rank'
        ];
        const displayNameMap = {
            'Realised Volatility 100d (%)': 'RVol 100d (%)',
            'Weighted IV (%)': 'WIVol (%)',
            'Weighted IV 1d (%)': 'WIVol 1d (%)',
            'Weighted IV 1w (%)': 'WIVol 1w (%)',
            'ATM 12m/3m Ratio': 'ATM 12m/3m Ratio',
            'Volume Rank': 'Volume Rank',
            'Open Interest Rank': 'Open Interest Rank'
        };
        metrics.forEach(metric => {
            const tr = tbody.insertRow();
            const metricCell = tr.insertCell();
            metricCell.textContent = displayNameMap[metric] || metric.replace(/Realised Volatility/g, 'RVol').replace(/Weighted IV/g, 'WIVol').replace(/IV/g, 'IVol');
            metricCell.style.textAlign = 'left';
            const valueCell = tr.insertCell();
            let value = row[metric];
            if (Number.isFinite(value)) {
                if (metric === 'Daily Volume' || metric === 'Open Interest') {
                    value = parseInt(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                } else {
                    value = value.toFixed(2);
                }
            } else {
                value = value || 'N/A';
            }
            valueCell.textContent = value;
            valueCell.style.textAlign = 'right';
            const isPercentChange = [
                'Close 1d (%)', 'Close 1w (%)', 'Weighted IV 1d (%)', 'Weighted IV 1w (%)',
                'Volume 1d (%)', 'Volume 1w (%)', 'OI 1d (%)', 'OI 1w (%)'
            ].includes(metric);
            valueCell.style.color = isPercentChange && Number.isFinite(parseFloat(value)) && value !== 'N/A'
                ? (parseFloat(value) < 0 ? 'var(--highlight-negative)' : parseFloat(value) > 0 ? 'var(--highlight-positive)' : 'var(--text-color)')
                : 'var(--text-color)';
        });
        table.appendChild(tbody);
        console.log('Summary table updated with metrics:', metrics.map(m => ({ name: m, value: row[m] || 'N/A' })));
    } catch (error) {
        console.error('Error updating summary table:', error);
        document.getElementById('summary-table').innerHTML = '<tr><td colspan="2">Error loading summary data</td></tr>';
    }
}
    
        function updateRankingTable() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase() || 'COIN';
        const table = document.getElementById('ranking-table');
        table.innerHTML = '';
        if (rankingData.length === 0) {
            table.innerHTML = '<tr><td colspan="31">No ranking data available</td></tr>';
            console.warn('No ranking data for ranking table');
            return;
        }
        const thead = document.createElement('thead');
        const headerRow = thead.insertRow();
        const columns = [
            'Rank', 'Ticker', 'Latest Close', 'Realised Volatility 30d (%)',
            'Realised Volatility 100d (%)', 'Realised Volatility 100d 1d (%)',
            'Realised Volatility 100d 1w (%)', 'Min Realised Volatility 100d (2y)',
            'Max Realised Volatility 100d (2y)', 'Mean Realised Volatility 100d (2y)',
            'Rvol 100d Percentile 2y (%)', 'Rvol 100d Z-Score Percentile 2y (%)',
            'Realised Volatility 180d (%)', 'Realised Volatility 252d (%)',
            'Weighted IV (%)', 'Weighted IV 1d (%)', 'Weighted IV 1w (%)',
            'Weighted IV 3m (%)', 'Weighted IV 3m 1d (%)', 'Weighted IV 3m 1w (%)',
            'ATM IV 3m (%)', 'ATM IV 3m 1d (%)', 'ATM IV 3m 1w (%)',
            'Rvol100d - Weighted IV', 'Volume', 'Volume 1d (%)', 'Volume 1w (%)',
            'Open Interest', 'OI 1d (%)', 'OI 1w (%)', 'Num Contracts'
        ];
        const displayNameMap = {
            'Realised Volatility 30d (%)': 'RVol\n30d (%)',
            'Realised Volatility 100d (%)': 'RVol\n100d (%)',
            'Realised Volatility 100d 1d (%)': 'RVol\n100d 1d (%)',
            'Realised Volatility 100d 1w (%)': 'RVol\n100d 1w (%)',
            'Min Realised Volatility 100d (2y)': 'Min RVol\n100d (2y)',
            'Max Realised Volatility 100d (2y)': 'Max RVol\n100d (2y)',
            'Mean Realised Volatility 100d (2y)': 'Mean RVol\n100d (2y)',
            'Rvol 100d Percentile 2y (%)': 'RVol 100d\nPercentile 2y (%)',
            'Rvol 100d Z-Score Percentile 2y (%)': 'RVol 100d\nZ-Score\nPercentile 2y (%)',
            'Realised Volatility 180d (%)': 'RVol\n180d (%)',
            'Realised Volatility 252d (%)': 'RVol\n252d (%)',
            'Weighted IV (%)': 'WIVol\n(%)',
            'Weighted IV 1d (%)': 'WIVol\n1d (%)',
            'Weighted IV 1w (%)': 'WIVol\n1w (%)',
            'Weighted IV 3m (%)': 'WIVol\n3m (%)',
            'Weighted IV 3m 1d (%)': 'WIVol\n3m 1d (%)',
            'Weighted IV 3m 1w (%)': 'WIVol\n3m 1w (%)',
            'ATM IV 3m (%)': 'ATM IVol\n3m (%)',
            'ATM IV 3m 1d (%)': 'ATM IVol\n3m 1d (%)',
            'ATM IV 3m 1w (%)': 'ATM IVol\n3m 1w (%)',
            'Rvol100d - Weighted IV': 'RVol100d -\nWIVol',
            'Num Contracts': 'Num\nContracts'
        };
        columns.forEach((col, index) => {
            const th = document.createElement('th');
            th.textContent = displayNameMap[col] || col.replace(/Realised Volatility/g, 'RVol').replace(/Weighted IV/g, 'WIVol').replace(/IV/g, 'IVol').replace(/ /g, '\n');
            th.dataset.column = col;
            th.dataset.order = 'desc';
            th.addEventListener('click', () => sortTable('ranking-table', index));
            headerRow.appendChild(th);
        });
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        rankingData.forEach(item => {
            const row = tbody.insertRow();
            if (item.Ticker === selectedTicker) {
                row.classList.add('selected-ticker-row');
            }
            columns.forEach(col => {
                const cell = row.insertCell();
                let value = item[col];
                if (Number.isFinite(value)) {
                    if (col === 'Volume' || col === 'Open Interest' || col === 'Num Contracts') {
                        value = parseInt(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    } else if (col === 'Rank') {
                        value = parseInt(value);
                    } else {
                        value = value.toFixed(2);
                    }
                } else {
                    value = value || 'N/A';
                }
                cell.textContent = value;
                const isPercentChange = [
                    'Realised Volatility 100d 1d (%)', 'Realised Volatility 100d 1w (%)',
                    'Weighted IV 1d (%)', 'Weighted IV 1w (%)', 'Weighted IV 3m 1d (%)',
                    'Weighted IV 3m 1w (%)', 'ATM IV 3m 1d (%)', 'ATM IV 3m 1w (%)',
                    'Rvol100d - Weighted IV', 'Volume 1d (%)', 'Volume 1w (%)',
                    'OI 1d (%)', 'OI 1w (%)'
                ].includes(col);
                cell.style.color = isPercentChange && Number.isFinite(parseFloat(item[col])) && item[col] !== 'N/A'
                    ? (parseFloat(item[col]) < 0 ? 'var(--highlight-negative)' : parseFloat(item[col]) > 0 ? 'var(--highlight-positive)' : 'var(--text-color)')
                    : 'var(--text-color)';
            });
        });
        table.appendChild(tbody);
        console.log('Ranking table updated successfully');
    } catch (error) {
        console.error('Error updating ranking table:', error);
        document.getElementById('ranking-table').innerHTML = '<tr><td colspan="31">Error loading ranking data</td></tr>';
    }
}
    
        function updateSelectedTickerSummary() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase() || 'COIN';
        const table = document.getElementById('selected-ticker-table');
        table.innerHTML = '';
        const selectedRow = rankingData.find(item => item.Ticker === selectedTicker);
        if (!selectedRow) {
            table.innerHTML = '<tr><td colspan="31">No ranking data for selected ticker</td></tr>';
            console.warn('No ranking data for selected ticker:', selectedTicker);
            return;
        }
        const thead = document.createElement('thead');
        const headerRow = thead.insertRow();
        const columns = [
            'Rank', 'Ticker', 'Latest Close', 'Realised Volatility 30d (%)',
            'Realised Volatility 100d (%)', 'Realised Volatility 100d 1d (%)',
            'Realised Volatility 100d 1w (%)', 'Min Realised Volatility 100d (2y)',
            'Max Realised Volatility 100d (2y)', 'Mean Realised Volatility 100d (2y)',
            'Rvol 100d Percentile 2y (%)', 'Rvol 100d Z-Score Percentile 2y (%)',
            'Realised Volatility 180d (%)', 'Realised Volatility 252d (%)',
            'Weighted IV (%)', 'Weighted IV 1d (%)', 'Weighted IV 1w (%)',
            'Weighted IV 3m (%)', 'Weighted IV 3m 1d (%)', 'Weighted IV 3m 1w (%)',
            'ATM IV 3m (%)', 'ATM IV 3m 1d (%)', 'ATM IV 3m 1w (%)',
            'Rvol100d - Weighted IV', 'Volume', 'Volume 1d (%)', 'Volume 1w (%)',
            'Open Interest', 'OI 1d (%)', 'OI 1w (%)', 'Num Contracts'
        ];
        const displayNameMap = {
            'Realised Volatility 30d (%)': 'RVol\n30d (%)',
            'Realised Volatility 100d (%)': 'RVol\n100d (%)',
            'Realised Volatility 100d 1d (%)': 'RVol\n100d 1d (%)',
            'Realised Volatility 100d 1w (%)': 'RVol\n100d 1w (%)',
            'Min Realised Volatility 100d (2y)': 'Min RVol\n100d (2y)',
            'Max Realised Volatility 100d (2y)': 'Max RVol\n100d (2y)',
            'Mean Realised Volatility 100d (2y)': 'Mean RVol\n100d (2y)',
            'Rvol 100d Percentile 2y (%)': 'RVol 100d\nPercentile 2y (%)',
            'Rvol 100d Z-Score Percentile 2y (%)': 'RVol 100d\nZ-Score\nPercentile 2y (%)',
            'Realised Volatility 180d (%)': 'RVol\n180d (%)',
            'Realised Volatility 252d (%)': 'RVol\n252d (%)',
            'Weighted IV (%)': 'WIVol\n(%)',
            'Weighted IV 1d (%)': 'WIVol\n1d (%)',
            'Weighted IV 1w (%)': 'WIVol\n1w (%)',
            'Weighted IV 3m (%)': 'WIVol\n3m (%)',
            'Weighted IV 3m 1d (%)': 'WIVol\n3m 1d (%)',
            'Weighted IV 3m 1w (%)': 'WIVol\n3m 1w (%)',
            'ATM IV 3m (%)': 'ATM IVol\n3m (%)',
            'ATM IV 3m 1d (%)': 'ATM IVol\n3m 1d (%)',
            'ATM IV 3m 1w (%)': 'ATM IVol\n3m 1w (%)',
            'Rvol100d - Weighted IV': 'RVol100d -\nWIVol',
            'Num Contracts': 'Num\nContracts'
        };
        columns.forEach((col, index) => {
            const th = document.createElement('th');
            th.textContent = displayNameMap[col] || col.replace(/Realised Volatility/g, 'RVol').replace(/Weighted IV/g, 'WIVol').replace(/IV/g, 'IVol').replace(/ /g, '\n');
            th.dataset.column = col;
            th.dataset.order = 'desc';
            headerRow.appendChild(th);
        });
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        const row = tbody.insertRow();
        row.classList.add('selected-ticker-row');
        columns.forEach(col => {
            const cell = row.insertCell();
            let value = selectedRow[col];
            if (Number.isFinite(value)) {
                if (col === 'Volume' || col === 'Open Interest' || col === 'Num Contracts') {
                    value = parseInt(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                } else if (col === 'Rank') {
                    value = parseInt(value);
                } else {
                    value = value.toFixed(2);
                }
            } else {
                value = value || 'N/A';
            }
            cell.textContent = value;
            const isPercentChange = [
                'Realised Volatility 100d 1d (%)', 'Realised Volatility 100d 1w (%)',
                'Weighted IV 1d (%)', 'Weighted IV 1w (%)', 'Weighted IV 3m 1d (%)',
                'Weighted IV 3m 1w (%)', 'ATM IV 3m 1d (%)', 'ATM IV 3m 1w (%)',
                'Rvol100d - Weighted IV', 'Volume 1d (%)', 'Volume 1w (%)',
                'OI 1d (%)', 'OI 1w (%)'
            ].includes(col);
            cell.style.color = isPercentChange && Number.isFinite(parseFloat(selectedRow[col])) && selectedRow[col] !== 'N/A'
                ? (parseFloat(selectedRow[col]) < 0 ? 'var(--highlight-negative)' : parseFloat(selectedRow[col]) > 0 ? 'var(--highlight-positive)' : 'var(--text-color)')
                : 'var(--text-color)';
        });
        table.appendChild(tbody);
        console.log('Selected ticker summary table updated for:', selectedTicker);
    } catch (error) {
        console.error('Error updating selected ticker summary table:', error);
        document.getElementById('selected-ticker-table').innerHTML = '<tr><td colspan="31">Error loading selected ticker data</td></tr>';
    }
}
    
        function updateStockTable() {
    try {
        const table = document.getElementById('stock-table');
        table.innerHTML = '';
        if (stockData.length === 0) {
            table.innerHTML = '<tr><td colspan="17">No stock data available</td></tr>';
            console.warn('No stock data for stock table');
            return;
        }
        const thead = document.createElement('thead');
        const headerRow = thead.insertRow();
        const columns = [
            'Ticker', 'Company Name', 'Latest Open', 'Latest Close', 'Latest High',
            'Latest Low', 'Open 1d (%)', 'Open 1w (%)', 'Close 1d (%)', 'Close 1w (%)',
            'High 1d (%)', 'High 1w (%)', 'Low 1d (%)', 'Low 1w (%)',
            'Spread 1Y', 'Spread 3Y', 'Spread 5Y'
        ];
        const displayNameMap = {
            'Spread 1Y': 'Spread\n1Y',
            'Spread 3Y': 'Spread\n3Y',
            'Spread 5Y': 'Spread\n5Y'
        };
        columns.forEach((col, index) => {
            const th = document.createElement('th');
            th.textContent = displayNameMap[col] || col.replace(/Realised Volatility/g, 'RVol').replace(/Weighted IV/g, 'WIVol').replace(/IV/g, 'IVol');
            th.dataset.column = col;
            th.dataset.order = 'desc';
            th.addEventListener('click', () => sortTable('stock-table', index));
            headerRow.appendChild(th);
        });
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        stockData.forEach(item => {
            const row = tbody.insertRow();
            columns.forEach(col => {
                const cell = row.insertCell();
                let value = item[col];
                if (Number.isFinite(value)) {
                    value = value.toFixed(2);
                } else {
                    value = value || 'N/A';
                }
                cell.textContent = value;
                const isPercentChange = [
                    'Open 1d (%)', 'Open 1w (%)', 'Close 1d (%)', 'Close 1w (%)',
                    'High 1d (%)', 'High 1w (%)', 'Low 1d (%)', 'Low 1w (%)'
                ].includes(col);
                cell.style.color = isPercentChange && Number.isFinite(parseFloat(item[col])) && item[col] !== 'N/A'
                    ? (parseFloat(item[col]) < 0 ? 'var(--highlight-negative)' : parseFloat(item[col]) > 0 ? 'var(--highlight-positive)' : 'var(--text-color)')
                    : 'var(--text-color)';
            });
        });
        table.appendChild(tbody);
        console.log('Stock table updated successfully');
    } catch (error) {
        console.error('Error updating stock table:', error);
        document.getElementById('stock-table').innerHTML = '<tr><td colspan="17">Error loading stock data</td></tr>';
    }
}
    
        function togglePriceComparisonsTable() {
            try {
                normalizedTableVisible = !normalizedTableVisible;
                const table = document.getElementById('normalized-table');
                table.style.display = normalizedTableVisible ? 'table' : 'none';
                document.querySelector('#price-comparisons .toggle-button').textContent = normalizedTableVisible ? 'Hide Data' : 'Show Data';
                if (normalizedTableVisible) updateNormalizedTable();
                console.log(`Normalized table visibility set to: ${normalizedTableVisible}`);
            } catch (error) {
                console.error('Error in togglePriceComparisonsTable:', error);
            }
        }
    
        function updateNormalizedTable() {
    try {
        const tickerCompareSelect = document.getElementById('ticker-compare-select');
        const selectedTickers = Array.from(tickerCompareSelect.selectedOptions).map(opt => opt.value.toUpperCase());
        const table = document.getElementById('normalized-table');
        table.innerHTML = '';
        if (normalizedData.length === 0) {
            table.innerHTML = '<tr><td colspan="4">No normalized data available</td></tr>';
            console.warn('No normalized data for normalized table');
            return;
        }
        const thead = document.createElement('thead');
        const headerRow = thead.insertRow();
        const columns = ['Ticker', 'Normalized 3m', 'Normalized 6m', 'Normalized 1y'];
        columns.forEach((col, index) => {
            const th = document.createElement('th');
            th.textContent = col;
            th.dataset.column = col;
            th.dataset.order = 'desc';
            th.addEventListener('click', () => sortTable('normalized-table', index));
            headerRow.appendChild(th);
        });
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        const filteredData = selectedTickers.length > 0
            ? normalizedData.filter(item => selectedTickers.includes(item.Ticker))
            : normalizedData;
        if (filteredData.length === 0) {
            table.innerHTML = '<tr><td colspan="4">No data for selected tickers</td></tr>';
            console.warn('No data for selected tickers:', selectedTickers);
            return;
        }
        filteredData.forEach(item => {
            const row = tbody.insertRow();
            columns.forEach(col => {
                const cell = row.insertCell();
                let value = item[col];
                if (Number.isFinite(value)) {
                    value = value.toFixed(2);
                } else {
                    value = value || 'N/A';
                }
                cell.textContent = value;
                const isPercentChange = ['Normalized 3m', 'Normalized 6m', 'Normalized 1y'].includes(col);
                cell.style.color = isPercentChange && Number.isFinite(parseFloat(item[col])) && item[col] !== 'N/A'
                    ? (parseFloat(item[col]) < 0 ? 'var(--highlight-negative)' : parseFloat(item[col]) > 0 ? 'var(--highlight-positive)' : 'var(--text-color)')
                    : 'var(--text-color)';
            });
        });
        table.appendChild(tbody);
        console.log('Normalized table updated successfully for tickers:', selectedTickers);
    } catch (error) {
        console.error('Error updating normalized table:', error);
        document.getElementById('normalized-table').innerHTML = '<tr><td colspan="4">Error loading normalized data</td></tr>';
    }
}
    
        function updateTopContractsTables() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase() || 'COIN';
        const volumeTable = document.getElementById('top-volume-table');
        const openInterestTable = document.getElementById('top-open-interest-table');
        volumeTable.innerHTML = '';
        openInterestTable.innerHTML = '';
        const tables = [
            { table: volumeTable, data: topVolumeData.filter(row => row.Ticker === selectedTicker), id: 'top-volume-table' },
            { table: openInterestTable, data: topOpenInterestData.filter(row => row.Ticker === selectedTicker), id: 'top-open-interest-table' }
        ];
        const formatDate = (dateStr) => {
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    console.warn(`Invalid date format for expiry: ${dateStr}`);
                    return dateStr || 'N/A';
                }
                return date.toLocaleDateString('en-GB');
            } catch {
                console.warn(`Error parsing date: ${dateStr}`);
                return dateStr || 'N/A';
            }
        };
        tables.forEach(({ table, data, id }) => {
            if (data.length === 0) {
                table.innerHTML = `<tr><td colspan="7">No ${id.includes('volume') ? 'volume' : 'open interest'} data available for ${selectedTicker}</td></tr>`;
                console.warn(`No ${id.includes('volume') ? 'volume' : 'open interest'} data for ticker: ${selectedTicker}`);
                return;
            }
            const thead = document.createElement('thead');
            const headerRow = thead.insertRow();
            const columns = ['Ticker', 'Strike', 'Expiry', 'Type', 'Bid', 'Ask', 'Volume', 'Open Interest'];
            columns.forEach((col, index) => {
                const th = document.createElement('th');
                th.textContent = col;
                th.dataset.column = col;
                th.dataset.order = 'desc';
                th.addEventListener('click', () => sortTable(id, index));
                headerRow.appendChild(th);
            });
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            data.forEach(item => {
                const row = tbody.insertRow();
                columns.forEach(col => {
                    const cell = row.insertCell();
                    let value = item[col];
                    if (Number.isFinite(value)) {
                        if (col === 'Volume' || col === 'Open Interest') {
                            value = parseInt(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                        } else {
                            value = value.toFixed(2);
                        }
                    } else if (col === 'Expiry' && value) {
                        value = formatDate(value);
                    } else {
                        value = value || 'N/A';
                    }
                    cell.textContent = value;
                    cell.style.color = 'var(--text-color)';
                });
            });
            table.appendChild(tbody);
        });
        console.log('Top contracts tables updated:', { topVolume: topVolumeData.length, topOpenInterest: topOpenInterestData.length });
    } catch (error) {
        console.error('Error updating top contracts tables:', error);
        document.getElementById('top-volume-table').innerHTML = '<tr><td colspan="7">Error loading volume data</td></tr>';
        document.getElementById('top-open-interest-table').innerHTML = '<tr><td colspan="7">Error loading open interest data</td></tr>';
    }
}
    
        function updateRawDataTable() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase() || 'COIN';
        const table = document.getElementById('raw-data-table');
        table.innerHTML = '';
        const filteredData = rawData.filter(row => row.Ticker === selectedTicker);
        if (filteredData.length === 0) {
            const row = table.insertRow();
            const cell = row.insertCell();
            cell.textContent = `No raw data available for ${selectedTicker}`;
            cell.colSpan = 10;
            console.warn(`No raw data for ticker: ${selectedTicker}`);
            return;
        }
        const thead = document.createElement('thead');
        const headerRow = thead.insertRow();
        const columns = Object.keys(filteredData[0]);
        columns.forEach((text, index) => {
            const th = document.createElement('th');
            th.textContent = text;
            th.dataset.column = text;
            th.dataset.order = 'desc';
            th.addEventListener('click', () => sortTable('raw-data-table', index));
            headerRow.appendChild(th);
        });
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        filteredData.forEach(item => {
            const row = tbody.insertRow();
            columns.forEach(col => {
                const cell = row.insertCell();
                let value = item[col];
                if (Number.isFinite(value)) {
                    if (col === 'Volume' || col === 'Open Interest') {
                        value = parseInt(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    } else {
                        value = value.toFixed(2);
                    }
                } else if (col === 'Expiry' && value) {
                    try {
                        const date = new Date(value);
                        value = isNaN(date.getTime()) ? value : date.toLocaleDateString('en-GB');
                    } catch {
                        value = value || 'N/A';
                    }
                } else {
                    value = value || 'N/A';
                }
                cell.textContent = value;
                cell.style.color = 'var(--text-color)';
            });
        });
        table.appendChild(tbody);
        console.log('Raw data table updated successfully for ticker:', selectedTicker);
    } catch (error) {
        console.error('Error updating raw data table:', error);
        document.getElementById('raw-data-table').innerHTML = '<tr><td colspan="10">Error loading raw data table</td></tr>';
    }
}
    
        function sortTable(tableId, columnIndex) {
            try {
                const table = document.getElementById(tableId);
                const header = table.querySelector('thead tr').children[columnIndex];
                const column = header.dataset.column;
                const order = header.dataset.order === 'desc' ? 'asc' : 'desc';
                header.dataset.order = order;
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.sort((a, b) => {
                    let aValue = a.children[columnIndex].textContent;
                    let bValue = b.children[columnIndex].textContent;
                    if (aValue === 'N/A') return 1;
                    if (bValue === 'N/A') return -1;
                    if (column === 'Volume' || column === 'Open Interest' || column === 'Num Contracts') {
                        aValue = parseInt(aValue.replace(/,/g, '')) || -Infinity;
                        bValue = parseInt(bValue.replace(/,/g, '')) || -Infinity;
                    } else if (column === 'Rank') {
                        aValue = parseInt(aValue);
                        bValue = parseInt(bValue);
                    } else {
                        aValue = parseFloat(aValue) || aValue;
                        bValue = parseFloat(bValue) || bValue;
                    }
                    if (typeof aValue === 'number' && typeof bValue === 'number') {
                        return order === 'desc' ? bValue - aValue : aValue - bValue;
                    }
                    return order === 'desc' ? bValue.localeCompare(aValue) : aValue.localeCompare(bValue);
                });
                tbody.innerHTML = '';
                rows.forEach(row => tbody.appendChild(row));
            } catch (error) {
                console.error('Error sorting table:', error);
            }
        }
    
        function updateMoneynessVsIV() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
        const selectedExpiry = document.getElementById('expiry-select').value;
        const filteredData = data.filter(item => item.Ticker === selectedTicker && item.Expiry === selectedExpiry);
        const errorDiv = document.getElementById('moneyness-error');
        errorDiv.style.display = 'none';
        if (!filteredData.length) {
            console.warn('No data for Moneyness vs. IV chart:', { ticker: selectedTicker, expiry: selectedExpiry });
            if (moneynessChart) moneynessChart.destroy();
            errorDiv.textContent = 'No data for selected ticker and expiry';
            errorDiv.style.display = 'block';
            return;
        }
        const datasets = [
            {
                label: 'Calls Smoothed IV',
                data: aggregateDataByX(filteredData.filter(item => item.Type === 'Call'), 'Moneyness', 'Smoothed_IV'),
                borderColor: '#FFFF00',
                backgroundColor: 'rgba(255, 255, 0, 0.2)',
                pointRadius: 0,
                fill: false,
                showLine: true,
                borderDash: [],
                yAxisID: 'y'
            },
            {
                label: 'Puts Smoothed IV',
                data: aggregateDataByX(filteredData.filter(item => item.Type === 'Put'), 'Moneyness', 'Smoothed_IV'),
                borderColor: '#1A7F73',
                backgroundColor: 'rgba(26, 127, 115, 0.2)',
                pointRadius: 0,
                fill: false,
                showLine: true,
                borderDash: [],
                yAxisID: 'y'
            },
            {
                label: 'Calls IV_mid',
                data: filteredData
                    .filter(item => item.Type === 'Call' && Number.isFinite(item.Moneyness) && Number.isFinite(item.IV_mid))
                    .map(item => ({
                        x: item.Moneyness * 100,
                        y: item.IV_mid * 100
                    }))
                    .sort((a, b) => a.x - b.x),
                borderColor: '#FFD700',
                backgroundColor: 'rgba(255, 215, 0, 0.2)',
                pointRadius: 3,
                pointStyle: 'circle',
                fill: false,
                showLine: true,
                borderDash: [5, 5],
                yAxisID: 'y'
            },
            {
                label: 'Puts IV_mid',
                data: filteredData
                    .filter(item => item.Type === 'Put' && Number.isFinite(item.Moneyness) && Number.isFinite(item.IV_mid))
                    .map(item => ({
                        x: item.Moneyness * 100,
                        y: item.IV_mid * 100
                    }))
                    .sort((a, b) => a.x - b.x),
                borderColor: '#1A7F73',
                backgroundColor: 'rgba(26, 127, 115, 0.2)',
                pointRadius: 3,
                pointStyle: 'circle',
                fill: false,
                showLine: true,
                borderDash: [5, 5],
                yAxisID: 'y'
            }
        ];
        const moneynessValues = filteredData
            .filter(item => Number.isFinite(item.Moneyness))
            .map(item => item.Moneyness * 100);
        const minMoneyness = moneynessValues.length > 0 ? Math.min(...moneynessValues) : 0;
        const maxMoneyness = moneynessValues.length > 0 ? Math.max(...moneynessValues) : 200;
        if (moneynessChart) moneynessChart.destroy();
        const canvas = document.getElementById('moneyness-vs-iv-chart');
        if (!canvas.getContext('2d')) {
            throw new Error('Canvas context not available for moneyness-vs-iv-chart');
        }
        moneynessChart = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { datasets },
            options: {
                plugins: { legend: { labels: { color: getThemeColor() } } },
                scales: {
                    x: {
                        type: 'linear',
                        title: { display: true, text: 'Moneyness (%)', color: getThemeColor() },
                        min: minMoneyness,
                        max: maxMoneyness,
                        reverse: false,
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y: {
                        title: { display: true, text: 'Volatility (%)', color: getThemeColor() },
                        grid: { display: false },
                        ticks: { color: getThemeColor() },
                        min: Math.min(...datasets.flatMap(ds => ds.data.map(p => p.y))) * 0.9,
                        max: Math.max(...datasets.flatMap(ds => ds.data.map(p => p.y))) * 1.1
                    }
                },
                backgroundColor: document.body.getAttribute('data-theme') === 'light' ? '#F5F7FA' : '#1A1A2E'
            }
        });
        createStatsTable(moneynessChart, 'moneyness-vs-iv-chart');
    } catch (error) {
        console.error('Error updating Moneyness vs. IV chart:', error);
        document.getElementById('moneyness-error').textContent = `Error rendering chart: ${error.message}`;
        document.getElementById('moneyness-error').style.display = 'block';
    }
}
        
        function updateExpiryVsIV() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
        const selectedMoneyness = parseFloat(document.getElementById('moneyness-select').value);
        let filteredData = data.filter(item => item.Ticker === selectedTicker && Math.round(item.Moneyness * 100 / 10) * 0.1 === selectedMoneyness);
        const termMinInput = document.getElementById('term-min-expiry').value;
        const termMaxInput = document.getElementById('term-max-expiry').value;
        const termMin = termMinInput ? new Date(termMinInput) : new Date(Math.min(...uniqueExpiries.map(e => new Date(e))));
        const termMax = termMaxInput ? new Date(termMaxInput) : new Date(Math.max(...uniqueExpiries.map(e => new Date(e))));
        filteredData = filteredData.filter(item => {
            const expDate = new Date(item.Expiry);
            return expDate >= termMin && expDate <= termMax;
        });
        const errorDiv = document.getElementById('expiry-error');
        errorDiv.style.display = 'none';
        if (!filteredData.length) {
            console.warn('No data for Expiry vs. IV chart:', { ticker: selectedTicker, moneyness: selectedMoneyness });
            if (expiryChart) expiryChart.destroy();
            errorDiv.textContent = 'No data for selected ticker and moneyness';
            errorDiv.style.display = 'block';
            return;
        }
        const datasets = [
            {
                label: 'Calls Smoothed IV',
                data: aggregateDataByX(filteredData.filter(item => item.Type === 'Call'), 'Expiry', 'Smoothed_IV'),
                borderColor: '#FFFF00',
                backgroundColor: 'rgba(255, 255, 0, 0.2)',
                pointRadius: 0,
                fill: false,
                showLine: true,
                borderDash: [],
                yAxisID: 'y'
            },
            {
                label: 'Puts Smoothed IV',
                data: aggregateDataByX(filteredData.filter(item => item.Type === 'Put'), 'Expiry', 'Smoothed_IV'),
                borderColor: '#1A7F73',
                backgroundColor: 'rgba(26, 127, 115, 0.2)',
                pointRadius: 0,
                fill: false,
                showLine: true,
                borderDash: [],
                yAxisID: 'y'
            },
            {
                label: 'Calls IV_mid',
                data: filteredData
                    .filter(item => item.Type === 'Call' && Number.isFinite(item.IV_mid) && item.Expiry)
                    .map(item => ({
                        x: new Date(item.Expiry),
                        y: item.IV_mid * 100
                    }))
                    .sort((a, b) => a.x - b.x),
                borderColor: '#FFD700',
                backgroundColor: 'rgba(255, 215, 0, 0.2)',
                pointRadius: 3,
                pointStyle: 'circle',
                fill: false,
                showLine: true,
                borderDash: [5, 5],
                yAxisID: 'y'
            },
            {
                label: 'Puts IV_mid',
                data: filteredData
                    .filter(item => item.Type === 'Put' && Number.isFinite(item.IV_mid) && item.Expiry)
                    .map(item => ({
                        x: new Date(item.Expiry),
                        y: item.IV_mid * 100
                    }))
                    .sort((a, b) => a.x - b.x),
                borderColor: '#1A7F73',
                backgroundColor: 'rgba(26, 127, 115, 0.2)',
                pointRadius: 3,
                pointStyle: 'circle',
                fill: false,
                showLine: true,
                borderDash: [5, 5],
                yAxisID: 'y'
            }
        ];
        if (expiryChart) expiryChart.destroy();
        const canvas = document.getElementById('expiry-vs-iv-chart');
        if (!canvas.getContext('2d')) {
            throw new Error('Canvas context not available for expiry-vs-iv-chart');
        }
        expiryChart = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { datasets },
            options: {
                plugins: { legend: { labels: { color: getThemeColor() } } },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day' },
                        title: { display: true, text: 'Expiry Date', color: getThemeColor() },
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y: {
                        title: { display: true, text: 'Volatility (%)', color: getThemeColor() },
                        grid: { display: false },
                        ticks: { color: getThemeColor() },
                        min: Math.min(...datasets.flatMap(ds => ds.data.map(p => p.y))) * 0.9,
                        max: Math.max(...datasets.flatMap(ds => ds.data.map(p => p.y))) * 1.1
                    }
                },
                backgroundColor: document.body.getAttribute('data-theme') === 'light' ? '#F5F7FA' : '#1A1A2E'
            }
        });
        createStatsTable(expiryChart, 'expiry-vs-iv-chart');
    } catch (error) {
        console.error('Error updating Expiry vs. IV chart:', error);
        document.getElementById('expiry-error').textContent = `Error rendering chart: ${error.message}`;
        document.getElementById('expiry-error').style.display = 'block';
    }
}
        
        function updateRealisedVolChart() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
        const startInput = document.getElementById('realised-start-date').value;
        const endInput = document.getElementById('realised-end-date').value;
        const volSelect = document.getElementById('realised-vol-metric-select');
        const selectedVolMetrics = Array.from(volSelect.selectedOptions).map(opt => opt.value);
        const errorDiv = document.getElementById('realised-vol-error');
        errorDiv.style.display = 'none';
        let filteredHistoric = historicData.filter(item => item.Ticker === selectedTicker && item.Date);
        if (!filteredHistoric.length) {
            console.warn('No data for Realised Volatility chart:', { ticker: selectedTicker });
            if (realisedVolChart) realisedVolChart.destroy();
            errorDiv.textContent = 'No data available';
            errorDiv.style.display = 'block';
            return;
        }
        filteredHistoric.sort((a, b) => new Date(a.Date) - new Date(b.Date));
        const minHistDate = new Date(Math.min(...filteredHistoric.map(item => new Date(item.Date))));
        const maxHistDate = new Date(Math.max(...filteredHistoric.map(item => new Date(item.Date))));
        const startDate = startInput ? new Date(startInput) : minHistDate;
        const endDate = endInput ? new Date(endInput) : maxHistDate;
        filteredHistoric = filteredHistoric.filter(item => {
            const itemDate = new Date(item.Date);
            return itemDate >= startDate && itemDate <= endDate;
        });
        if (!filteredHistoric.length) {
            console.warn('No data after date filtering for Realised Volatility chart:', { ticker: selectedTicker });
            if (realisedVolChart) realisedVolChart.destroy();
            errorDiv.textContent = 'No data for selected date range';
            errorDiv.style.display = 'block';
            return;
        }
        const dates = filteredHistoric.map(item => new Date(item.Date));
        const colors = [
            { metric: 'Realised_Vol_Close_30', border: '#FFFF00', background: 'rgba(255, 255, 0, 0.2)' },
            { metric: 'Realised_Vol_Close_60', border: '#008000', background: 'rgba(0, 128, 0, 0.2)' },
            { metric: 'Realised_Vol_Close_100', border: '#FF0000', background: 'rgba(255, 0, 0, 0.2)' },
            { metric: 'Realised_Vol_Close_180', border: '#FFA500', background: 'rgba(255, 165, 0, 0.2)' },
            { metric: 'Realised_Vol_Close_252', border: '#26A69A', background: 'rgba(38, 166, 154, 0.2)' }
        ];
        if (selectedVolMetrics.length === 0) {
            selectedVolMetrics.push(...colors.map(c => c.metric));
        }
        const datasets = selectedVolMetrics.map(metric => {
            const color = colors.find(c => c.metric === metric) || { border: '#FFFFFF', background: 'rgba(255, 255, 255, 0.2)' };
            const data = filteredHistoric.map(item => Number.isFinite(item[metric]) ? parseFloat(item[metric]) : null).filter(v => v !== null);
            return {
                label: `${metric.replace('Realised_Vol_Close_', '')}-day Realised Vol (%)`,
                data: data.map((v, i) => ({ x: dates[i], y: v })),
                borderColor: color.border,
                backgroundColor: color.background,
                pointRadius: 1,
                fill: true,
                showLine: true,
                yAxisID: 'y'
            };
        });
        if (datasets.length === 0) {
            console.warn('No valid data for selected volatility metrics:', selectedVolMetrics);
            if (realisedVolChart) realisedVolChart.destroy();
            errorDiv.textContent = 'No data for selected volatility metrics';
            errorDiv.style.display = 'block';
            return;
        }
        if (realisedVolChart) realisedVolChart.destroy();
        const canvas = document.getElementById('realised-vol-chart');
        if (!canvas.getContext('2d')) {
            throw new Error('Canvas context not available for realised-vol-chart');
        }
        realisedVolChart = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { datasets },
            options: {
                plugins: { legend: { labels: { color: getThemeColor() } } },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month' },
                        title: { display: true, text: 'Date', color: getThemeColor() },
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y: {
                        title: { display: true, text: 'Realised Volatility (%)', color: getThemeColor() },
                        beginAtZero: false,
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    }
                },
                backgroundColor: document.body.getAttribute('data-theme') === 'light' ? '#F5F7FA' : '#1A1A2E'
            }
        });
        createStatsTable(realisedVolChart, 'realised-vol-chart');
    } catch (error) {
        console.error('Error updating Realised Volatility chart:', error);
        document.getElementById('realised-vol-error').textContent = `Error rendering chart: ${error.message}`;
        document.getElementById('realised-vol-error').style.display = 'block';
    }
}

        function globalVolModelHyp(moneyness, tau, a0, a1, b0, b1, m0, m1, rho0, rho1, sigma0, sigma1, c) {
            const k = Math.log(moneyness);
            const denom = 1 + c * tau;
            const a_T = a0 + a1 / denom;
            const b_T = b0 + b1 / denom;
            const m_T = m0 + m1 / denom;
            const rho_T = rho0 + rho1 / denom;
            const sigma_T = sigma0 + sigma1 / denom;
            return a_T + b_T * (rho_T * (k - m_T) + Math.sqrt((k - m_T) ** 2 + sigma_T ** 2));
        }
        
        function updateCallVolSurface() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
        const errorDiv = document.getElementById('vol-surface-error');
        errorDiv.style.display = 'none';
        document.getElementById('surface-error').style.display = 'none';
        if (!selectedTicker || volSurfData.length === 0) {
            console.warn('No ticker selected or volSurfData empty:', { ticker: selectedTicker, volSurfDataLength: volSurfData.length });
            Plotly.purge('call-vol-surface');
            Plotly.purge('put-vol-surface');
            errorDiv.textContent = 'No volatility surface parameters available';
            errorDiv.style.display = 'block';
            return;
        }
        const callRow = volSurfData.find(r => r.Ticker === selectedTicker && r.Model === 'hyp' && r.Option_Type === 'Call');
        const putRow = volSurfData.find(r => r.Ticker === selectedTicker && r.Model === 'hyp' && r.Option_Type === 'Put');
        if (!callRow && !putRow) {
            console.warn('No HYP model data for ticker:', selectedTicker);
            Plotly.purge('call-vol-surface');
            Plotly.purge('put-vol-surface');
            errorDiv.textContent = `No volatility surface parameters for ${selectedTicker}`;
            errorDiv.style.display = 'block';
            return;
        }
        const moneynessSlider = document.getElementById('moneyness-slider').noUiSlider;
        const minMoneyness = parseFloat(moneynessSlider.get()[0]);
        const maxMoneyness = parseFloat(moneynessSlider.get()[1]);
        const expiryTSlider = document.getElementById('expiry-t-slider').noUiSlider;
        const minTau = parseFloat(expiryTSlider.get()[0]);
        const maxTau = parseFloat(expiryTSlider.get()[1]);
        const datasetDate = new Date(document.getElementById('date-select').value.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));
        const numPoints = 50;
        const moneynessValues = Array.from({ length: numPoints }, (_, i) =>
            maxMoneyness - (maxMoneyness - minMoneyness) * (i / (numPoints - 1))
        );
        const tauValues = Array.from({ length: numPoints }, (_, i) =>
            minTau + (maxTau - minTau) * (i / (numPoints - 1))
        );
        const callData = data.filter(item => item.Ticker === selectedTicker && item.Type === 'Call' && item.IV_mid && item.Moneyness && item.Years_to_Expiry);
        const putData = data.filter(item => item.Ticker === selectedTicker && item.Type === 'Put' && item.IV_mid && item.Moneyness && item.Years_to_Expiry);
        const callPoints = callData.map(item => ({
            x: parseFloat(item.Moneyness),
            y: parseFloat(item.Years_to_Expiry),
            z: parseFloat(item.IV_mid) * 100
        })).filter(p => Number.isFinite(p.x) && Number.isFinite(p.y) && Number.isFinite(p.z) && p.x >= minMoneyness && p.x <= maxMoneyness && p.y >= minTau && p.y <= maxTau);
        const putPoints = putData.map(item => ({
            x: parseFloat(item.Moneyness),
            y: parseFloat(item.Years_to_Expiry),
            z: parseFloat(item.IV_mid) * 100
        })).filter(p => Number.isFinite(p.x) && Number.isFinite(p.y) && Number.isFinite(p.z) && p.x >= minMoneyness && p.x <= maxMoneyness && p.y >= minTau && p.y <= maxTau);
        const computeSurface = (row, type) => {
            if (!row) return { surface: null, points: [] };
            const params = {
                a0: parseFloat(row.a0) || 0,
                a1: parseFloat(row.a1) || 0,
                b0: parseFloat(row.b0) || 0,
                b1: parseFloat(row.b1) || 0,
                m0: parseFloat(row.m0) || 0,
                m1: parseFloat(row.m1) || 0,
                rho0: parseFloat(row.rho0) || 0,
                rho1: parseFloat(row.rho1) || 0,
                sigma0: parseFloat(row.sigma0) || 0,
                sigma1: parseFloat(row.sigma1) || 0,
                c: parseFloat(row.c) || 0
            };
            const Z = tauValues.map(tau =>
                moneynessValues.map(moneyness =>
                    globalVolModelHyp(moneyness, tau, params.a0, params.a1, params.b0, params.b1, params.m0, params.m1, params.rho0, params.rho1, params.sigma0, params.sigma1, params.c) * 100
                )
            );
            const zValues = Z.flat().filter(v => Number.isFinite(v));
            const points = type === 'Call' ? callPoints : putPoints;
            return {
                surface: {
                    x: moneynessValues,
                    y: tauValues,
                    z: Z,
                    type: 'surface',
                    colorscale: 'Viridis',
                    showscale: true,
                    name: `${type} Volatility`,
                    colorbar: {
                        title: 'Volatility (%)',
                        titleside: 'right',
                        titlefont: { color: getThemeColor() },
                        tickfont: { color: getThemeColor() }
                    },
                    cmin: zValues.length ? Math.min(...zValues) : 0,
                    cmax: zValues.length ? Math.max(...zValues) : 100
                },
                points: points.length ? {
                    x: points.map(p => p.x),
                    y: points.map(p => p.y),
                    z: points.map(p => p.z),
                    type: 'scatter3d',
                    mode: 'markers',
                    marker: { color: 'red', size: 3, opacity: 0.8 },
                    name: `${type} Data Points`
                } : null
            };
        };
        const callResult = callRow ? computeSurface(callRow, 'Call') : { surface: null, points: callPoints.length ? {
            x: callPoints.map(p => p.x),
            y: callPoints.map(p => p.y),
            z: callPoints.map(p => p.z),
            type: 'scatter3d',
            mode: 'markers',
            marker: { color: 'red', size: 3, opacity: 0.8 },
            name: 'Call Data Points'
        } : null };
        const putResult = putRow ? computeSurface(putRow, 'Put') : { surface: null, points: putPoints.length ? {
            x: putPoints.map(p => p.x),
            y: putPoints.map(p => p.y),
            z: putPoints.map(p => p.z),
            type: 'scatter3d',
            mode: 'markers',
            marker: { color: 'red', size: 3, opacity: 0.8 },
            name: 'Put Data Points'
        } : null };
        const containerBgColor = 'var(--container-bg)';
        const callPlotData = [callResult.surface, callResult.points].filter(s => s !== null);
        if (callPlotData.length === 0) {
            console.warn('No call surface or data points for plotting:', { ticker: selectedTicker });
            Plotly.purge('call-vol-surface');
        } else {
            const zValues = callResult.surface ? callResult.surface.z.flat().filter(v => Number.isFinite(v)) : [];
            const zMin = zValues.length ? Math.min(...zValues) * 0.9 : 0;
            const zMax = zValues.length ? Math.max(...zValues) * 1.1 : 100;
            const callLayout = {
                title: { text: `Call Implied Volatility Surface for ${selectedTicker} (HYP Model)`, font: { color: getThemeColor(), size: 16 }, y: 0.95, x: 0.5, xanchor: 'center' },
                scene: {
                    xaxis: {
                        title: { text: 'Moneyness (K/S)', color: getThemeColor() },
                        color: getThemeColor(),
                        showgrid: false,
                        autorange: 'reversed'
                    },
                    yaxis: { title: { text: 'Time to Expiry (Years)', color: getThemeColor() }, color: getThemeColor(), showgrid: false },
                    zaxis: {
                        title: { text: 'Volatility (%)', color: getThemeColor() },
                        color: getThemeColor(),
                        showgrid: false,
                        range: [zMin, zMax]
                    },
                    aspectmode: 'cube',
                    bgcolor: containerBgColor
                },
                margin: { l: 0, r: 0, b: 0, t: 60 },
                autosize: true,
                height: 750,
                paper_bgcolor: containerBgColor,
                plot_bgcolor: containerBgColor,
                legend: { bgcolor: containerBgColor } // Added to set legend background
            };
            Plotly.newPlot('call-vol-surface', callPlotData, callLayout, { responsive: true });
            Plotly.Plots.resize('call-vol-surface'); // Ensure initial resize
        }
        const putPlotData = [putResult.surface, putResult.points].filter(s => s !== null);
        if (putPlotData.length === 0) {
            console.warn('No put surface or data points for plotting:', { ticker: selectedTicker });
            Plotly.purge('put-vol-surface');
        } else {
            const zValues = putResult.surface ? putResult.surface.z.flat().filter(v => Number.isFinite(v)) : [];
            const zMin = zValues.length ? Math.min(...zValues) * 0.9 : 0;
            const zMax = zValues.length ? Math.max(...zValues) * 1.1 : 100;
            const putLayout = {
                title: { text: `Put Implied Volatility Surface for ${selectedTicker} (HYP Model)`, font: { color: getThemeColor(), size: 16 }, y: 0.95, x: 0.5, xanchor: 'center' },
                scene: {
                    xaxis: {
                        title: { text: 'Moneyness (K/S)', color: getThemeColor() },
                        color: getThemeColor(),
                        showgrid: false,
                        autorange: 'reversed'
                    },
                    yaxis: { title: { text: 'Time to Expiry (Years)', color: getThemeColor() }, color: getThemeColor(), showgrid: false },
                    zaxis: {
                        title: { text: 'Volatility (%)', color: getThemeColor() },
                        color: getThemeColor(),
                        showgrid: false,
                        range: [zMin, zMax]
                    },
                    aspectmode: 'cube',
                    bgcolor: containerBgColor
                },
                margin: { l: 0, r: 0, b: 0, t: 60 },
                autosize: true,
                height: 750,
                paper_bgcolor: containerBgColor,
                plot_bgcolor: containerBgColor,
                legend: { bgcolor: containerBgColor } // Added to set legend background
            };
            Plotly.newPlot('put-vol-surface', putPlotData, putLayout, { responsive: true });
            Plotly.Plots.resize('put-vol-surface'); // Ensure initial resize
        }
        if (callPlotData.length === 0 && putPlotData.length === 0) {
            errorDiv.textContent = `No valid surface or data points for ${selectedTicker}`;
            errorDiv.style.display = 'block';
        } else {
            document.getElementById('moneyness-value').textContent = `${minMoneyness.toFixed(1)} - ${maxMoneyness.toFixed(1)}`;
            document.getElementById('expiry-t-value').textContent = `${minTau.toFixed(1)} - ${maxTau.toFixed(1)}`;
            console.log(`Volatility surfaces plotted for ${selectedTicker}:`, { call: !!callResult.surface, callPoints: callPoints.length, put: !!putResult.surface, putPoints: putPoints.length });
        }
    } catch (error) {
        console.error('Error updating Volatility Surfaces:', error);
        Plotly.purge('call-vol-surface');
        Plotly.purge('put-vol-surface');
        document.getElementById('vol-surface-error').textContent = `Error rendering volatility surfaces: ${error.message}`;
        document.getElementById('vol-surface-error').style.display = 'block';
    }
}
        
        function updateKurtosisChart() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
        const startInput = document.getElementById('kurtosis-start-date').value;
        const endInput = document.getElementById('kurtosis-end-date').value;
        const kurtType = document.getElementById('kurtosis-type-select').value;
        const errorDiv = document.getElementById('kurtosis-error');
        errorDiv.style.display = 'none';
        let filteredHistoric = historicData.filter(item => item.Ticker === selectedTicker && item.Date && Number.isFinite(item[kurtType]));
        if (!filteredHistoric.length) {
            console.warn('No data for Kurtosis chart:', { ticker: selectedTicker });
            if (kurtosisChart) kurtosisChart.destroy();
            errorDiv.textContent = 'No kurtosis data available';
            errorDiv.style.display = 'block';
            return;
        }
        filteredHistoric.sort((a, b) => new Date(a.Date) - new Date(b.Date));
        const minHistDate = new Date(Math.min(...filteredHistoric.map(item => new Date(item.Date))));
        const maxHistDate = new Date(Math.max(...filteredHistoric.map(item => new Date(item.Date))));
        const startDate = startInput ? new Date(startInput) : minHistDate;
        const endDate = endInput ? new Date(endInput) : maxHistDate;
        filteredHistoric = filteredHistoric.filter(item => {
            const itemDate = new Date(item.Date);
            return itemDate >= startDate && itemDate <= endDate;
        });
        const dates = filteredHistoric.map(item => new Date(item.Date));
        const kurtosis = filteredHistoric.map(item => parseFloat(item[kurtType])).filter(v => v !== null);
        const datasets = [
            {
                label: `Kurtosis of 100-day ${kurtType.includes('Returns') ? 'Log Returns' : 'Close Prices'}`,
                data: kurtosis.map((v, i) => ({ x: dates[i], y: v })),
                borderColor: '#FFA500',
                backgroundColor: 'rgba(255, 165, 0, 0.2)',
                pointRadius: 1,
                fill: true,
                showLine: true,
                yAxisID: 'y'
            }
        ];
        const annotations = {
            leptokurtic: {
                type: 'line',
                yMin: 3,
                yMax: 3,
                borderColor: '#FF0000',
                borderWidth: 1,
                borderDash: [5, 5],
                label: {
                    content: 'Mesokurtic (Normal, ~3)',
                    position: 'end',
                    backgroundColor: 'rgba(255, 0, 0, 0.7)',
                    color: getThemeColor(),
                    font: { size: 12 }
                }
            },
            leptokurticLabel: {
                type: 'box',
                yMin: 3,
                yMax: Math.max(...kurtosis, 3) + 0.5,
                backgroundColor: 'rgba(255, 0, 0, 0.1)',
                borderColor: 'rgba(255, 0, 0, 0.3)',
                borderWidth: 1,
                label: {
                    content: 'Leptokurtic (>3)',
                    position: 'center',
                    color: getThemeColor(),
                    font: { size: 12 }
                }
            },
            platykurticLabel: {
                type: 'box',
                yMin: Math.min(...kurtosis, 3) - 0.5,
                yMax: 3,
                backgroundColor: 'rgba(0, 128, 0, 0.1)',
                borderColor: 'rgba(0, 128, 0, 0.3)',
                borderWidth: 1,
                label: {
                    content: 'Platykurtic (<3)',
                    position: 'center',
                    color: getThemeColor(),
                    font: { size: 12 }
                }
            }
        };
        if (kurtosisChart) kurtosisChart.destroy();
        const canvas = document.getElementById('kurtosis-chart');
        if (!canvas.getContext('2d')) {
            throw new Error('Canvas context not available for kurtosis-chart');
        }
        kurtosisChart = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { datasets },
            options: {
                plugins: {
                    legend: { labels: { color: getThemeColor() } },
                    annotation: { annotations }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month' },
                        title: { display: true, text: 'Date', color: getThemeColor() },
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y: {
                        title: { display: true, text: 'Kurtosis', color: getThemeColor() },
                        beginAtZero: false,
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    }
                },
                backgroundColor: 'var(--container-bg)'
            }
        });
        createStatsTable(kurtosisChart, 'kurtosis-chart');
    } catch (error) {
        console.error('Error updating Kurtosis chart:', error);
        document.getElementById('kurtosis-error').textContent = `Error rendering chart: ${error.message}`;
        document.getElementById('kurtosis-error').style.display = 'block';
    }
}
        
        function updateVolOfVolChart() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
        const startInput = document.getElementById('volofvol-start-date').value;
        const endInput = document.getElementById('volofvol-end-date').value;
        const errorDiv = document.getElementById('vol-of-vol-error');
        errorDiv.style.display = 'none';
        let filteredHistoric = historicData.filter(item => item.Ticker === selectedTicker && item.Date && Number.isFinite(item.Vol_of_Vol_100d) && Number.isFinite(item.Vol_of_Vol_100d_Percentile));
        if (!filteredHistoric.length) {
            console.warn('No data for Volatility of Volatility chart:', { ticker: selectedTicker });
            if (volOfVolChart) volOfVolChart.destroy();
            errorDiv.textContent = 'No volatility of volatility data available';
            errorDiv.style.display = 'block';
            return;
        }
        filteredHistoric.sort((a, b) => new Date(a.Date) - new Date(b.Date));
        const minHistDate = new Date(Math.min(...filteredHistoric.map(item => new Date(item.Date))));
        const maxHistDate = new Date(Math.max(...filteredHistoric.map(item => new Date(item.Date))));
        const startDate = startInput ? new Date(startInput) : minHistDate;
        const endDate = endInput ? new Date(endInput) : maxHistDate;
        filteredHistoric = filteredHistoric.filter(item => {
            const itemDate = new Date(item.Date);
            return itemDate >= startDate && itemDate <= endDate;
        });
        const dates = filteredHistoric.map(item => new Date(item.Date));
        const volOfVol = filteredHistoric.map(item => parseFloat(item.Vol_of_Vol_100d)).filter(v => v !== null);
        const percentile = filteredHistoric.map(item => parseFloat(item.Vol_of_Vol_100d_Percentile)).filter(v => v !== null);
        const datasets = [
            {
                label: 'Vol of Vol 100d (%)',
                data: volOfVol.map((v, i) => ({ x: dates[i], y: v })),
                borderColor: '#FFA500',
                backgroundColor: 'rgba(255, 165, 0, 0.2)',
                pointRadius: 1,
                fill: true,
                showLine: true,
                yAxisID: 'y'
            },
            {
                label: 'Vol of Vol 100d Percentile (%)',
                data: percentile.map((v, i) => ({ x: dates[i], y: v })),
                borderColor: '#26A69A',
                backgroundColor: 'rgba(38, 166, 154, 0.2)',
                pointRadius: 1,
                fill: true,
                showLine: true,
                yAxisID: 'y1'
            }
        ];
        if (volOfVolChart) volOfVolChart.destroy();
        const canvas = document.getElementById('vol-of-vol-chart');
        if (!canvas.getContext('2d')) {
            throw new Error('Canvas context not available for vol-of-vol-chart');
        }
        volOfVolChart = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { datasets },
            options: {
                plugins: { legend: { labels: { color: getThemeColor() } } },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month' },
                        title: { display: true, text: 'Date', color: getThemeColor() },
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y: {
                        title: { display: true, text: 'Vol of Vol (%)', color: getThemeColor() },
                        beginAtZero: false,
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y1: {
                        title: { display: true, text: 'Percentile (%)', color: getThemeColor() },
                        position: 'right',
                        beginAtZero: false,
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    }
                },
                backgroundColor: document.body.getAttribute('data-theme') === 'light' ? '#F5F7FA' : '#1A1A2E'
            }
        });
        createStatsTable(volOfVolChart, 'vol-of-vol-chart');
    } catch (error) {
        console.error('Error updating Volatility of Volatility chart:', error);
        document.getElementById('vol-of-vol-error').textContent = `Error rendering chart: ${error.message}`;
        document.getElementById('vol-of-vol-error').style.display = 'block';
    }
}
        
        
        function calculateTimeToExpiry(expiryDate, referenceDate) {
            try {
                const expiry = new Date(expiryDate);
                const ref = new Date(referenceDate);
                const diffMs = expiry - ref;
                return diffMs / (365 * 24 * 60 * 60 * 1000);
            } catch (error) {
                console.error('Error calculating time to expiry:', error);
                return null;
            }
        }
        
function updateHistoricChart() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
        const startInput = document.getElementById('historic-start-date').value;
        const endInput = document.getElementById('historic-end-date').value;
        const chartType = document.getElementById('historic-chart-type').value;
        const errorDiv = document.getElementById('historic-error');
        errorDiv.style.display = 'none';
        console.log('Updating Historic chart for ticker:', selectedTicker, 'chartType:', chartType, 'historicData columns:', historicData.length > 0 ? Object.keys(historicData[0]) : [], 'sample data:', historicData.slice(0, 3));
        if (!historicData || historicData.length === 0) {
            if (historicChart) historicChart.destroy();
            errorDiv.textContent = 'No historic data available';
            errorDiv.style.display = 'block';
            return;
        }
        let filteredHistoric = historicData.filter(item => 
            item.Ticker === selectedTicker && 
            item.Date && 
            Number.isFinite(item.Close) && 
            Number.isFinite(item.Open) && 
            Number.isFinite(item.High) && 
            Number.isFinite(item.Low)
        );
        if (filteredHistoric.length === 0) {
            if (historicChart) historicChart.destroy();
            errorDiv.textContent = 'No valid historic OHLC data for selected ticker';
            errorDiv.style.display = 'block';
            console.warn('Filtered historic data empty for ticker:', selectedTicker, 'required fields missing or invalid');
            return;
        }
        filteredHistoric.sort((a, b) => new Date(a.Date) - new Date(b.Date));
        const minHistoricDate = new Date(Math.min(...filteredHistoric.map(item => new Date(item.Date))));
        const maxHistoricDate = new Date(Math.max(...filteredHistoric.map(item => new Date(item.Date))));
        const startDate = startInput ? new Date(startInput) : minHistoricDate;
        const endDate = endInput ? new Date(endInput) : maxHistoricDate;
        filteredHistoric = filteredHistoric.filter(item => {
            const itemDate = new Date(item.Date);
            return itemDate >= startDate && itemDate <= endDate;
        });
        if (filteredHistoric.length === 0) {
            if (historicChart) historicChart.destroy();
            errorDiv.textContent = 'No data in selected date range';
            errorDiv.style.display = 'block';
            console.warn('No data after date filtering for ticker:', selectedTicker, 'start:', startDate, 'end:', endDate);
            return;
        }
        const dates = filteredHistoric.map(item => new Date(item.Date));
        const vol100 = filteredHistoric.map(item => {
            const col = ['Realised_Vol_Close_100', 'Realized_Vol_Close_100'].find(c => item.hasOwnProperty(c)) || 'Realised_Vol_Close_100';
            return Number.isFinite(item[col]) ? parseFloat(item[col]) : null;
        }).filter(v => v !== null);
        let datasets = [];
        if (chartType === 'line') {
            datasets = [
                {
                    label: 'Stock Price',
                    data: filteredHistoric.map((item, i) => ({ x: dates[i], y: parseFloat(item.Close) })),
                    borderColor: '#FFFF00',
                    backgroundColor: '#FFFF00',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    yAxisID: 'y'
                },
                {
                    label: '100-day Realised Vol (%)',
                    data: vol100.map((v, i) => ({ x: dates[i], y: v })),
                    borderColor: '#26A69A',
                    backgroundColor: 'rgba(38, 166, 154, 0.2)',
                    pointRadius: 1,
                    fill: false,
                    showLine: true,
                    yAxisID: 'y1'
                }
            ];
        } else if (chartType === 'candlestick') {
            datasets = [
                {
                    label: 'Stock Price',
                    type: 'candlestick',
                    data: filteredHistoric.map((item, i) => ({
                        x: dates[i],
                        o: parseFloat(item.Open),
                        h: parseFloat(item.High),
                        l: parseFloat(item.Low),
                        c: parseFloat(item.Close)
                    })),
                    color: {
                        up: 'var(--highlight-positive)', // Green for bullish
                        down: 'var(--highlight-negative)', // Red for bearish
                        unchanged: '#9CA3AF' // Gray for unchanged
                    },
                    borderColor: {
                        up: 'var(--highlight-positive)',
                        down: 'var(--highlight-negative)',
                        unchanged: '#9CA3AF'
                    },
                    borderWidth: 0.5, // Very thin wicks and bodies
                    barPercentage: 0.05, // Extremely slim candles
                    categoryPercentage: 0.04, // Maximize space between candles
                    yAxisID: 'y'
                }
            ];
        }
        if (historicChart) historicChart.destroy();
        const canvas = document.getElementById('historic-price-chart');
        if (!canvas.getContext('2d')) {
            throw new Error('Canvas context not available for historic-price-chart');
        }
        const prices = filteredHistoric.map(item => [item.Open, item.High, item.Low, item.Close]).flat().filter(v => Number.isFinite(v));
        const minPrice = prices.length ? Math.min(...prices) : 0;
        const maxPrice = prices.length ? Math.max(...prices) : 100;
        historicChart = new Chart(canvas.getContext('2d'), {
            type: chartType === 'candlestick' ? 'candlestick' : 'line',
            data: { datasets },
            options: {
                plugins: {
                    legend: { labels: { color: getThemeColor() } },
                    annotation: { annotations: chartType === 'line' ? /* Keep annotations for line chart */
                        eventsData
                            .filter(event => {
                                if (!event.Start_Date || !event.End_Date) return false;
                                const startDate = new Date(event.Start_Date);
                                const endDate = new Date(event.End_Date);
                                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return false;
                                if (!(event.Ticker === 'ALL' || event.Ticker === selectedTicker)) return false;
                                if (startDate > maxHistoricDate || endDate < minHistoricDate) return false;
                                return endDate >= startDate && startDate <= endDate;
                            })
                            .map((event, index) => ({
                                type: 'box',
                                xMin: new Date(Math.max(new Date(event.Start_Date), startDate)),
                                xMax: new Date(Math.min(new Date(event.End_Date), endDate)),
                                yMin: 'y',
                                yMax: 'y',
                                backgroundColor: event.Impact === 'dip' ? 'rgba(248, 113, 113, 0.2)' : 'rgba(74, 222, 128, 0.2)',
                                borderColor: event.Impact === 'dip' ? 'rgba(248, 113, 113, 0.5)' : 'rgba(74, 222, 128, 0.5)',
                                borderWidth: 1,
                                label: {
                                    content: event.Event || 'Unknown Event',
                                    display: true,
                                    position: 'center',
                                    color: getThemeColor(),
                                    font: { size: 12 },
                                    rotation: 90
                                }
                            })) : {} // No annotations for candlestick
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day' }, // Force daily candles
                        title: { display: true, text: 'Date', color: getThemeColor() },
                        grid: { display: false },
                        ticks: { 
                            color: getThemeColor(),
                            maxRotation: 45,
                            minRotation: 45,
                            maxTicksLimit: 8 // Fewer ticks for narrower candles
                        }
                    },
                    y: {
                        title: { display: true, text: 'Stock Price ($)', color: getThemeColor() },
                        beginAtZero: false,
                        grid: { display: false },
                        ticks: { color: getThemeColor() },
                        min: minPrice * 0.95, // Add padding
                        max: maxPrice * 1.05 // Add padding
                    },
                    ...(chartType === 'line' ? {
                        y1: {
                            title: { display: true, text: 'Realised Volatility (%)', color: getThemeColor() },
                            position: 'right',
                            beginAtZero: false,
                            grid: { display: false },
                            ticks: { color: getThemeColor() }
                        }
                    } : {})
                },
                backgroundColor: document.body.getAttribute('data-theme') === 'light' ? '#F5F7FA' : '#1A1A2E'
            }
        });
        document.getElementById('historic-error').style.display = 'none';
        createStatsTable(historicChart, 'historic-price-chart');
        console.log('Historic chart rendered, type:', chartType, 'data points:', filteredHistoric.length, 'price range:', minPrice, maxPrice);
    } catch (error) {
        console.error('Error updating Historic chart:', error);
        document.getElementById('historic-error').textContent = `Error rendering historic chart: ${error.message}`;
        document.getElementById('historic-error').style.display = 'block';
    }
}
        
        
        function updateVolumeChart() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
        const uniqueTickers = [...new Set(rankingData.map(item => item.Ticker))].filter(val => val).sort();
        const volumes = uniqueTickers.map(ticker => {
            const tickerData = rankingData.find(item => item.Ticker === ticker);
            return tickerData && Number.isFinite(tickerData['Volume']) ? parseInt(tickerData['Volume']) : 0;
        });
        const backgroundColors = uniqueTickers.map(ticker => ticker === selectedTicker ? '#FFFF00' : '#00BFFF');
        if (volumeChart) volumeChart.destroy();
        const canvas = document.getElementById('volume-chart');
        if (!canvas.getContext('2d')) {
            throw new Error('Canvas context not available for volume-chart');
        }
        volumeChart = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: uniqueTickers,
                datasets: [{
                    label: 'Total Volume',
                    data: volumes,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                plugins: { legend: { labels: { color: getThemeColor() } } },
                scales: {
                    x: {
                        title: { display: true, text: 'Ticker', color: getThemeColor() },
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y: {
                        title: { display: true, text: 'Volume', color: getThemeColor() },
                        beginAtZero: true,
                        grid: { display: false },
                        ticks: {
                            color: getThemeColor(),
                            callback: value => Number(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                        }
                    }
                },
                backgroundColor: 'var(--container-bg)'
            }
        });
        console.log('Volume chart updated for tickers:', uniqueTickers);
    } catch (error) {
        console.error('Error updating volume chart:', error);
        document.getElementById('historic-error').textContent = `Error rendering volume chart: ${error.message}`;
        document.getElementById('historic-error').style.display = 'block';
    }
}
        
        function updateOpenInterestChart() {
    try {
        const selectedTicker = document.getElementById('ticker-search').value.toUpperCase();
        const uniqueTickers = [...new Set(rankingData.map(item => item.Ticker))].filter(val => val).sort();
        const openInterests = uniqueTickers.map(ticker => {
            const tickerData = rankingData.find(item => item.Ticker === ticker);
            return tickerData && Number.isFinite(tickerData['Open Interest']) ? parseInt(tickerData['Open Interest']) : 0;
        });
        const backgroundColors = uniqueTickers.map(ticker => ticker === selectedTicker ? '#FFFF00' : '#00BFFF');
        if (openInterestChart) openInterestChart.destroy();
        const canvas = document.getElementById('open-interest-chart');
        if (!canvas.getContext('2d')) {
            throw new Error('Canvas context not available for open-interest-chart');
        }
        openInterestChart = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: uniqueTickers,
                datasets: [{
                    label: 'Total Open Interest',
                    data: openInterests,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                plugins: { legend: { labels: { color: getThemeColor() } } },
                scales: {
                    x: {
                        title: { display: true, text: 'Ticker', color: getThemeColor() },
                        grid: { display: false },
                        ticks: { color: getThemeColor() }
                    },
                    y: {
                        title: { display: true, text: 'Open Interest', color: getThemeColor() },
                        beginAtZero: true,
                        grid: { display: false },
                        ticks: {
                            color: getThemeColor(),
                            callback: value => Number(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                        }
                    }
                },
                backgroundColor: 'var(--container-bg)'
            }
        });
        console.log('Open Interest chart updated for tickers:', uniqueTickers);
    } catch (error) {
        console.error('Error updating open interest chart:', error);
        document.getElementById('historic-error').textContent = `Error rendering open interest chart: ${error.message}`;
        document.getElementById('historic-error').style.display = 'block';
    }
}
        
        function aggregateDataByX(data, xKey, yKey) {
            try {
                const grouped = data.reduce((acc, item) => {
                    const xValue = xKey === 'Expiry' ? new Date(item[xKey]).toISOString() : item[xKey];
                    const yValue = item[yKey];
                    if (!acc[xValue]) acc[xValue] = { sum: 0, count: 0 };
                    if (!isNaN(yValue) && yValue !== null) {
                        acc[xValue].sum += yValue;
                        acc[xValue].count += 1;
                    }
                    return acc;
                }, {});
                return Object.keys(grouped).map(x => {
                    const group = grouped[x];
                    if (group.count > 0) {
                        return {
                            x: xKey === 'Expiry' ? new Date(x) : parseFloat(x) * (xKey === 'Moneyness' || xKey === 'Delta' ? 100 : 1),
                            y: (group.sum / group.count) * 100
                        };
                    }
                }).filter(point => point).sort((a, b) => a.x - b.x);
            } catch (error) {
                console.error('Error aggregating data:', error);
                return [];
            }
        }
        
        function createStatsTable(chart, canvasId) {
    try {
        const container = document.getElementById(canvasId).parentNode;
        let existingTable = container.querySelector('.stats-table');
        if (existingTable) existingTable.remove();
        const table = document.createElement('table');
        table.className = 'stats-table';
        table.style.display = canvasId === 'historic-price-chart' ? 'table' : (statsTablesVisible ? 'table' : 'none');
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        ['Label', 'Last', 'Min', 'Max', 'Mean', 'SD', 'SD Change'].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
        });
        const tbody = table.createTBody();
        chart.data.datasets.forEach(dataset => {
            if (!dataset.data.length) return;
            const ys = dataset.data.map(point => point.y).filter(y => !isNaN(y));
            if (!ys.length) return;
            const last = ys[ys.length - 1];
            const min = Math.min(...ys);
            const max = Math.max(...ys);
            const mean = ys.reduce((a, b) => a + b, 0) / ys.length;
            const sd = Math.sqrt(ys.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (ys.length - 1)) || 0;
            const sdChanges = ys.slice(1).map((y, i) => y - ys[i]);
            const sdChange = sdChanges.length > 0 ? Math.sqrt(sdChanges.reduce((a, b) => a + Math.pow(b, 2), 0) / (sdChanges.length - 1)) || 0 : 0;
            const row = tbody.insertRow();
            const labelTd = row.insertCell();
            const swatch = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            swatch.setAttribute('width', '20');
            swatch.setAttribute('height', '10');
            swatch.setAttribute('class', 'line-swatch');
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', '0');
            line.setAttribute('y1', '5');
            line.setAttribute('x2', '20');
            line.setAttribute('y2', '5');
            line.setAttribute('stroke', dataset.borderColor);
            line.setAttribute('stroke-width', '2');
            if (dataset.borderDash && dataset.borderDash.length > 0) {
                line.setAttribute('stroke-dasharray', dataset.borderDash.join(' '));
            }
            swatch.appendChild(line);
            labelTd.appendChild(swatch);
            labelTd.appendChild(document.createTextNode(` ${dataset.label}`));
            labelTd.style.color = 'var(--text-color)';
            ['last', 'min', 'max', 'mean', 'sd', 'sdChange'].forEach(val => {
                const cell = row.insertCell();
                cell.textContent = eval(val).toFixed(2);
                cell.style.color = 'var(--text-color)';
            });
        });
        container.appendChild(table);
    } catch (error) {
        console.error('Error creating stats table:', error);
        document.getElementById('historic-error').textContent = `Error creating stats table: ${error.message}`;
        document.getElementById('historic-error').style.display = 'block';
    }
}
        
        function updateSection(sectionId, subSectionId) {
            try {
                console.log('Updating section:', sectionId, 'subSection:', subSectionId);
                const sections = ['macro', 'indices', 'volatility', 'volatility-surface'];
                sections.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = id === sectionId ? 'grid' : 'none';
                });
                const showTickerSummary = sectionId === 'volatility' && ['volatility-overview', 'volatility-plots', 'volatility-surface'].includes(subSectionId);
                document.getElementById('selected-ticker-summary').style.display = showTickerSummary ? 'block' : 'none';
        
                document.querySelectorAll('.sidebar a:not(.sub-tab)').forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href').substring(1) === sectionId);
                });
        
                if (sectionId === 'macro') {
                    const subSections = ['bonds', 'commodities', 'stocks', 'currencies', 'crypto', 'shares'];
                    const selectedSub = subSectionId || 'macro-bonds';
                    document.querySelectorAll('#macro > div.chart-container').forEach(div => {
                        div.style.display = div.id === selectedSub ? 'block' : 'none';
                    });
                    document.querySelectorAll('#macro-sub-menu .sub-tab').forEach(tab => {
                        tab.classList.toggle('active', tab.getAttribute('href').substring(1) === selectedSub);
                    });
                    updateTradingEconomicsTables();
                } else if (sectionId === 'indices') {
                    const subSections = ['overview', 'stock', 'price-comparisons'];
                    const selectedSub = subSectionId || 'indices-overview';
                    document.querySelectorAll('#indices > div').forEach(div => {
                        div.style.display = div.id === selectedSub ? (div.id === 'indices-overview' ? 'block' : 'block') : 'none';
                    });
                    document.querySelectorAll('#indices-sub-menu .sub-tab').forEach(tab => {
                        tab.classList.toggle('active', tab.getAttribute('href').substring(1) === selectedSub);
                    });
                    if (selectedSub === 'indices-overview') {
                        updateIndicesTable();
                        if (indicesChartVisible) updateIndicesChart();
                    } else if (selectedSub === 'indices-stock') {
                        updateStockTable();
                        updateKurtosisChart();
                    } else if (selectedSub === 'indices-price-comparisons') {
                        updateNormalizedTable();
                    }
                } else if (sectionId === 'volatility') {
                    const subSections = ['overview', 'plots', 'ranking', 'data-table'];
                    const selectedSub = subSectionId || 'volatility-overview';
                    document.querySelectorAll('#volatility > div').forEach(div => {
                        div.style.display = div.id === selectedSub ? (div.id === 'volatility-overview' ? 'grid' : 'block') : 'none';
                    });
                    document.querySelectorAll('#volatility-sub-menu .sub-tab').forEach(tab => {
                        tab.classList.toggle('active', tab.getAttribute('href').substring(1) === selectedSub);
                    });
                    if (selectedSub === 'volatility-overview') {
                        updateSummaryTable();
                        updateTopContractsTables();
                        updateHistoricChart();
                    } else if (selectedSub === 'volatility-plots') {
                        updateMoneynessVsIV();
                        updateExpiryVsIV();
                        updateSkewVsExpiry();
                        updateRealisedVolChart();
                        updateVolOfVolChart();
                    } else if (selectedSub === 'volatility-ranking') {
                        updateVolumeChart();
                        updateOpenInterestChart();
                        updateRankingTable();
                    } else if (selectedSub === 'volatility-data-table') {
                        updateRawDataTable();
                    }
                    if (showTickerSummary) updateSelectedTickerSummary();
                } else if (sectionId === 'volatility-surface') {
                    document.querySelectorAll('#volatility-sub-menu .sub-tab').forEach(tab => {
                        tab.classList.toggle('active', tab.getAttribute('href').substring(1) === 'volatility-surface');
                    });
                    updateCallVolSurface();
                    if (showTickerSummary) updateSelectedTickerSummary();
                }
            } catch (error) {
                console.error('Error updating section:', error);
                document.getElementById('historic-error').textContent = `Error navigating to section: ${error.message}`;
                document.getElementById('historic-error').style.display = 'block';
            }
        }
        
        function toggleTradingEconomicsTable(tableName) {
            try {
                const tableVisible = window[`${tableName}TableVisible`] || false;
                window[`${tableName}TableVisible`] = !tableVisible;
                const table = document.getElementById(`${tableName}-table`);
                table.style.display = window[`${tableName}TableVisible`] ? 'table' : 'none';
                document.querySelector(`#macro-${tableName === 'shares_gainers' || tableName === 'shares_losers' ? 'shares' : tableName} .toggle-button[onclick*="${tableName}"]`).textContent = window[`${tableName}TableVisible`] ? 'Hide Data' : 'Show Data';
                if (window[`${tableName}TableVisible`]) updateTradingEconomicsTables();
                console.log(`${tableName} table visibility set to: ${window[`${tableName}TableVisible`]}`);
            } catch (error) {
                console.error(`Error toggling ${tableName} table:`, error);
            }
        }
        
        function updateTradingEconomicsTables() {
    try {
        const tables = [
            { id: 'bonds', data: bondsData },
            { id: 'commodities', data: commoditiesData },
            { id: 'stocks', data: stocksData },
            { id: 'currencies', data: currenciesData },
            { id: 'crypto', data: cryptoData },
            { id: 'shares-gainers', data: sharesGainersData },
            { id: 'shares-losers', data: sharesLosersData }
        ];
        tables.forEach(({ id, data }) => {
            const table = document.getElementById(`${id}-table`);
            table.innerHTML = '';
            if (!data || data.length === 0) {
                table.innerHTML = `<tr><td colspan="10">No ${id} data available</td></tr>`;
                console.warn(`No data for ${id} table`);
                return;
            }
            const thead = document.createElement('thead');
            const headerRow = thead.insertRow();
            const columns = Object.keys(data[0]);
            columns.forEach((col, index) => {
                const th = document.createElement('th');
                th.textContent = col;
                th.dataset.column = col;
                th.dataset.order = 'desc';
                th.addEventListener('click', () => sortTable(`${id}-table`, index));
                headerRow.appendChild(th);
            });
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            data.forEach(item => {
                const row = tbody.insertRow();
                columns.forEach(col => {
                    const cell = row.insertCell();
                    let value = item[col];
                    if (Number.isFinite(value)) {
                        if (col.includes('Price') || col.includes('Yield') || col.includes('Chg') || col.includes('Day')) {
                            value = value.toFixed(4);
                        } else if (col.includes('MarketCap')) {
                            value = value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                        } else {
                            value = value.toFixed(2);
                        }
                    } else {
                        value = value || 'N/A';
                    }
                    cell.textContent = value;
                    cell.style.color = col.includes('%') && Number.isFinite(parseFloat(value)) && value !== 'N/A'
                        ? (parseFloat(value) < 0 ? 'var(--highlight-negative)' : parseFloat(value) > 0 ? 'var(--highlight-positive)' : 'var(--text-color)')
                        : 'var(--text-color)';
                });
            });
            table.appendChild(tbody);
            console.log(`${id} table updated successfully, rows: ${data.length}`);
        });
    } catch (error) {
        console.error('Error updating Trading Economics tables:', error);
        const errorElement = document.getElementById('trading-economics-error');
        if (errorElement) {
            errorElement.textContent = `Error loading tables: ${error.message}`;
            errorElement.style.display = 'block';
        } else {
            console.warn('trading-economics-error element not found in DOM');
        }
    }
}
        
        function updateCharts() {
            try {
                console.log('Updating all charts and tables');
                updateMoneynessVsIV();
                updateExpiryVsIV();
                updateSkewVsExpiry();
                updateRealisedVolChart();
                updateVolOfVolChart();
                updateSummaryTable();
                updateTopContractsTables();
                updateVolumeChart();
                updateOpenInterestChart();
                updateHistoricChart();
                updateRawDataTable();
                updateRankingTable();
                updateStockTable();
                updateSelectedTickerSummary();
                updateNormalizedTable();
                updateKurtosisChart();
                updateCallVolSurface();
            } catch (error) {
                console.error('Error updating charts:', error);
                document.getElementById('historic-error').textContent = `Error updating charts: ${error.message}`;
                document.getElementById('historic-error').style.display = 'block';
            }
        }
        
        function addKeyboardNavigation() {
            try {
                const chartConfigs = [
                    { canvasId: 'moneyness-vs-iv-chart', selectId: 'expiry-select' },
                    { canvasId: 'expiry-vs-iv-chart', selectId: 'moneyness-select' },
                    { canvasId: 'skew-vs-expiry-chart', selectId: 'skew-metric-select' },
                    { canvasId: 'realised-vol-chart', selectId: 'realised-vol-metric-select' },
                    { canvasId: 'kurtosis-chart', selectId: 'kurtosis-type-select' },
                    { canvasId: 'vol-of-vol-chart', selectId: null },
                    { canvasId: 'volume-chart', selectId: 'ticker-search' },
                    { canvasId: 'open-interest-chart', selectId: 'ticker-search' },
                    { canvasId: 'historic-price-chart', selectId: null }
                ];
                chartConfigs.forEach(config => {
                    const canvas = document.getElementById(config.canvasId);
                    const select = config.selectId ? document.getElementById(config.selectId) : null;
                    if (canvas && select) {
                        canvas.addEventListener('keydown', (event) => {
                            if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                                event.preventDefault();
                                let newIndex = select.selectedIndex + (event.key === 'ArrowLeft' ? -1 : 1);
                                if (newIndex < 0) newIndex = select.options.length - 1;
                                if (newIndex >= select.options.length) newIndex = 0;
                                select.selectedIndex = newIndex;
                                select.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        });
                    }
                });
                const expirySelect = document.getElementById('expiry-select');
                if (expirySelect) {
                    expirySelect.addEventListener('change', () => {
                        console.log('Expiry select changed to:', expirySelect.value);
                        updateCharts();
                    });
                }
                const moneynessSelect = document.getElementById('moneyness-select');
                if (moneynessSelect) {
                    moneynessSelect.addEventListener('change', () => {
                        console.log('Moneyness select changed to:', moneynessSelect.value);
                        updateCharts();
                    });
                }
                document.getElementById('historic-start-date').addEventListener('change', updateHistoricChart);
                document.getElementById('historic-end-date').addEventListener('change', updateHistoricChart);
                document.getElementById('realised-start-date').addEventListener('change', updateRealisedVolChart);
                document.getElementById('realised-end-date').addEventListener('change', updateRealisedVolChart);
                document.getElementById('realised-vol-metric-select').addEventListener('change', updateRealisedVolChart);
                document.getElementById('kurtosis-start-date').addEventListener('change', updateKurtosisChart);
                document.getElementById('kurtosis-end-date').addEventListener('change', updateKurtosisChart);
                document.getElementById('volofvol-start-date').addEventListener('change', updateVolOfVolChart);
                document.getElementById('volofvol-end-date').addEventListener('change', updateVolOfVolChart);
                document.getElementById('term-min-expiry').addEventListener('change', updateExpiryVsIV);
                document.getElementById('term-max-expiry').addEventListener('change', updateExpiryVsIV);
                document.getElementById('skew-min-expiry').addEventListener('change', updateSkewVsExpiry);
                document.getElementById('skew-max-expiry').addEventListener('change', updateSkewVsExpiry);
                document.getElementById('skew-metric-select').addEventListener('change', updateSkewVsExpiry);
                document.getElementById('kurtosis-type-select').addEventListener('change', updateKurtosisChart);
            } catch (error) {
                console.error('Error adding keyboard navigation:', error);
                document.getElementById('historic-error').textContent = `Error setting up keyboard navigation: ${error.message}`;
                document.getElementById('historic-error').style.display = 'block';
            }
        }
        
        function updateTimeOptions(selectedDate, dates) {
            try {
                const timeSelect = document.getElementById('time-select');
                timeSelect.innerHTML = '';
                const formattedSelectedDate = selectedDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
                const availableTimes = dates
                    .filter(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$1-$2-$3') === formattedSelectedDate)
                    .map(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$4:$5'))
                    .sort();
                const uniqueTimes = [...new Set(availableTimes)];
                uniqueTimes.forEach(timePart => {
                    const option = document.createElement('option');
                    option.value = timePart.replace(':', '');
                    option.textContent = timePart;
                    timeSelect.appendChild(option);
                });
                if (timeSelect.options.length > 0) {
                    timeSelect.value = timeSelect.options[0].value;
                    timeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                } else {
                    console.warn('No times available for selected date:', formattedSelectedDate);
                    document.getElementById('historic-error').textContent = 'No times available for selected date';
                    document.getElementById('historic-error').style.display = 'block';
                }
                console.log('Time options updated:', uniqueTimes);
            } catch (error) {
                console.error('Error updating time options:', error);
                document.getElementById('historic-error').textContent = `Error updating time options: ${error.message}`;
                document.getElementById('historic-error').style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
    try {
        // Check required libraries
        if (typeof Chart === 'undefined' || typeof Plotly === 'undefined' || typeof Papa === 'undefined' || typeof XLSX === 'undefined') {
            console.error('Required libraries (Chart.js, Plotly, PapaParse, or SheetJS) not loaded');
            document.getElementById('historic-error').textContent = 'Failed to load required libraries';
            document.getElementById('historic-error').style.display = 'block';
            return;
        }

        // Initialize sliders
        const moneynessSlider = document.getElementById('moneyness-slider');
        const expiryTSlider = document.getElementById('expiry-t-slider');
		noUiSlider.create(moneynessSlider, {
		    start: [0.5, 2.5],
		    connect: true,
		    range: { min: 0, max: 3 },
		    step: 0.05
		});
		noUiSlider.create(expiryTSlider, {
		    start: [0.25, 5],
		    connect: true,
		    range: { min: 0, max: 5 },
		    step: 0.05
		});
		moneynessSlider.noUiSlider.on('update', (values) => {
		    document.getElementById('moneyness-value').textContent = `${parseFloat(values[0]).toFixed(1)} - ${parseFloat(values[1]).toFixed(1)}`;
		    updateCallVolSurface();
		});
		expiryTSlider.noUiSlider.on('update', (values) => {
		    document.getElementById('expiry-t-value').textContent = `${parseFloat(values[0]).toFixed(1)} - ${parseFloat(values[1]).toFixed(1)}`;
		    updateCallVolSurface();
		});

        // Initialize selectors
        const dateSelect = document.getElementById('date-select');
        const timeSelect = document.getElementById('time-select');
        const tickerSearch = document.getElementById('ticker-search');

        // Validate timestamp
        const validateTimestamp = async (timestamp) => {
            const prefix = '_yfinance';
            try {
                const response = await fetch(`data/${timestamp}/tables/ranking/ranking_table${prefix}.csv?v=${Date.now()}`, { method: 'HEAD' });
                return response.ok ? timestamp : null;
            } catch {
                return null;
            }
        };

        // Get latest valid timestamp
        const getLatestValidTimestamp = async (dates) => {
            const timestamps = dates.sort((a, b) => b.localeCompare(a));
            for (const ts of timestamps) {
                if (await validateTimestamp(ts)) return ts;
            }
            console.warn('No valid timestamps found, using fallback');
            return '20250827_2136';
        };

        // Ensure sidebar sub-menus are hidden initially
        document.querySelectorAll('.sub-menu').forEach(menu => {
            menu.classList.add('hidden');
            menu.classList.remove('active');
        });

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);

        // Fetch dates and initialize
        fetch('data/dates.json?v=' + Date.now())
            .then(response => {
                if (!response.ok) throw new Error('Failed to load dates.json');
                return response.json();
            })
            .then(async dates => {
                // Populate date dropdown
                const uniqueDates = [...new Set(dates.map(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$1-$2-$3')))].sort((a, b) => b.localeCompare(a));
                dateSelect.innerHTML = '';
                uniqueDates.forEach(datePart => {
                    const option = document.createElement('option');
                    option.value = datePart.replace(/-/g, '');
                    option.textContent = datePart;
                    dateSelect.appendChild(option);
                });

                // Load initial data
                const loadInitialData = async () => {
                    let timestamp = await getLatestValidTimestamp(dates);
                    if (dateSelect.options.length > 0) {
                        dateSelect.value = timestamp.slice(0, 8);
                        await updateTimeOptions(dateSelect.value, dates);
                        timestamp = dateSelect.value + '_' + (timeSelect.options.length > 0 ? timeSelect.value : '2136');
                    }
                    // Set default ticker in ticker-search input
                    const defaultTicker = 'COIN';
                    tickerSearch.value = defaultTicker;
                    document.getElementById('ticker-display').textContent = defaultTicker;
                    console.log('Initializing with default ticker:', defaultTicker);
                    console.log('Loading initial data with timestamp:', timestamp);
                    await loadData(timestamp);
                    await loadWisesheetsData();
                    updateDropdowns();
                    // Set initial section to Volatility > Overview
                    document.querySelector('#volatility-link').classList.add('active');
                    document.querySelector('#volatility-sub-menu').classList.add('active');
                    document.querySelector('#volatility-sub-menu').classList.remove('hidden');
                    document.querySelector('a[href="#volatility-overview"]').classList.add('active');
                    updateSection('volatility', 'volatility-overview');
                    console.log('Initial data and Volatility > Overview loaded for timestamp:', timestamp);
                };
                await loadInitialData();

                // Date change handler
                dateSelect.addEventListener('change', async (e) => {
                    console.log('Date select changed to:', e.target.value);
                    await updateTimeOptions(e.target.value, dates);
                    const timestamp = e.target.value + '_' + (timeSelect.options.length > 0 ? timeSelect.value : '2136');
                    if (await validateTimestamp(timestamp)) {
                        await loadData(timestamp);
                        await loadWisesheetsData();
                        updateDropdowns();
                        const currentSection = document.querySelector('.overview-grid[style*="grid"], .volatility-grid[style*="grid"], .volatility-surface-grid[style*="grid"], .trading-economics-grid[style*="grid"], .chart-container[style*="block"]');
                        const sectionId = currentSection ? currentSection.id : 'volatility';
                        const subSectionId = currentSection ? document.querySelector(`#${sectionId} > div[style*="block"], #${sectionId} > div[style*="grid"]`)?.id : 'volatility-overview';
                        updateSection(sectionId, subSectionId);
                        console.log('Updated section after date change:', sectionId, subSectionId);
                    } else {
                        console.warn('Invalid timestamp:', timestamp);
                        document.getElementById('historic-error').textContent = 'Invalid date selected';
                        document.getElementById('historic-error').style.display = 'block';
                    }
                });

                // Time change handler
                timeSelect.addEventListener('change', async (e) => {
                    console.log('Time select changed to:', e.target.value);
                    const timestamp = dateSelect.value + '_' + e.target.value;
                    if (await validateTimestamp(timestamp)) {
                        await loadData(timestamp);
                        await loadWisesheetsData();
                        updateDropdowns();
                        const currentSection = document.querySelector('.overview-grid[style*="grid"], .volatility-grid[style*="grid"], .volatility-surface-grid[style*="grid"], .trading-economics-grid[style*="grid"], .chart-container[style*="block"]');
                        const sectionId = currentSection ? currentSection.id : 'volatility';
                        const subSectionId = currentSection ? document.querySelector(`#${sectionId} > div[style*="block"], #${sectionId} > div[style*="grid"]`)?.id : 'volatility-overview';
                        updateSection(sectionId, subSectionId);
                        console.log('Updated section after time change:', sectionId, subSectionId);
                    } else {
                        console.warn('Invalid timestamp:', timestamp);
                        document.getElementById('historic-error').textContent = 'Invalid time selected';
                        document.getElementById('historic-error').style.display = 'block';
                    }
                });

                // Ticker change handler
                tickerSearch.addEventListener('input', debounce(async () => {
                    console.log('Ticker changed to:', tickerSearch.value);
                    document.getElementById('ticker-display').textContent = `${tickerSearch.value.toUpperCase() || 'N/A'}`;
                    const timestamp = dateSelect.value + '_' + (timeSelect.options.length > 0 ? timeSelect.value : '2136');
                    if (await validateTimestamp(timestamp)) {
                        await loadData(timestamp);
                        await loadWisesheetsData();
                        updateDropdowns();
                        const currentSection = document.querySelector('.overview-grid[style*="grid"], .volatility-grid[style*="grid"], .volatility-surface-grid[style*="grid"], .trading-economics-grid[style*="grid"], .chart-container[style*="block"]');
                        const sectionId = currentSection ? currentSection.id : 'volatility';
                        const subSectionId = currentSection ? document.querySelector(`#${sectionId} > div[style*="block"], #${sectionId} > div[style*="grid"]`)?.id : 'volatility-overview';
                        updateSection(sectionId, subSectionId);
                        console.log('Updated section after ticker change:', sectionId, subSectionId);
                    } else {
                        console.warn('Invalid timestamp:', timestamp);
                        document.getElementById('historic-error').textContent = 'Invalid data timestamp';
                        document.getElementById('historic-error').style.display = 'block';
                    }
                }, 500));

                // Wisesheets ticker selection handler
                document.getElementById('wisesheets-ticker-select').addEventListener('change', () => {
                    wisesheetsSelectedTickers = Array.from(document.getElementById('wisesheets-ticker-select').selectedOptions).map(opt => opt.value);
                    console.log('Wisesheets ticker selection changed:', wisesheetsSelectedTickers);
                    if (indicesChartVisible) updateIndicesChart();
                    updateIndicesTable();
                });

                // Wisesheets date range handlers
                document.getElementById('wisesheets-start-date').addEventListener('change', () => {
                    console.log('Wisesheets start date changed:', document.getElementById('wisesheets-start-date').value);
                    updateIndicesChart();
                    updateIndicesTable();
                });
                document.getElementById('wisesheets-end-date').addEventListener('change', () => {
                    console.log('Wisesheets end date changed:', document.getElementById('wisesheets-end-date').value);
                    updateIndicesChart();
                    updateIndicesTable();
                });

                // Historic chart type handler
                document.getElementById('historic-chart-type').addEventListener('change', () => {
                    console.log('Chart type changed to:', document.getElementById('historic-chart-type').value);
                    updateHistoricChart();
                });

                // Main section navigation
                document.querySelectorAll('.sidebar a:not(.sub-tab)').forEach(link => {
                    link.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const targetId = link.getAttribute('href').substring(1);
                        const subMenu = link.nextElementSibling?.classList.contains('sub-menu') ? link.nextElementSibling : null;
                        document.querySelectorAll('.sidebar a:not(.sub-tab)').forEach(l => l.classList.remove('active'));
                        document.querySelectorAll('.sub-menu').forEach(menu => {
                            menu.classList.remove('active');
                            menu.classList.add('hidden');
                        });
                        document.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
                        link.classList.add('active');
                        if (subMenu) {
                            subMenu.classList.add('active');
                            subMenu.classList.remove('hidden');
                            let defaultSub = document.querySelector(`#${subMenu.id} .sub-tab:first-child`);
                            defaultSub.classList.add('active');
                            defaultSub.click();
                        } else {
                            updateSection(targetId);
                        }
                    });
                });

                // Sub-section navigation
                document.querySelectorAll('.sub-tab').forEach(subTab => {
                    subTab.addEventListener('click', async (e) => {
                        e.preventDefault();
                        document.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
                        subTab.classList.add('active');
                        const targetSubId = subTab.getAttribute('href').substring(1);
                        const mainSection = subTab.closest('.sub-menu').previousElementSibling.getAttribute('href').substring(1);
                        const timestamp = dateSelect.value + '_' + (timeSelect.options.length > 0 ? timeSelect.value : '2136');
                        if (await validateTimestamp(timestamp)) {
                            await loadData(timestamp);
                            await loadWisesheetsData();
                            updateDropdowns();
                            updateSection(mainSection, targetSubId);
                        } else {
                            console.warn('Invalid timestamp:', timestamp);
                            document.getElementById('historic-error').textContent = 'Invalid data timestamp';
                            document.getElementById('historic-error').style.display = 'block';
                        }
                    });
                });

                // Ticker compare handler
                document.getElementById('ticker-compare-select').addEventListener('change', () => {
                    console.log('Ticker compare select changed to:', Array.from(document.getElementById('ticker-compare-select').selectedOptions).map(opt => opt.value));
                    updateNormalizedTable();
                });

                // Set initial visibility
                document.getElementById('volatility').style.display = 'grid';
                document.getElementById('macro').style.display = 'none';
                document.getElementById('indices').style.display = 'none';
                document.getElementById('volatility-surface').style.display = 'none';
                document.getElementById('volatility-overview').style.display = 'grid';
                console.log('Initial load: Showing Volatility > Overview');
                addKeyboardNavigation();
            })
            .catch(error => {
                console.error('Error in DOMContentLoaded:', error);
                document.getElementById('historic-error').textContent = `Error initializing page: ${error.message}`;
                document.getElementById('historic-error').style.display = 'block';
            });
    } catch (error) {
        console.error('Error in DOMContentLoaded:', error);
        document.getElementById('historic-error').textContent = `Error initializing page: ${error.message}`;
        document.getElementById('historic-error').style.display = 'block';
    }
});
    </script>
</body>
</html>
