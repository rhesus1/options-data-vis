<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ticker Ranking</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1C2526;
            color: #FFFFFF;
            margin: 0;
            padding: 20px;
        }
        .data-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        .data-table th, .data-table td {
            border: 1px solid #FFFFFF;
            padding: 12px;
            text-align: left;
            color: #FFFFFF;
        }
        .data-table th {
            background-color: #2E3537;
            cursor: pointer;
        }
        .data-table th:hover {
            background-color: #3E4547;
        }
        .nav-link {
            color: #00BFFF;
            text-decoration: none;
            padding: 5px;
            display: inline-block;
        }
        .nav-link:hover {
            text-decoration: underline;
        }
        .sort-indicator::after {
            content: '';
            display: inline-block;
            margin-left: 5px;
        }
        .sort-asc::after {
            content: ' ▲';
        }
        .sort-desc::after {
            content: ' ▼';
        }
        select {
            padding: 5px;
            background-color: #2E3537;
            color: #FFFFFF;
            border: 1px solid #FFFFFF;
            border-radius: 4px;
        }
        .controls-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div>
        <a href="index.html" class="nav-link">Back to Main Dashboard</a>
        <a href="vol-surfaces.html" class="nav-link">View Volatility Surfaces</a>
    </div>
    <div class="controls-container">
        <label for="source-select">Select Data Source: </label>
        <select id="source-select">
            <option value="nasdaq">Nasdaq</option>
            <option value="yfinance" selected>yfinance</option>
        </select>
        <label for="date-select">Select Date: </label>
        <select id="date-select"></select>
        <label for="time-select">Select Time: </label>
        <select id="time-select"></select>
    </div>
    <table id="data-table" class="data-table">
        <thead>
            <tr>
                <th data-sort="order">Rank</th>
                <th data-sort="ticker">Ticker</th>
                <th data-sort="latestClose">Latest Close ($)</th>
                <th data-sort="latestHigh">Latest High ($)</th>
                <th data-sort="latestLow">Latest Low ($)</th>
                <th data-sort="close1d">Close 1d (%)</th>
                <th data-sort="close1w">Close 1w (%)</th>
                <th data-sort="high1d">High 1d (%)</th>
                <th data-sort="high1w">High 1w (%)</th>
                <th data-sort="low1d">Low 1d (%)</th>
                <th data-sort="low1w">Low 1w (%)</th>
                <th data-sort="realisedVolClose30">Rvol Close 30d (%)</th>
                <th data-sort="realisedVolClose60">Rvol Close 60d (%)</th>
                <th data-sort="realisedVolClose100">Rvol Close 100d (%)</th>
                <th data-sort="realisedVolClose100_1d">Rvol Close 100d 1d (%)</th>
                <th data-sort="realisedVolClose100_1w">Rvol Close 100d 1w (%)</th>
                <th data-sort="minRealisedVolClose100">Min Rvol Close 100d (1y)</th>
                <th data-sort="maxRealisedVolClose100">Max Rvol Close 100d (1y)</th>
                <th data-sort="meanRealisedVolClose100">Mean Rvol Close 100d (1y)</th>
                <th data-sort="rvolClose100Percentile">Rvol Close 100d Percentile (%)</th>
                <th data-sort="rvolClose100ZScorePercentile">Rvol Close 100d Z-Score Percentile (%)</th>
                <th data-sort="realisedVolClose180">Rvol Close 180d (%)</th>
                <th data-sort="realisedVolClose252">Rvol Close 252d (%)</th>
                <th data-sort="weightedIV">Weighted IV (%)</th>
                <th data-sort="weightedIV_1d">Weighted IV 1d (%)</th>
                <th data-sort="weightedIV_1w">Weighted IV 1w (%)</th>
                <th data-sort="rvolClose100dMinusWeightedIV">Rvol Close 100d - Weighted IV</th>
                <th data-sort="volume">Volume</th>
                <th data-sort="vol1d">Vol 1d (%)</th>
                <th data-sort="vol1w">Vol 1w (%)</th>
                <th data-sort="openInterest">Open Interest</th>
                <th data-sort="oi1d">OI 1d (%)</th>
                <th data-sort="oi1w">OI 1w (%)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
        let rankingData = [];
        let currentSort = { column: 'openInterest', direction: 'desc' };
        function parseCSV(csvText) {
            try {
                const result = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true
                });
                console.log('Parsed CSV data types:', result.data.map(item => ({
                    ticker: typeof item.Ticker,
                    openInterest: { raw: item['Open Interest'], type: typeof item['Open Interest'] },
                    volume: { raw: item['Volume'], type: typeof item['Volume'] },
                    weightedIV: typeof item['Weighted IV (%)'],
                    rvolClose100Percentile: typeof item['Rvol Close 100d Percentile (%)'],
                    rvolClose100ZScorePercentile: typeof item['Rvol Close 100d Z-Score Percentile (%)']
                })));
                return result.data;
            } catch (error) {
                console.error('Error parsing CSV:', error);
                return [];
            }
        }
        function formatNumberWithCommas(number) {
            const num = Number(number);
            if (isNaN(num) || number === null || number === undefined || number === 'N/A') {
                return '0';
            }
            return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        function normalizeDate(dateStr) {
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) throw new Error('Invalid date');
                return date.toLocaleDateString('en-CA');
            } catch (error) {
                console.error('Error normalizing date:', dateStr, error);
                return null;
            }
        }
        function updateTimeOptions(selectedDate, dates) {
            try {
                const timeSelect = document.getElementById('time-select');
                timeSelect.innerHTML = '';
                const formattedSelectedDate = selectedDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
                const availableTimes = dates
                    .filter(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$1-$2-$3') === formattedSelectedDate)
                    .map(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$4:$5'));
                const uniqueTimes = [...new Set(availableTimes)];
                uniqueTimes.forEach(timePart => {
                    const option = document.createElement('option');
                    option.value = timePart.replace(':', '');
                    option.textContent = timePart;
                    timeSelect.appendChild(option);
                });
                if (timeSelect.options.length > 0) timeSelect.value = timeSelect.options[0].value;
                console.log('Time options updated:', uniqueTimes);
            } catch (error) {
                console.error('Error updating time options:', error);
            }
        }
        function loadData(timestamp) {
            try {
                const source = document.getElementById('source-select').value;
                const prefix = source === 'yfinance' ? 'yfinance_' : '';
                console.log(`Loading data for timestamp: ${timestamp}, source: ${source}`);
                fetch(`data/ranking_${prefix}${timestamp}.csv?v=` + Date.now())
                    .then(response => response.text())
                    .then(csvText => {
                        rankingData = parseCSV(csvText);
                        console.log(`Ranking ${source} data loaded:`, rankingData);
                        updateTable();
                    })
                    .catch(error => console.error(`Error loading ranking ${source} data:`, error));
            } catch (error) {
                console.error('Error in loadData:', error);
            }
        }
        function updateTable() {
            try {
                const tbody = document.querySelector('#data-table tbody');
                tbody.innerHTML = '';
                const tableData = rankingData.map((item, index) => {
                    const ticker = item.Ticker;
                    const openInterestRaw = item['Open Interest'];
                    const volumeRaw = item['Volume'];
                    console.log(`Formatting for ${ticker}: Open Interest = ${openInterestRaw} (${typeof openInterestRaw}), Volume = ${volumeRaw} (${typeof volumeRaw})`);
                    return {
                        order: index + 1,
                        ticker,
                        openInterest: Number.isFinite(openInterestRaw) ? Number(openInterestRaw) : 0,
                        oi1d: Number.isFinite(item['OI 1d (%)']) ? Number(item['OI 1d (%)']).toFixed(2) : 'N/A',
                        oi1w: Number.isFinite(item['OI 1w (%)']) ? Number(item['OI 1w (%)']).toFixed(2) : 'N/A',
                        volume: Number.isFinite(volumeRaw) ? Number(volumeRaw) : 0,
                        vol1d: Number.isFinite(item['Volume 1d (%)']) ? Number(item['Volume 1d (%)']).toFixed(2) : 'N/A',
                        vol1w: Number.isFinite(item['Volume 1w (%)']) ? Number(item['Volume 1w (%)']).toFixed(2) : 'N/A',
                        latestClose: Number.isFinite(item['Latest Close']) ? Number(item['Latest Close']).toFixed(2) : 'N/A',
                        latestHigh: Number.isFinite(item['Latest High']) ? Number(item['Latest High']).toFixed(2) : 'N/A',
                        latestLow: Number.isFinite(item['Latest Low']) ? Number(item['Latest Low']).toFixed(2) : 'N/A',
                        close1d: Number.isFinite(item['Close 1d (%)']) ? Number(item['Close 1d (%)']).toFixed(2) : 'N/A',
                        close1w: Number.isFinite(item['Close 1w (%)']) ? Number(item['Close 1w (%)']).toFixed(2) : 'N/A',
                        high1d: Number.isFinite(item['High 1d (%)']) ? Number(item['High 1d (%)']).toFixed(2) : 'N/A',
                        high1w: Number.isFinite(item['High 1w (%)']) ? Number(item['High 1w (%)']).toFixed(2) : 'N/A',
                        low1d: Number.isFinite(item['Low 1d (%)']) ? Number(item['Low 1d (%)']).toFixed(2) : 'N/A',
                        low1w: Number.isFinite(item['Low 1w (%)']) ? Number(item['Low 1w (%)']).toFixed(2) : 'N/A',
                        realisedVolClose30: Number.isFinite(item['Realised Volatility Close 30d (%)']) ? Number(item['Realised Volatility Close 30d (%)']).toFixed(2) : 'N/A',
                        realisedVolClose60: Number.isFinite(item['Realised Volatility Close 60d (%)']) ? Number(item['Realised Volatility Close 60d (%)']).toFixed(2) : 'N/A',
                        realisedVolClose100: Number.isFinite(item['Realised Volatility Close 100d (%)']) ? Number(item['Realised Volatility Close 100d (%)']).toFixed(2) : 'N/A',
                        realisedVolClose100_1d: Number.isFinite(item['Realised Volatility Close 100d 1d (%)']) ? Number(item['Realised Volatility Close 100d 1d (%)']).toFixed(2) : 'N/A',
                        realisedVolClose100_1w: Number.isFinite(item['Realised Volatility Close 100d 1w (%)']) ? Number(item['Realised Volatility Close 100d 1w (%)']).toFixed(2) : 'N/A',
                        minRealisedVolClose100: Number.isFinite(item['Min Realised Volatility Close 100d (1y)']) ? Number(item['Min Realised Volatility Close 100d (1y)']).toFixed(2) : 'N/A',
                        maxRealisedVolClose100: Number.isFinite(item['Max Realised Volatility Close 100d (1y)']) ? Number(item['Max Realised Volatility Close 100d (1y)']).toFixed(2) : 'N/A',
                        meanRealisedVolClose100: Number.isFinite(item['Mean Realised Volatility Close 100d (1y)']) ? Number(item['Mean Realised Volatility Close 100d (1y)']).toFixed(2) : 'N/A',
                        rvolClose100Percentile: Number.isFinite(item['Rvol Close 100d Percentile (%)']) ? Number(item['Rvol Close 100d Percentile (%)']).toFixed(2) : 'N/A',
                        rvolClose100ZScorePercentile: Number.isFinite(item['Rvol Close 100d Z-Score Percentile (%)']) ? Number(item['Rvol Close 100d Z-Score Percentile (%)']).toFixed(2) : 'N/A',
                        realisedVolClose180: Number.isFinite(item['Realised Volatility Close 180d (%)']) ? Number(item['Realised Volatility Close 180d (%)']).toFixed(2) : 'N/A',
                        realisedVolClose252: Number.isFinite(item['Realised Volatility Close 252d (%)']) ? Number(item['Realised Volatility Close 252d (%)']).toFixed(2) : 'N/A',
                        weightedIV: Number.isFinite(item['Weighted IV (%)']) ? Number(item['Weighted IV (%)']).toFixed(2) : 'N/A',
                        weightedIV_1d: Number.isFinite(item['Weighted IV 1d (%)']) ? Number(item['Weighted IV 1d (%)']).toFixed(2) : 'N/A',
                        weightedIV_1w: Number.isFinite(item['Weighted IV 1w (%)']) ? Number(item['Weighted IV 1w (%)']).toFixed(2) : 'N/A',
                        rvolClose100dMinusWeightedIV: Number.isFinite(item['Rvol Close 100d - Weighted IV']) ? Number(item['Rvol Close 100d - Weighted IV']).toFixed(2) : 'N/A'
                    };
                });
                tableData.sort((a, b) => {
                    let valA = a[currentSort.column];
                    let valB = b[currentSort.column];
                    if (['openInterest', 'volume', 'realisedVolClose30', 'realisedVolClose60', 'realisedVolClose100', 'realisedVolClose100_1d', 'realisedVolClose100_1w', 'minRealisedVolClose100', 'maxRealisedVolClose100', 'meanRealisedVolClose100', 'rvolClose100Percentile', 'rvolClose100ZScorePercentile', 'realisedVolClose180', 'realisedVolClose252', 'latestClose', 'latestHigh', 'latestLow', 'close1d', 'close1w', 'high1d', 'high1w', 'low1d', 'low1w', 'oi1d', 'oi1w', 'vol1d', 'vol1w', 'weightedIV', 'weightedIV_1d', 'weightedIV_1w', 'rvolClose100dMinusWeightedIV'].includes(currentSort.column)) {
                        valA = valA === 'N/A' || valA === undefined || isNaN(valA) ? -Infinity : parseFloat(valA);
                        valB = valB === 'N/A' || valB === undefined || isNaN(valB) ? -Infinity : parseFloat(valB);
                    } else if (currentSort.column === 'ticker') {
                        valA = valA ? String(valA).toLowerCase() : '';
                        valB = valB ? String(valB).toLowerCase() : '';
                    } else if (currentSort.column === 'order') {
                        valA = parseInt(valA);
                        valB = parseInt(valB);
                    }
                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                tableData.forEach((item, index) => {
                    item.order = index + 1;
                });
                tableData.forEach(item => {
                    const row = document.createElement('tr');
                    ['order', 'ticker', 'latestClose', 'latestHigh', 'latestLow', 'close1d', 'close1w', 'high1d', 'high1w', 'low1d', 'low1w', 'realisedVolClose30', 'realisedVolClose60', 'realisedVolClose100', 'realisedVolClose100_1d', 'realisedVolClose100_1w', 'minRealisedVolClose100', 'maxRealisedVolClose100', 'meanRealisedVolClose100', 'rvolClose100Percentile', 'rvolClose100ZScorePercentile', 'realisedVolClose180', 'realisedVolClose252', 'weightedIV', 'weightedIV_1d', 'weightedIV_1w', 'rvolClose100dMinusWeightedIV', 'volume', 'vol1d', 'vol1w', 'openInterest', 'oi1d', 'oi1w'].forEach(key => {
                        const cell = document.createElement('td');
                        if (key === 'openInterest' || key === 'volume') {
                            cell.textContent = formatNumberWithCommas(item[key]);
                        } else {
                            cell.textContent = item[key];
                        }
                        row.appendChild(cell);
                    });
                    tbody.appendChild(row);
                });
                console.log('Table updated with sorted data:', tableData);
            } catch (error) {
                console.error('Error updating table:', error);
            }
        }
        function setupSortListeners() {
            try {
                const headers = document.querySelectorAll('#data-table th[data-sort]');
                headers.forEach(header => {
                    const column = header.getAttribute('data-sort');
                    if (column === currentSort.column) {
                        header.classList.add(`sort-${currentSort.direction}`);
                    }
                    header.addEventListener('click', () => {
                        if (currentSort.column === column) {
                            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSort.column = column;
                            currentSort.direction = 'desc';
                        }
                        headers.forEach(h => {
                            h.classList.remove('sort-asc', 'sort-desc');
                            if (h.getAttribute('data-sort') === currentSort.column) {
                                h.classList.add(`sort-${currentSort.direction}`);
                            }
                        });
                        updateTable();
                    });
                });
            } catch (error) {
                console.error('Error setting up sort listeners:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const dateSelect = document.getElementById('date-select');
                const timeSelect = document.getElementById('time-select');
                const sourceSelect = document.getElementById('source-select');
                fetch('data/dates.json?v=' + Date.now())
                    .then(response => response.text())
                    .then(data => {
                        const dates = JSON.parse(data);
                        const uniqueDates = [...new Set(dates.map(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$1-$2-$3')))];
                        uniqueDates.forEach(datePart => {
                            const option = document.createElement('option');
                            option.value = datePart.replace(/-/g, '');
                            option.textContent = datePart;
                            dateSelect.appendChild(option);
                        });
                        if (dateSelect.options.length > 0) {
                            dateSelect.value = dateSelect.options[0].value;
                            updateTimeOptions(dateSelect.value, dates);
                            loadData(dateSelect.value + '_' + timeSelect.value);
                        }
                        dateSelect.addEventListener('change', (e) => {
                            updateTimeOptions(e.target.value, dates);
                            loadData(e.target.value + '_' + e.target.value);
                        });
                        timeSelect.addEventListener('change', (e) => {
                            loadData(dateSelect.value + '_' + e.target.value);
                        });
                        sourceSelect.addEventListener('change', () => {
                            console.log('Data source changed to:', sourceSelect.value);
                            loadData(dateSelect.value + '_' + timeSelect.value);
                        });
                    })
                    .catch(error => console.error('Error loading dates:', error));
                setupSortListeners();
            } catch (error) {
                console.error('Error in DOMContentLoaded:', error);
            }
        });
    </script>
</body>
</html>
