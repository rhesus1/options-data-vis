<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Options Data Table</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1C2526;
            color: #FFFFFF;
            margin: 20px;
        }
        .date-time-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        select, input {
            margin: 10px;
            padding: 5px;
            background-color: #2E3537;
            color: #FFFFFF;
            border: 1px solid #FFFFFF;
            border-radius: 4px;
        }
        table.dataTable {
            width: 100%;
            background-color: #1C2526;
            color: #FFFFFF;
        }
        table.dataTable thead th {
            background-color: #2E3537;
            border: 1px solid #FFFFFF;
        }
        table.dataTable tbody td {
            border: 1px solid #FFFFFF;
        }
        .dataTables_wrapper .dataTables_filter input {
            background-color: #2E3537;
            color: #FFFFFF;
            border: 1px solid #FFFFFF;
        }
        .dataTables_wrapper .dataTables_length select {
            background-color: #2E3537;
            color: #FFFFFF;
            border: 1px solid #FFFFFF;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            background-color: #2E3537;
            color: #FFFFFF !important;
            border: 1px solid #FFFFFF;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: #3E4547;
        }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .nav-link {
            margin: 10px;
            color: #00BFFF;
            text-decoration: none;
        }
        .nav-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>Options Data Table</h1>
    <div><a href="options_visualization.html" class="nav-link">Back to Visualisation</a></div>
    <div class="date-time-container">
        <label for="date-select">Select Date: </label>
        <select id="date-select"></select>
        <label for="time-select">Select Time: </label>
        <select id="time-select"></select>
    </div>
    <div class="filter-container">
        <div>
            <label for="ticker-filter">Ticker: </label>
            <select id="ticker-filter"></select>
        </div>
        <div>
            <label for="type-filter">Type: </label>
            <select id="type-filter">
                <option value="">All</option>
                <option value="Call">Call</option>
                <option value="Put">Put</option>
            </select>
        </div>
        <div>
            <label for="expiry-filter">Expiry: </label>
            <select id="expiry-filter"></select>
        </div>
        <div>
            <label for="strike-filter">Strike: </label>
            <input type="number" id="strike-filter" placeholder="Enter strike...">
        </div>
        <div>
            <label for="delta-filter">Delta: </label>
            <input type="number" id="delta-filter" step="0.01" placeholder="Enter delta...">
        </div>
    </div>
    <table id="data-table" class="display">
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Type</th>
                <th>Strike</th>
                <th>Expiry</th>
                <th>Delta</th>
                <th>IV_mid</th>
                <th>Call Local Vol</th>
                <th>Put Local Vol</th>
                <th>Realised Vol 100d</th>
                <th>Moneyness</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
        let data = [];
        function parseCSV(csvText) {
            const result = Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true
            });
            return result.data;
        }
        function normalizeDate(dateStr) {
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) throw new Error('Invalid date');
                return date.toLocaleDateString('en-CA');
            } catch (e) {
                console.error('Error normalizing date:', dateStr, e);
                return null;
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const dateSelect = document.getElementById('date-select');
            const timeSelect = document.getElementById('time-select');
            fetch('data/dates.json?v=' + Date.now())
                .then(response => response.json())
                .then(dates => {
                    const uniqueDates = [...new Set(dates.map(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$1-$2-$3')))];
                    uniqueDates.forEach(datePart => {
                        const option = document.createElement('option');
                        option.value = datePart.replace(/-/g, '');
                        option.textContent = datePart;
                        dateSelect.appendChild(option);
                    });
                    if (dateSelect.options.length > 0) {
                        dateSelect.value = dateSelect.options[0].value;
                        updateTimeOptions(dateSelect.value, dates);
                        loadData(dateSelect.value + '_' + timeSelect.value);
                    }
                    dateSelect.addEventListener('change', (e) => {
                        updateTimeOptions(e.target.value, dates);
                        loadData(e.target.value + '_' + timeSelect.value);
                    });
                    timeSelect.addEventListener('change', (e) => {
                        loadData(dateSelect.value + '_' + e.target.value);
                    });
                })
                .catch(error => console.error('Error loading dates:', error));
        });
        function updateTimeOptions(selectedDate, dates) {
            const timeSelect = document.getElementById('time-select');
            timeSelect.innerHTML = '';
            const formattedSelectedDate = selectedDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
            const availableTimes = dates
                .filter(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$1-$2-$3') === formattedSelectedDate)
                .map(date => date.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})/, '$4:$5'));
            const uniqueTimes = [...new Set(availableTimes)];
            uniqueTimes.forEach(timePart => {
                const option = document.createElement('option');
                option.value = timePart.replace(':', '');
                option.textContent = timePart;
                timeSelect.appendChild(option);
            });
            if (timeSelect.options.length > 0) timeSelect.value = timeSelect.options[0].value;
        }
        function loadData(timestamp) {
            console.log('Loading data for timestamp:', timestamp);
            fetch(`data/processed_${timestamp}.csv?v=` + Date.now())
                .then(response => response.text())
                .then(csvText => {
                    data = parseCSV(csvText);
                    console.log('Processed data loaded:', data);
                    initializeTable();
                    populateFilters();
                })
                .catch(error => console.error('Error loading processed data:', error));
        }
        function populateFilters() {
            const tickerFilter = document.getElementById('ticker-filter');
            const expiryFilter = document.getElementById('expiry-filter');
            tickerFilter.innerHTML = '<option value="">All</option>';
            const uniqueTickers = [...new Set(data.map(item => item.Ticker))].filter(val => val).sort();
            uniqueTickers.forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.textContent = val;
                tickerFilter.appendChild(option);
            });
            if (uniqueTickers.includes('COIN')) {
                tickerFilter.value = 'COIN';
            }
            expiryFilter.innerHTML = '<option value="">All</option>';
            const uniqueExpiries = [...new Set(data.map(item => item.Expiry))].filter(val => val).sort((a, b) => new Date(a) - new Date(b));
            uniqueExpiries.forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.textContent = new Date(val).toLocaleDateString('en-GB');
                expiryFilter.appendChild(option);
            });
            tickerFilter.addEventListener('change', () => $('#data-table').DataTable().draw());
            document.getElementById('type-filter').addEventListener('change', () => $('#data-table').DataTable().draw());
            expiryFilter.addEventListener('change', () => $('#data-table').DataTable().draw());
            document.getElementById('strike-filter').addEventListener('input', () => $('#data-table').DataTable().draw());
            document.getElementById('delta-filter').addEventListener('input', () => $('#data-table').DataTable().draw());
        }
        function initializeTable() {
            $('#data-table').DataTable({
                data: data,
                columns: [
                    { data: 'Ticker' },
                    { data: 'Type' },
                    { data: 'Strike', render: data => Number.isFinite(data) ? data.toFixed(2) : 'N/A' },
                    { data: 'Expiry', render: data => data ? new Date(data).toLocaleDateString('en-GB') : 'N/A' },
                    { data: 'Delta', render: data => Number.isFinite(data) ? data.toFixed(4) : 'N/A' },
                    { data: 'IV_mid', render: data => Number.isFinite(data) ? (data * 100).toFixed(2) : 'N/A' },
                    { data: 'Call Local Vol', render: data => Number.isFinite(data) ? (data * 100).toFixed(2) : 'N/A' },
                    { data: 'Put Local Vol', render: data => Number.isFinite(data) ? (data * 100).toFixed(2) : 'N/A' },
                    { data: 'Realised Vol 100d', render: data => Number.isFinite(data) ? (data * 100).toFixed(2) : 'N/A' },
                    { data: 'Moneyness', render: data => Number.isFinite(data) ? (data * 100).toFixed(2) : 'N/A' }
                ],
                pageLength: 25,
                order: [[0, 'asc']],
                createdRow: function(row, data, dataIndex) {
                    $(row).find('td').css({
                        'border': '1px solid #FFFFFF',
                        'padding': '8px'
                    });
                },
                initComplete: function() {
                    $.fn.dataTable.ext.search.push(
                        function(settings, data, dataIndex) {
                            const tickerFilter = document.getElementById('ticker-filter').value;
                            const typeFilter = document.getElementById('type-filter').value;
                            const expiryFilter = document.getElementById('expiry-filter').value;
                            const strikeFilter = document.getElementById('strike-filter').value;
                            const deltaFilter = document.getElementById('delta-filter').value;

                            const ticker = data[0] || '';
                            const type = data[1] || '';
                            const expiry = data[3] ? normalizeDate(data[3]) : '';
                            const strike = parseFloat(data[2]);
                            const delta = parseFloat(data[4]);

                            if (tickerFilter && ticker !== tickerFilter) return false;
                            if (typeFilter && type !== typeFilter) return false;
                            if (expiryFilter && normalizeDate(expiryFilter) !== expiry) return false;
                            if (strikeFilter && (isNaN(strike) || Math.abs(strike - parseFloat(strikeFilter)) > 0.01)) return false;
                            if (deltaFilter && (isNaN(delta) || Math.abs(delta - parseFloat(deltaFilter)) > 0.01)) return false;

                            return true;
                        }
                    );
                }
            });
        }
    </script>
</body>
</html>
